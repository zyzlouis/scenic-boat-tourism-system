# 景区游船计时收费系统 - 员工端小程序

## 项目介绍

员工端微信小程序，用于码头工作人员进行扫码核销、发船、收船等操作。

## 技术栈

- **框架**: 微信原生小程序
- **UI组件**: Vant Weapp
- **语言**: JavaScript

## 项目结构

```
client-staff/
├── pages/                  # 页面目录
│   ├── login/             # 登录页
│   ├── scan/              # 扫码核销页
│   ├── search/            # 船号查询页
│   └── orders/            # 待处理订单列表
├── components/            # 自定义组件
├── utils/                 # 工具函数
│   ├── api.js            # API请求封装
│   └── util.js           # 工具函数
├── config/                # 配置文件
├── images/                # 图片资源
├── app.js                 # 小程序入口
├── app.json               # 小程序配置
├── app.wxss               # 全局样式
├── package.json
└── README.md
```

## 功能清单

### 已实现
- ✅ 员工登录（账号密码）
- ✅ 扫码核销（自动识别发船/收船）
- ✅ 发船流程（输入船号、开始计时）
- ✅ 收船流程（账单预览、确认结算）
- ✅ 船号查询（游客手机没电场景）
- ✅ 待处理订单列表（实时监控）

### 待实现（TODO）
- ⏳ 强制结束订单（管理员权限）
- ⏳ 操作记录查询
- ⏳ 数据统计（每日核销数量等）

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 构建npm包

在微信开发者工具中：
- 点击 **工具 -> 构建npm**
- 等待构建完成

### 3. 配置API地址

修改 `app.js` 中的 `baseUrl`：

```javascript
globalData: {
  baseUrl: 'https://your-api-domain.com/api/v1'  // 修改为实际的API地址
}
```

### 4. 配置微信小程序AppID

在微信开发者工具中，点击 **详情 -> 基本信息**，填入你的AppID。

### 5. 运行

在微信开发者工具中点击 **编译** 即可预览。

## 页面说明

### 登录页（login）
- 账号密码登录
- 默认测试账号：`admin / admin123`
- 登录成功后跳转到扫码核销页

### 扫码核销页（scan）- 核心功能
- 点击大按钮调起微信扫码
- 自动识别是发船还是收船操作
- **发船流程**：扫码 → 输入船号 → 开始计时 → 完成
- **收船流程**：扫码 → 显示账单预览 → 确认收船 → 完成
- 包含操作指南和快捷功能入口

### 船号查询页（search）
- 适用于游客手机没电无法出示核销码的场景
- 输入船号查询订单信息
- 确认后可直接完成收船操作

### 待处理订单列表页（orders）
- 显示所有"计时中"的订单
- 实时显示已用时长
- 超时订单醒目提醒
- 点击订单可直接收船

## 核心操作流程

### 发船流程
```
1. 点击"扫码核销"
2. 扫描游客的核销码
3. 系统提示"请输入船号"
4. 输入船号（如：E-001）
5. 点击"确认发船"
6. 系统开始计时，游客可以出发
```

### 收船流程
```
1. 点击"扫码核销"
2. 扫描游客的核销码
3. 系统显示账单预览（时长、费用等）
4. 点击"确认收船"
5. 系统结束计时并自动退款
6. 游客收到退款通知
```

### 特殊场景：手机没电
```
1. 切换到"船号查询"页面
2. 询问游客船号
3. 输入船号并搜索
4. 确认订单信息
5. 点击"确认收船"完成
```

## API对接

所有API请求通过 `utils/api.js` 统一管理，包含：
- 自动添加Token认证
- 统一错误处理
- Token失效自动跳转登录

## 样式规范

- 使用 Vant Weapp 组件库
- 主色调：`#07c160`（绿色，员工端）
- 危险操作：`#ee0a24`（红色）
- 全局样式定义在 `app.wxss`

## 权限说明

### 普通员工
- 扫码核销（发船、收船）
- 船号查询
- 查看待处理订单列表

### 管理员
- 所有员工权限
- 强制结束订单（TODO）
- 查看操作记录（TODO）

## 调试建议

### 1. 本地开发
- 在微信开发者工具中勾选 **不校验合法域名**
- 后端API地址使用本地地址（如 `http://localhost:3000/api/v1`）

### 2. 真机调试
- 需要在微信公众平台配置服务器域名
- 后端API必须使用HTTPS
- 需要申请相机权限（扫码功能）

## 常见问题

### 1. 扫码功能无法使用
- 检查是否授予相机权限
- 真机调试时确保在HTTPS环境

### 2. API请求失败
- 检查 `app.js` 中的 `baseUrl` 是否正确
- 检查后端服务是否已启动
- 检查登录状态（Token是否有效）

### 3. 无法登录
- 确认后端登录接口已实现
- 检查账号密码是否正确
- 查看控制台错误信息

## 测试账号

默认员工账号：
- **管理员**: `admin / admin123`
- **普通员工**: `staff01 / staff123`

## 许可证

ISC
