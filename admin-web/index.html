<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¿ å±æ¹–æ™¯åŒºæ¸¸èˆ¹ç®¡ç†åå°</title>
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://cdn.staticfile.net/element-plus/2.4.4/index.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #f5f7fa;
    }
    #app {
      height: 100vh;
    }
    /* ç™»å½•é¡µé¢æ ·å¼ */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .login-box {
      width: 400px;
      padding: 40px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .login-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 30px;
      color: #333;
    }
    /* ä¸»ç•Œé¢æ ·å¼ */
    .admin-container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 240px;
      background: #304156;
      color: white;
    }
    .sidebar-header {
      height: 60px;
      line-height: 60px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      background: #1f2d3d;
      border-bottom: 1px solid #1f2d3d;
    }
    .sidebar-menu {
      padding: 10px 0;
    }
    .menu-item {
      height: 50px;
      line-height: 50px;
      padding: 0 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
    }
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
    }
    .menu-item.active {
      background: #409eff;
    }
    .menu-icon {
      margin-right: 10px;
      font-size: 16px;
    }
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      height: 60px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }
    .header-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    .header-user {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .page-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
    .data-table {
      background: white;
      border-radius: 8px;
      padding: 20px;
    }
    /* å›¾ç‰‡é¢„è§ˆ */
    .image-preview {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }
    /* çŠ¶æ€æ ‡ç­¾ */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-enabled {
      background: #e7f9f0;
      color: #00a870;
    }
    .status-disabled {
      background: #fef0f0;
      color: #f56c6c;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ç™»å½•é¡µé¢ -->
    <div v-if="!isLoggedIn" class="login-container">
      <div class="login-box">
        <div class="login-title">æ™¯åŒºæ¸¸èˆ¹ç®¡ç†åå°</div>
        <el-form :model="loginForm" @submit.prevent="handleLogin">
          <el-form-item>
            <el-input
              v-model="loginForm.username"
              placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
              prefix-icon="User"
              size="large"
            />
          </el-form-item>
          <el-form-item>
            <el-input
              v-model="loginForm.password"
              type="password"
              placeholder="è¯·è¾“å…¥å¯†ç "
              prefix-icon="Lock"
              size="large"
              @keyup.enter="handleLogin"
            />
          </el-form-item>
          <el-form-item>
            <el-button
              type="primary"
              size="large"
              style="width: 100%"
              :loading="loginLoading"
              @click="handleLogin"
            >
              ç™»å½•
            </el-button>
          </el-form-item>
        </el-form>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div v-else class="admin-container">
      <!-- ä¾§è¾¹æ  -->
      <div class="sidebar">
        <div class="sidebar-header">æ¸¸èˆ¹ç®¡ç†ç³»ç»Ÿ</div>
        <div class="sidebar-menu">
          <div
            v-for="menu in menus"
            :key="menu.key"
            class="menu-item"
            :class="{ active: currentMenu === menu.key }"
            @click="switchMenu(menu.key)"
          >
            <span class="menu-icon">{{ menu.icon }}</span>
            <span>{{ menu.label }}</span>
          </div>
        </div>
      </div>

      <!-- ä¸»å†…å®¹åŒº -->
      <div class="main-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="header">
          <div class="header-title">{{ getCurrentMenuLabel() }}</div>
          <div class="header-user">
            <span>{{ currentUser.realName || currentUser.username }}</span>
            <el-button type="danger" size="small" @click="handleLogout">é€€å‡º</el-button>
          </div>
        </div>

        <!-- å†…å®¹åŒº -->
        <div class="content">
          <!-- èˆ¹å‹ç®¡ç† -->
          <div v-if="currentMenu === 'boatTypes'">
            <div class="page-header">
              <div class="page-title">èˆ¹å‹ç®¡ç†</div>
              <el-button type="primary" @click="openDialog('boatTypes', 'add')">æ–°å¢èˆ¹å‹</el-button>
            </div>
            <div class="data-table">
              <el-table :data="boatTypesData" v-loading="loading">
                <el-table-column prop="_id" label="ID" width="180" />
                <el-table-column label="å›¾ç‰‡" width="100">
                  <template #default="{ row }">
                    <el-image
                      v-if="row.imageUrl"
                      :src="row.imageUrl"
                      :preview-src-list="[row.imageUrl]"
                      class="image-preview"
                      fit="cover"
                    />
                  </template>
                </el-table-column>
                <el-table-column prop="name" label="èˆ¹å‹åç§°" width="150" />
                <el-table-column prop="description" label="æè¿°" />
                <el-table-column prop="maxCapacity" label="æœ€å¤§è½½å®¢" width="100" />
                <el-table-column label="åŸºç¡€ä»·æ ¼" width="100">
                  <template #default="{ row }">
                    Â¥{{ row.pricing?.basePrice }}
                  </template>
                </el-table-column>
                <el-table-column prop="sort" label="æ’åº" width="80" />
                <el-table-column label="çŠ¶æ€" width="100">
                  <template #default="{ row }">
                    <span :class="row.enabled ? 'status-badge status-enabled' : 'status-badge status-disabled'">
                      {{ row.enabled ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                    </span>
                  </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="180" fixed="right">
                  <template #default="{ row }">
                    <el-button size="small" @click="openDialog('boatTypes', 'edit', row)">ç¼–è¾‘</el-button>
                    <el-button size="small" type="danger" @click="deleteItem('boatTypes', row._id)">åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>

          <!-- èˆ¹åªç®¡ç† -->
          <div v-if="currentMenu === 'boats'">
            <div class="page-header">
              <div class="page-title">èˆ¹åªç®¡ç†</div>
              <el-button type="primary" @click="openDialog('boats', 'add')">æ–°å¢èˆ¹åª</el-button>
            </div>
            <div class="data-table">
              <el-table :data="boatsData" v-loading="loading">
                <el-table-column prop="_id" label="ID" width="180" />
                <el-table-column prop="boatNumber" label="èˆ¹å·" width="150" />
                <el-table-column label="èˆ¹å‹" width="150">
                  <template #default="{ row }">
                    {{ getBoatTypeName(row.boatTypeId) }}
                  </template>
                </el-table-column>
                <el-table-column label="çŠ¶æ€" width="120">
                  <template #default="{ row }">
                    <el-tag v-if="row.status === 'idle'" type="success">ç©ºé—²</el-tag>
                    <el-tag v-else-if="row.status === 'in_use'" type="warning">ä½¿ç”¨ä¸­</el-tag>
                    <el-tag v-else type="info">ç»´æŠ¤ä¸­</el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="å¯ç”¨çŠ¶æ€" width="100">
                  <template #default="{ row }">
                    <span :class="row.enabled ? 'status-badge status-enabled' : 'status-badge status-disabled'">
                      {{ row.enabled ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                    </span>
                  </template>
                </el-table-column>
                <el-table-column prop="lastUsedAt" label="æœ€åä½¿ç”¨æ—¶é—´" width="180" />
                <el-table-column label="æ“ä½œ" width="180" fixed="right">
                  <template #default="{ row }">
                    <el-button size="small" @click="openDialog('boats', 'edit', row)">ç¼–è¾‘</el-button>
                    <el-button size="small" type="danger" @click="deleteItem('boats', row._id)">åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>

          <!-- å‘˜å·¥ç®¡ç† -->
          <div v-if="currentMenu === 'staff'">
            <div class="page-header">
              <div class="page-title">å‘˜å·¥ç®¡ç†</div>
              <el-button type="primary" @click="openDialog('staff', 'add')">æ–°å¢å‘˜å·¥</el-button>
            </div>
            <div class="data-table">
              <el-table :data="staffData" v-loading="loading">
                <el-table-column prop="_id" label="ID" width="180" />
                <el-table-column prop="username" label="ç”¨æˆ·å" width="150" />
                <el-table-column prop="realName" label="çœŸå®å§“å" width="150" />
                <el-table-column prop="phone" label="æ‰‹æœºå·" width="150" />
                <el-table-column label="è§’è‰²" width="120">
                  <template #default="{ row }">
                    <el-tag v-if="row.role === 'admin'" type="danger">ç®¡ç†å‘˜</el-tag>
                    <el-tag v-else>å‘˜å·¥</el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="çŠ¶æ€" width="100">
                  <template #default="{ row }">
                    <span :class="row.enabled ? 'status-badge status-enabled' : 'status-badge status-disabled'">
                      {{ row.enabled ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                    </span>
                  </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="200" fixed="right">
                  <template #default="{ row }">
                    <el-button size="small" @click="openDialog('staff', 'edit', row)">ç¼–è¾‘</el-button>
                    <el-button size="small" type="warning" @click="openDialog('staff', 'password', row)">æ”¹å¯†ç </el-button>
                    <el-button size="small" type="danger" @click="deleteItem('staff', row._id)">åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>

          <!-- è½®æ’­å›¾ç®¡ç† -->
          <div v-if="currentMenu === 'banners'">
            <div class="page-header">
              <div class="page-title">è½®æ’­å›¾ç®¡ç†</div>
              <el-button type="primary" @click="openDialog('banners', 'add')">æ–°å¢è½®æ’­å›¾</el-button>
            </div>
            <div class="data-table">
              <el-table :data="bannersData" v-loading="loading">
                <el-table-column prop="_id" label="ID" width="180" />
                <el-table-column label="å›¾ç‰‡" width="120">
                  <template #default="{ row }">
                    <el-image
                      v-if="row.imageUrl"
                      :src="row.imageUrl"
                      :preview-src-list="[row.imageUrl]"
                      class="image-preview"
                      fit="cover"
                    />
                  </template>
                </el-table-column>
                <el-table-column prop="title" label="æ ‡é¢˜" width="200" />
                <el-table-column label="é“¾æ¥ç±»å‹" width="120">
                  <template #default="{ row }">
                    <el-tag v-if="row.linkType === 'none'">æ— é“¾æ¥</el-tag>
                    <el-tag v-else-if="row.linkType === 'page'" type="success">å°ç¨‹åºé¡µé¢</el-tag>
                    <el-tag v-else type="warning">å¤–éƒ¨é“¾æ¥</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="linkUrl" label="é“¾æ¥åœ°å€" show-overflow-tooltip />
                <el-table-column prop="sort" label="æ’åº" width="80" />
                <el-table-column label="çŠ¶æ€" width="100">
                  <template #default="{ row }">
                    <span :class="row.enabled ? 'status-badge status-enabled' : 'status-badge status-disabled'">
                      {{ row.enabled ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                    </span>
                  </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="180" fixed="right">
                  <template #default="{ row }">
                    <el-button size="small" @click="openDialog('banners', 'edit', row)">ç¼–è¾‘</el-button>
                    <el-button size="small" type="danger" @click="deleteItem('banners', row._id)">åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>

          <!-- å…¬å‘Šç®¡ç† -->
          <div v-if="currentMenu === 'announcements'">
            <div class="page-header">
              <div class="page-title">å…¬å‘Šç®¡ç†</div>
              <el-button type="primary" @click="openDialog('announcements', 'add')">æ–°å¢å…¬å‘Š</el-button>
            </div>
            <div class="data-table">
              <el-table :data="announcementsData" v-loading="loading">
                <el-table-column prop="_id" label="ID" width="180" />
                <el-table-column prop="title" label="æ ‡é¢˜" width="200" />
                <el-table-column label="ç±»å‹" width="100">
                  <template #default="{ row }">
                    <el-tag v-if="row.type === 'warning'" type="warning">è­¦å‘Š</el-tag>
                    <el-tag v-else-if="row.type === 'urgent'" type="danger">ç´§æ€¥</el-tag>
                    <el-tag v-else type="info">é€šçŸ¥</el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="é¦–é¡µæ˜¾ç¤º" width="100">
                  <template #default="{ row }">
                    <el-tag v-if="row.showOnHome" type="success">æ˜¯</el-tag>
                    <el-tag v-else type="info">å¦</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="startDate" label="å¼€å§‹æ—¶é—´" width="180" />
                <el-table-column prop="endDate" label="ç»“æŸæ—¶é—´" width="180" />
                <el-table-column prop="sort" label="æ’åº" width="80" />
                <el-table-column label="çŠ¶æ€" width="100">
                  <template #default="{ row }">
                    <span :class="row.enabled ? 'status-badge status-enabled' : 'status-badge status-disabled'">
                      {{ row.enabled ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                    </span>
                  </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="180" fixed="right">
                  <template #default="{ row }">
                    <el-button size="small" @click="openDialog('announcements', 'edit', row)">ç¼–è¾‘</el-button>
                    <el-button size="small" type="danger" @click="deleteItem('announcements', row._id)">åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- é€šç”¨ç¼–è¾‘å¯¹è¯æ¡† -->
    <el-dialog
      v-model="dialogVisible"
      :title="dialogTitle"
      width="600px"
      :close-on-click-modal="false"
    >
      <!-- èˆ¹å‹è¡¨å• -->
      <el-form v-if="dialogType === 'boatTypes'" :model="dialogForm" label-width="120px">
        <el-form-item label="èˆ¹å‹åç§°">
          <el-input v-model="dialogForm.name" placeholder="è¯·è¾“å…¥èˆ¹å‹åç§°" />
        </el-form-item>
        <el-form-item label="æè¿°">
          <el-input v-model="dialogForm.description" type="textarea" :rows="3" placeholder="è¯·è¾“å…¥æè¿°" />
        </el-form-item>
        <el-form-item label="æœ€å¤§è½½å®¢">
          <el-input-number v-model="dialogForm.maxCapacity" :min="1" :max="20" />
        </el-form-item>
        <el-form-item label="åŸºç¡€ç¥¨ä»·">
          <el-input-number v-model="dialogForm.pricing.basePrice" :min="0" :precision="2" />
        </el-form-item>
        <el-form-item label="æŠ¼é‡‘é‡‘é¢">
          <el-input-number v-model="dialogForm.pricing.depositAmount" :min="0" :precision="2" />
        </el-form-item>
        <el-form-item label="åŒ…å«æ—¶é•¿(åˆ†é’Ÿ)">
          <el-input-number v-model="dialogForm.pricing.includedMinutes" :min="1" />
        </el-form-item>
        <el-form-item label="è¶…æ—¶è´¹ç‡(å…ƒ/åˆ†)">
          <el-input-number v-model="dialogForm.pricing.overtimeRate" :min="0" :precision="2" />
        </el-form-item>
        <el-form-item label="èˆ¹å‹å›¾ç‰‡">
          <el-upload
            :action="''"
            :auto-upload="false"
            :on-change="handleImageChange"
            :show-file-list="false"
            accept="image/*"
          >
            <el-button size="small" type="primary">é€‰æ‹©å›¾ç‰‡</el-button>
          </el-upload>
          <el-image
            v-if="dialogForm.imageUrl"
            :src="dialogForm.imageUrl"
            style="width: 200px; height: 150px; margin-top: 10px"
            fit="contain"
          />
        </el-form-item>
        <el-form-item label="æ’åº">
          <el-input-number v-model="dialogForm.sort" :min="0" />
        </el-form-item>
        <el-form-item label="æ˜¯å¦å¯ç”¨">
          <el-switch v-model="dialogForm.enabled" />
        </el-form-item>
      </el-form>

      <!-- èˆ¹åªè¡¨å• -->
      <el-form v-if="dialogType === 'boats'" :model="dialogForm" label-width="120px">
        <el-form-item label="èˆ¹å·">
          <el-input v-model="dialogForm.boatNumber" placeholder="ä¾‹å¦‚: E-001" />
        </el-form-item>
        <el-form-item label="èˆ¹å‹">
          <el-select v-model="dialogForm.boatTypeId" placeholder="è¯·é€‰æ‹©èˆ¹å‹">
            <el-option
              v-for="type in boatTypesData"
              :key="type._id"
              :label="type.name"
              :value="type._id"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="çŠ¶æ€">
          <el-select v-model="dialogForm.status" placeholder="è¯·é€‰æ‹©çŠ¶æ€">
            <el-option label="ç©ºé—²" value="idle" />
            <el-option label="ä½¿ç”¨ä¸­" value="in_use" />
            <el-option label="ç»´æŠ¤ä¸­" value="maintenance" />
          </el-select>
        </el-form-item>
        <el-form-item label="æ˜¯å¦å¯ç”¨">
          <el-switch v-model="dialogForm.enabled" />
        </el-form-item>
      </el-form>

      <!-- å‘˜å·¥è¡¨å• -->
      <el-form v-if="dialogType === 'staff' && dialogMode !== 'password'" :model="dialogForm" label-width="120px">
        <el-form-item label="ç”¨æˆ·å">
          <el-input v-model="dialogForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" :disabled="dialogMode === 'edit'" />
        </el-form-item>
        <el-form-item label="å¯†ç " v-if="dialogMode === 'add'">
          <el-input v-model="dialogForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " />
        </el-form-item>
        <el-form-item label="çœŸå®å§“å">
          <el-input v-model="dialogForm.realName" placeholder="è¯·è¾“å…¥çœŸå®å§“å" />
        </el-form-item>
        <el-form-item label="æ‰‹æœºå·">
          <el-input v-model="dialogForm.phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
        </el-form-item>
        <el-form-item label="è§’è‰²">
          <el-select v-model="dialogForm.role" placeholder="è¯·é€‰æ‹©è§’è‰²">
            <el-option label="å‘˜å·¥" value="staff" />
            <el-option label="ç®¡ç†å‘˜" value="admin" />
          </el-select>
        </el-form-item>
        <el-form-item label="æ˜¯å¦å¯ç”¨">
          <el-switch v-model="dialogForm.enabled" />
        </el-form-item>
      </el-form>

      <!-- ä¿®æ”¹å¯†ç è¡¨å• -->
      <el-form v-if="dialogType === 'staff' && dialogMode === 'password'" :model="dialogForm" label-width="120px">
        <el-form-item label="æ–°å¯†ç ">
          <el-input v-model="dialogForm.newPassword" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " />
        </el-form-item>
        <el-form-item label="ç¡®è®¤å¯†ç ">
          <el-input v-model="dialogForm.confirmPassword" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " />
        </el-form-item>
      </el-form>

      <!-- è½®æ’­å›¾è¡¨å• -->
      <el-form v-if="dialogType === 'banners'" :model="dialogForm" label-width="120px">
        <el-form-item label="æ ‡é¢˜">
          <el-input v-model="dialogForm.title" placeholder="è¯·è¾“å…¥æ ‡é¢˜" />
        </el-form-item>
        <el-form-item label="è½®æ’­å›¾å›¾ç‰‡">
          <el-upload
            :action="''"
            :auto-upload="false"
            :on-change="handleImageChange"
            :show-file-list="false"
            accept="image/*"
          >
            <el-button size="small" type="primary">é€‰æ‹©å›¾ç‰‡</el-button>
          </el-upload>
          <el-image
            v-if="dialogForm.imageUrl"
            :src="dialogForm.imageUrl"
            style="width: 300px; height: 150px; margin-top: 10px"
            fit="contain"
          />
        </el-form-item>
        <el-form-item label="é“¾æ¥ç±»å‹">
          <el-select v-model="dialogForm.linkType" placeholder="è¯·é€‰æ‹©é“¾æ¥ç±»å‹">
            <el-option label="æ— é“¾æ¥" value="none" />
            <el-option label="å°ç¨‹åºé¡µé¢" value="page" />
            <el-option label="å¤–éƒ¨é“¾æ¥" value="web" />
          </el-select>
        </el-form-item>
        <el-form-item label="é“¾æ¥åœ°å€" v-if="dialogForm.linkType !== 'none'">
          <el-input v-model="dialogForm.linkUrl" placeholder="è¯·è¾“å…¥é“¾æ¥åœ°å€" />
        </el-form-item>
        <el-form-item label="æ’åº">
          <el-input-number v-model="dialogForm.sort" :min="0" />
        </el-form-item>
        <el-form-item label="æ˜¯å¦å¯ç”¨">
          <el-switch v-model="dialogForm.enabled" />
        </el-form-item>
      </el-form>

      <!-- å…¬å‘Šè¡¨å• -->
      <el-form v-if="dialogType === 'announcements'" :model="dialogForm" label-width="120px">
        <el-form-item label="æ ‡é¢˜">
          <el-input v-model="dialogForm.title" placeholder="è¯·è¾“å…¥æ ‡é¢˜" />
        </el-form-item>
        <el-form-item label="å†…å®¹">
          <el-input v-model="dialogForm.content" type="textarea" :rows="5" placeholder="è¯·è¾“å…¥å†…å®¹" />
        </el-form-item>
        <el-form-item label="ç±»å‹">
          <el-select v-model="dialogForm.type" placeholder="è¯·é€‰æ‹©ç±»å‹">
            <el-option label="é€šçŸ¥" value="info" />
            <el-option label="è­¦å‘Š" value="warning" />
            <el-option label="ç´§æ€¥" value="urgent" />
          </el-select>
        </el-form-item>
        <el-form-item label="é¦–é¡µæ˜¾ç¤º">
          <el-switch v-model="dialogForm.showOnHome" />
        </el-form-item>
        <el-form-item label="å¼€å§‹æ—¶é—´">
          <el-date-picker
            v-model="dialogForm.startDate"
            type="datetime"
            placeholder="é€‰æ‹©å¼€å§‹æ—¶é—´"
            style="width: 100%"
          />
        </el-form-item>
        <el-form-item label="ç»“æŸæ—¶é—´">
          <el-date-picker
            v-model="dialogForm.endDate"
            type="datetime"
            placeholder="é€‰æ‹©ç»“æŸæ—¶é—´"
            style="width: 100%"
          />
        </el-form-item>
        <el-form-item label="æ’åº">
          <el-input-number v-model="dialogForm.sort" :min="0" />
        </el-form-item>
        <el-form-item label="æ˜¯å¦å¯ç”¨">
          <el-switch v-model="dialogForm.enabled" />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleSave" :loading="saveLoading">ä¿å­˜</el-button>
      </template>
    </el-dialog>
  </div>

  <!-- Vue 3 -->
  <script src="https://cdn.staticfile.net/vue/3.3.11/vue.global.min.js"></script>
  <!-- Element Plus -->
<script src="https://cdn.staticfile.net/element-plus/2.4.4/index.full.min.js"></script>
  <!-- Element Plus Icon -->
<script src="https://cdn.staticfile.net/element-plus-icons-vue/2.1.0/index.iife.min.js"></script>
  <!-- Cloudbase JS SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/2.2.0/cloudbase.full.js"></script>

  <script>
    const { createApp } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;

    // è¯·åœ¨è¿™é‡Œé…ç½®ä½ çš„äº‘å¼€å‘ç¯å¢ƒID
    const ENV_ID = 'cc-5gos3ctb46510316'; // æ›¿æ¢ä¸ºä½ çš„ç¯å¢ƒID

    createApp({
      data() {
        return {
          // ç™»å½•ç›¸å…³
          isLoggedIn: false,
          loginForm: {
            username: '',
            password: ''
          },
          loginLoading: false,
          currentUser: {},

          // èœå•
          menus: [
            { key: 'boatTypes', label: 'èˆ¹å‹ç®¡ç†', icon: 'ğŸš¤' },
            { key: 'boats', label: 'èˆ¹åªç®¡ç†', icon: 'â›µ' },
            { key: 'staff', label: 'å‘˜å·¥ç®¡ç†', icon: 'ğŸ‘¥' },
            { key: 'banners', label: 'è½®æ’­å›¾ç®¡ç†', icon: 'ğŸ–¼ï¸' },
            { key: 'announcements', label: 'å…¬å‘Šç®¡ç†', icon: 'ğŸ“¢' }
          ],
          currentMenu: 'boatTypes',

          // æ•°æ®
          boatTypesData: [],
          boatsData: [],
          staffData: [],
          bannersData: [],
          announcementsData: [],

          // å¯¹è¯æ¡†
          dialogVisible: false,
          dialogType: '',
          dialogMode: '', // add / edit / password
          dialogForm: {},
          dialogTitle: '',

          // çŠ¶æ€
          loading: false,
          saveLoading: false,

          // Cloudbase å®ä¾‹
          app: null,
          db: null,
          auth: null,

          // å›¾ç‰‡ä¸Šä¼ ä¸´æ—¶æ–‡ä»¶
          tempImageFile: null
        };
      },
      async mounted() {
        // åˆå§‹åŒ–äº‘å¼€å‘
        this.initCloudbase();

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const savedUser = localStorage.getItem('adminUser');
        if (savedUser) {
          this.currentUser = JSON.parse(savedUser);
          this.isLoggedIn = true;
          await this.loadData();
        }
      },
      methods: {
        // åˆå§‹åŒ–äº‘å¼€å‘
        initCloudbase() {
          // æ£€æŸ¥ CloudBase SDK æ˜¯å¦åŠ è½½æˆåŠŸ
          if (typeof cloudbase === 'undefined') {
            console.error('CloudBase SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            ElMessage.error('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
          }

          try {
            this.app = cloudbase.init({
              env: ENV_ID
            });
            this.db = this.app.database();
            this.auth = this.app.auth({
              persistence: 'local'
            });
            console.log('CloudBase åˆå§‹åŒ–æˆåŠŸï¼Œç¯å¢ƒID:', ENV_ID);
          } catch (error) {
            console.error('CloudBase åˆå§‹åŒ–å¤±è´¥:', error);
            ElMessage.error('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message);
          }
        },

        // ç™»å½•
        async handleLogin() {
          if (!this.loginForm.username || !this.loginForm.password) {
            ElMessage.error('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            return;
          }

          // æ£€æŸ¥ CloudBase æ˜¯å¦åˆå§‹åŒ–
          if (!this.app) {
            ElMessage.error('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
            return;
          }

          this.loginLoading = true;
          try {
            // è°ƒç”¨äº‘å‡½æ•°éªŒè¯ç™»å½•
            const res = await this.app.callFunction({
              name: 'staffLogin',
              data: {
                username: this.loginForm.username,
                password: this.loginForm.password
              }
            });

            if (res.result.code === 200) {
              const staffInfo = res.result.data.staffInfo;

              // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
              if (staffInfo.role !== 'admin') {
                ElMessage.error('åªæœ‰ç®¡ç†å‘˜æ‰èƒ½ç™»å½•åå°');
                this.loginLoading = false;
                return;
              }

              this.currentUser = staffInfo;
              this.isLoggedIn = true;
              localStorage.setItem('adminUser', JSON.stringify(staffInfo));

              ElMessage.success('ç™»å½•æˆåŠŸ');
              await this.loadData();
            } else {
              ElMessage.error(res.result.message || 'ç™»å½•å¤±è´¥');
            }
          } catch (error) {
            console.error('ç™»å½•å¤±è´¥:', error);
            ElMessage.error('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
          }
          this.loginLoading = false;
        },

        // é€€å‡ºç™»å½•
        handleLogout() {
          ElMessageBox.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'æç¤º', {
            confirmButtonText: 'ç¡®å®š',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning'
          }).then(() => {
            this.isLoggedIn = false;
            this.currentUser = {};
            this.loginForm = { username: '', password: '' };
            localStorage.removeItem('adminUser');
            ElMessage.success('å·²é€€å‡ºç™»å½•');
          }).catch(() => {});
        },

        // åˆ‡æ¢èœå•
        async switchMenu(key) {
          this.currentMenu = key;
          await this.loadData();
        },

        // è·å–å½“å‰èœå•æ ‡ç­¾
        getCurrentMenuLabel() {
          const menu = this.menus.find(m => m.key === this.currentMenu);
          return menu ? menu.label : '';
        },

        // åŠ è½½æ•°æ®
        async loadData() {
          this.loading = true;
          try {
            const collection = this.currentMenu;
            const res = await this.db.collection(collection).get();

            switch (collection) {
              case 'boatTypes':
                this.boatTypesData = res.data.sort((a, b) => (a.sort || 0) - (b.sort || 0));
                break;
              case 'boats':
                this.boatsData = res.data;
                // åŠ è½½èˆ¹å‹æ•°æ®ä»¥ä¾¿æ˜¾ç¤º
                if (this.boatTypesData.length === 0) {
                  const boatTypesRes = await this.db.collection('boatTypes').get();
                  this.boatTypesData = boatTypesRes.data;
                }
                break;
              case 'staff':
                this.staffData = res.data;
                break;
              case 'banners':
                this.bannersData = res.data.sort((a, b) => (a.sort || 0) - (b.sort || 0));
                break;
              case 'announcements':
                this.announcementsData = res.data.sort((a, b) => (a.sort || 0) - (b.sort || 0));
                break;
            }
          } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥');
          }
          this.loading = false;
        },

        // æ‰“å¼€å¯¹è¯æ¡†
        openDialog(type, mode, row = null) {
          this.dialogType = type;
          this.dialogMode = mode;
          this.tempImageFile = null;

          if (mode === 'add') {
            this.dialogTitle = 'æ–°å¢';
            this.dialogForm = this.getEmptyForm(type);
          } else if (mode === 'edit') {
            this.dialogTitle = 'ç¼–è¾‘';
            this.dialogForm = JSON.parse(JSON.stringify(row));
          } else if (mode === 'password') {
            this.dialogTitle = 'ä¿®æ”¹å¯†ç ';
            this.dialogForm = {
              _id: row._id,
              newPassword: '',
              confirmPassword: ''
            };
          }

          this.dialogVisible = true;
        },

        // è·å–ç©ºè¡¨å•
        getEmptyForm(type) {
          const forms = {
            boatTypes: {
              name: '',
              description: '',
              maxCapacity: 4,
              pricing: {
                basePrice: 0,
                depositAmount: 0,
                includedMinutes: 60,
                overtimeRate: 0
              },
              imageUrl: '',
              sort: 0,
              enabled: true
            },
            boats: {
              boatNumber: '',
              boatTypeId: '',
              status: 'idle',
              enabled: true
            },
            staff: {
              username: '',
              password: '',
              realName: '',
              phone: '',
              role: 'staff',
              enabled: true
            },
            banners: {
              title: '',
              imageUrl: '',
              linkType: 'none',
              linkUrl: '',
              sort: 0,
              enabled: true
            },
            announcements: {
              title: '',
              content: '',
              type: 'info',
              showOnHome: true,
              startDate: new Date(),
              endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
              sort: 0,
              enabled: true
            }
          };
          return forms[type] || {};
        },

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        async handleImageChange(file) {
          this.tempImageFile = file.raw;

          // é¢„è§ˆå›¾ç‰‡
          const reader = new FileReader();
          reader.onload = (e) => {
            this.dialogForm.imageUrl = e.target.result;
          };
          reader.readAsDataURL(file.raw);
        },

        // ä¸Šä¼ å›¾ç‰‡åˆ°äº‘å­˜å‚¨
        async uploadImage(file) {
          try {
            const fileExtension = file.name.split('.').pop();
            const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExtension}`;
            const cloudPath = `admin/${fileName}`;

            // ä¸Šä¼ æ–‡ä»¶
            const result = await this.app.uploadFile({
              cloudPath: cloudPath,
              filePath: file
            });

            // è·å–ä¸´æ—¶é“¾æ¥
            const tempFileURL = await this.app.getTempFileURL({
              fileList: [result.fileID]
            });

            return tempFileURL.fileList[0].tempFileURL;
          } catch (error) {
            console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
            throw error;
          }
        },

        // ä¿å­˜
        async handleSave() {
          // ä¿®æ”¹å¯†ç ç‰¹æ®Šå¤„ç†
          if (this.dialogType === 'staff' && this.dialogMode === 'password') {
            if (!this.dialogForm.newPassword) {
              ElMessage.error('è¯·è¾“å…¥æ–°å¯†ç ');
              return;
            }
            if (this.dialogForm.newPassword !== this.dialogForm.confirmPassword) {
              ElMessage.error('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
              return;
            }

            this.saveLoading = true;
            try {
              // è°ƒç”¨äº‘å‡½æ•°ä¿®æ”¹å¯†ç 
              const res = await this.app.callFunction({
                name: 'updateStaffPassword',
                data: {
                  staffId: this.dialogForm._id,
                  newPassword: this.dialogForm.newPassword
                }
              });

              if (res.result.code === 200) {
                ElMessage.success('å¯†ç ä¿®æ”¹æˆåŠŸ');
                this.dialogVisible = false;
              } else {
                ElMessage.error(res.result.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
              }
            } catch (error) {
              console.error('å¯†ç ä¿®æ”¹å¤±è´¥:', error);
              ElMessage.error('å¯†ç ä¿®æ”¹å¤±è´¥');
            }
            this.saveLoading = false;
            return;
          }

          // è¡¨å•éªŒè¯
          if (!this.validateForm()) {
            return;
          }

          this.saveLoading = true;
          try {
            // å¦‚æœæœ‰å›¾ç‰‡éœ€è¦ä¸Šä¼ 
            if (this.tempImageFile) {
              const imageUrl = await this.uploadImage(this.tempImageFile);
              this.dialogForm.imageUrl = imageUrl;
            }

            const collection = this.dialogType;
            const data = { ...this.dialogForm };

            // å¤„ç†æ—¥æœŸå­—æ®µ
            if (collection === 'announcements') {
              if (data.startDate) data.startDate = new Date(data.startDate);
              if (data.endDate) data.endDate = new Date(data.endDate);
            }

            // æ·»åŠ æ—¶é—´æˆ³
            if (this.dialogMode === 'add') {
              data.createdAt = new Date();
            }
            data.updatedAt = new Date();

            if (this.dialogMode === 'add') {
              // æ–°å¢
              delete data._id;

              // å¦‚æœæ˜¯å‘˜å·¥ï¼Œè°ƒç”¨äº‘å‡½æ•°è¿›è¡Œå¯†ç åŠ å¯†
              if (collection === 'staff') {
                const res = await this.app.callFunction({
                  name: 'createStaff',
                  data: data
                });
                if (res.result.code !== 200) {
                  throw new Error(res.result.message);
                }
              } else {
                await this.db.collection(collection).add(data);
              }

              ElMessage.success('æ–°å¢æˆåŠŸ');
            } else {
              // ç¼–è¾‘
              const id = data._id;
              delete data._id;

              // å¦‚æœæ˜¯å‘˜å·¥ï¼Œä¸å…è®¸ç›´æ¥ä¿®æ”¹å¯†ç 
              if (collection === 'staff') {
                delete data.password;
              }

              await this.db.collection(collection).doc(id).update(data);
              ElMessage.success('ä¿å­˜æˆåŠŸ');
            }

            this.dialogVisible = false;
            await this.loadData();
          } catch (error) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            ElMessage.error(error.message || 'ä¿å­˜å¤±è´¥');
          }
          this.saveLoading = false;
        },

        // è¡¨å•éªŒè¯
        validateForm() {
          const type = this.dialogType;
          const form = this.dialogForm;

          if (type === 'boatTypes') {
            if (!form.name) {
              ElMessage.error('è¯·è¾“å…¥èˆ¹å‹åç§°');
              return false;
            }
          } else if (type === 'boats') {
            if (!form.boatNumber) {
              ElMessage.error('è¯·è¾“å…¥èˆ¹å·');
              return false;
            }
            if (!form.boatTypeId) {
              ElMessage.error('è¯·é€‰æ‹©èˆ¹å‹');
              return false;
            }
          } else if (type === 'staff') {
            if (!form.username) {
              ElMessage.error('è¯·è¾“å…¥ç”¨æˆ·å');
              return false;
            }
            if (this.dialogMode === 'add' && !form.password) {
              ElMessage.error('è¯·è¾“å…¥å¯†ç ');
              return false;
            }
          } else if (type === 'banners') {
            if (!form.title) {
              ElMessage.error('è¯·è¾“å…¥æ ‡é¢˜');
              return false;
            }
            if (!form.imageUrl) {
              ElMessage.error('è¯·ä¸Šä¼ å›¾ç‰‡');
              return false;
            }
          } else if (type === 'announcements') {
            if (!form.title) {
              ElMessage.error('è¯·è¾“å…¥æ ‡é¢˜');
              return false;
            }
            if (!form.content) {
              ElMessage.error('è¯·è¾“å…¥å†…å®¹');
              return false;
            }
          }

          return true;
        },

        // åˆ é™¤
        async deleteItem(collection, id) {
          ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', 'æç¤º', {
            confirmButtonText: 'ç¡®å®š',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning'
          }).then(async () => {
            try {
              await this.db.collection(collection).doc(id).remove();
              ElMessage.success('åˆ é™¤æˆåŠŸ');
              await this.loadData();
            } catch (error) {
              console.error('åˆ é™¤å¤±è´¥:', error);
              ElMessage.error('åˆ é™¤å¤±è´¥');
            }
          }).catch(() => {});
        },

        // è·å–èˆ¹å‹åç§°
        getBoatTypeName(typeId) {
          const type = this.boatTypesData.find(t => t._id === typeId);
          return type ? type.name : '-';
        }
      }
    }).use(ElementPlus).mount('#app');
  </script>
</body>
</html>
