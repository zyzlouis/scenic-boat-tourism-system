# è®¢å•è¶…æ—¶æœºåˆ¶è¯´æ˜

## å‘ç°çš„ä¸¥é‡ BUG ğŸ›

### é—®é¢˜ç°è±¡
æ‰«æ1å°æ—¶å‰çš„è®¢å•ï¼Œæ˜¾ç¤ºï¼š
```
ä½¿ç”¨æ—¶é•¿ï¼š491730å°æ—¶9åˆ†é’Ÿï¼ˆçº¦56å¹´ï¼‰
è¶…æ—¶è´¹ç”¨ï¼šÂ¥29503749.00
é€€æ¬¾é‡‘é¢ï¼šÂ¥-29503649.00
```

---

## é—®é¢˜æ ¹æº

### åŸå› 1ï¼šæ—¶é—´è®¡ç®—é”™è¯¯ âŒ

**ä»£ç ï¼š**
```javascript
const startTime = new Date(order.timing.startTime)  // null â†’ 1970-01-01
const now = new Date()  // 2026-02-05
const usedSeconds = (now - startTime) / 1000  // è®¡ç®—å·®å€¼
```

**å¦‚æœ `startTime` æ˜¯ nullï¼š**
- `new Date(null)` â†’ `new Date(0)` â†’ 1970-01-01 00:00:00
- `now - startTime` â†’ 2026å¹´ - 1970å¹´ = **56å¹´**
- 491730å°æ—¶ â‰ˆ 56å¹´ âœ… æ•°å­—å»åˆï¼

**ç»“è®ºï¼š** è¿™ä¸ªè®¢å•çš„ `timing.startTime` å­—æ®µæ˜¯ **null** æˆ–æœªè®¾ç½®ã€‚

---

### åŸå› 2ï¼šæ•°æ®å¼‚å¸¸ âŒ

**å¯èƒ½åŸå› ï¼š**
1. æµ‹è¯•æ—¶æ‰‹åŠ¨åœ¨æ•°æ®åº“ä¿®æ”¹äº† `status = 'timing'`
2. ä½†æ²¡æœ‰è®¾ç½® `timing.startTime`
3. å¯¼è‡´è®¢å•çŠ¶æ€ä¸ä¸€è‡´

**æˆªå›¾æ˜¾ç¤ºï¼š**
- èˆ¹å·ï¼šnull â† æ²¡æœ‰èˆ¹å·
- çŠ¶æ€ï¼štiming â† åº”è¯¥æ˜¯å‘èˆ¹åæ‰æœ‰çš„çŠ¶æ€
- å¼€å§‹æ—¶é—´ï¼šnull â† æ ¹æœ¬åŸå› 

---

### åŸå› 3ï¼šæ²¡æœ‰è¶…æ—¶æœºåˆ¶ âŒ

**æ—§ä»£ç é—®é¢˜ï¼š**
- âœ… æ²¡æœ‰æ£€æŸ¥è®¢å•æ”¯ä»˜åå¤šä¹…
- âœ… æ²¡æœ‰éªŒè¯ startTime æœ‰æ•ˆæ€§
- âœ… æ²¡æœ‰æ£€æŸ¥ä½¿ç”¨æ—¶é•¿æ˜¯å¦åˆç†
- âœ… ä»»ä½• 'paid' çŠ¶æ€çš„è®¢å•éƒ½èƒ½æ ¸é”€ï¼ˆå³ä½¿1ä¸ªæœˆå‰åˆ›å»ºï¼‰

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ æ”¯ä»˜è¶…æ—¶æ£€æŸ¥ âœ…

**æ–°å¢é€»è¾‘ï¼š**
```javascript
if (order.status === 'paid') {
  const now = new Date()
  const createdAt = new Date(order.createdAt)
  const hoursSinceCreated = Math.floor((now - createdAt) / (1000 * 60 * 60))

  // è¶…è¿‡24å°æ—¶ï¼Œè®¢å•å¤±æ•ˆ
  if (hoursSinceCreated > 24) {
    return {
      code: 10004,
      message: `è®¢å•å·²è¶…æ—¶${hoursSinceCreated}å°æ—¶ï¼Œæ— æ³•æ ¸é”€`
    }
  }

  // è¶…è¿‡2å°æ—¶ï¼Œè®°å½•è­¦å‘Š
  if (hoursSinceCreated > 2) {
    console.warn(`âš ï¸ è®¢å•å·²åˆ›å»º ${hoursSinceCreated} å°æ—¶`);
  }
}
```

**è§„åˆ™ï¼š**
- ğŸ“Œ **24å°æ—¶å†…**ï¼šå¯ä»¥æ­£å¸¸æ ¸é”€
- âš ï¸ **è¶…è¿‡24å°æ—¶**ï¼šè®¢å•å¤±æ•ˆï¼Œæ— æ³•æ ¸é”€
- ğŸ“ **è¶…è¿‡2å°æ—¶**ï¼šè®°å½•è­¦å‘Šæ—¥å¿—ï¼ˆä½†ä»å¯æ ¸é”€ï¼‰

---

### 2. æ·»åŠ  startTime æœ‰æ•ˆæ€§éªŒè¯ âœ…

**æ–°å¢æ£€æŸ¥ï¼š**
```javascript
// æ£€æŸ¥1ï¼šstartTime ä¸èƒ½ä¸ºç©º
if (!order.timing.startTime) {
  return {
    code: 10005,
    message: 'è®¢å•æ•°æ®å¼‚å¸¸ï¼šç¼ºå°‘å¼€å§‹æ—¶é—´'
  }
}

// æ£€æŸ¥2ï¼šstartTime å¿…é¡»æ˜¯æœ‰æ•ˆæ—¥æœŸ
const startTime = new Date(order.timing.startTime)
if (isNaN(startTime.getTime())) {
  return {
    code: 10006,
    message: 'è®¢å•æ•°æ®å¼‚å¸¸ï¼šå¼€å§‹æ—¶é—´æ— æ•ˆ'
  }
}

// æ£€æŸ¥3ï¼šstartTime å¿…é¡»åˆç†ï¼ˆä¸èƒ½æ˜¯1970å¹´ï¼‰
if (startTime.getFullYear() < 2024) {
  return {
    code: 10007,
    message: 'è®¢å•æ•°æ®å¼‚å¸¸ï¼šå¼€å§‹æ—¶é—´é”™è¯¯'
  }
}
```

---

### 3. æ·»åŠ ä½¿ç”¨æ—¶é•¿åˆç†æ€§æ£€æŸ¥ âœ…

**æ–°å¢æ£€æŸ¥ï¼š**
```javascript
const usedMinutes = Math.ceil(usedSeconds / 60)

// ä¸èƒ½è¶…è¿‡48å°æ—¶
if (usedMinutes > 48 * 60) {
  return {
    code: 10008,
    message: `ä½¿ç”¨æ—¶é•¿å¼‚å¸¸ï¼ˆ${Math.floor(usedMinutes / 60)}å°æ—¶ï¼‰`
  }
}
```

**è§„åˆ™ï¼š**
- æ­£å¸¸æ¸¸èˆ¹ä¸ä¼šè¶…è¿‡48å°æ—¶
- å¦‚æœè¶…è¿‡ï¼Œè¯´æ˜æ•°æ®å¼‚å¸¸

---

## è¶…æ—¶æœºåˆ¶æ€»ç»“

### å‘èˆ¹ï¼ˆæ ¸é”€ï¼‰è¶…æ—¶

| æ—¶é—´èŒƒå›´ | å¤„ç†æ–¹å¼ | é”™è¯¯ç  |
|----------|----------|--------|
| 0-2å°æ—¶ | âœ… æ­£å¸¸æ ¸é”€ | - |
| 2-24å°æ—¶ | âš ï¸ è­¦å‘Šä½†å…è®¸æ ¸é”€ | - |
| è¶…è¿‡24å°æ—¶ | âŒ æ‹’ç»æ ¸é”€ | 10004 |

### æ”¶èˆ¹è¶…æ—¶

| æ—¶é—´èŒƒå›´ | å¤„ç†æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| 0-48å°æ—¶ | âœ… æ­£å¸¸æ”¶èˆ¹ | è¶…æ—¶è´¹ç”¨æŒ‰å®é™…è®¡ç®— |
| è¶…è¿‡48å°æ—¶ | âŒ æ‹’ç»æ”¶èˆ¹ | æ•°æ®å¼‚å¸¸ï¼Œéœ€ç®¡ç†å‘˜å¤„ç† |

### æ•°æ®éªŒè¯

| æ£€æŸ¥é¡¹ | é”™è¯¯ç  | è¯´æ˜ |
|--------|--------|------|
| startTime ä¸ºç©º | 10005 | ç¼ºå°‘å¼€å§‹æ—¶é—´ |
| startTime æ— æ•ˆ | 10006 | æ—¥æœŸæ ¼å¼é”™è¯¯ |
| startTime < 2024 | 10007 | æ—¶é—´å¼‚å¸¸ï¼ˆ1970å¹´é—®é¢˜ï¼‰|
| ä½¿ç”¨æ—¶é•¿ > 48h | 10008 | æ—¶é•¿å¼‚å¸¸ |

---

## ä¿®å¤å½“å‰å¼‚å¸¸è®¢å•

### æ–¹æ³•1ï¼šåˆ é™¤å¼‚å¸¸è®¢å•ï¼ˆæ¨èï¼‰âœ…

**æ­¥éª¤ï¼š**
1. æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ orders é›†åˆ
2. ç­›é€‰æ¡ä»¶ï¼š`status = 'timing'` ä¸” `timing.startTime = null`
3. æ‰¾åˆ°å¼‚å¸¸è®¢å•ï¼ˆèˆ¹å·ä¸º null çš„ï¼‰
4. ç‚¹å‡»ã€åˆ é™¤ã€‘

---

### æ–¹æ³•2ï¼šä¿®æ­£æ•°æ®

**æ­¥éª¤ï¼š**
1. æ‰¾åˆ°å¼‚å¸¸è®¢å•
2. ç¼–è¾‘è®°å½•
3. ä¿®æ”¹å­—æ®µï¼š
   ```json
   {
     "status": "paid",
     "timing": {
       "startTime": null,
       "usedMinutes": 0,
       "overtimeMinutes": 0,
       "overtimeFee": 0
     },
     "boat": {
       "id": null,
       "number": null
     }
   }
   ```
4. ä¿å­˜

**æ”¹å› 'paid' çŠ¶æ€åï¼Œé‡æ–°å‘èˆ¹å³å¯ã€‚**

---

### æ–¹æ³•3ï¼šä½¿ç”¨æ•°æ®åº“å‘½ä»¤æ‰¹é‡æ¸…ç†

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ orders â†’ é«˜çº§æ“ä½œï¼š

```javascript
// æŸ¥æ‰¾å¼‚å¸¸è®¢å•
db.collection('orders').where({
  status: 'timing',
  'timing.startTime': db.command.eq(null)
}).get()

// åˆ é™¤å¼‚å¸¸è®¢å•
db.collection('orders').where({
  status: 'timing',
  'timing.startTime': db.command.eq(null)
}).remove()
```

---

## å¦‚ä½•é¿å…æ•°æ®å¼‚å¸¸

### âœ… æ­£ç¡®æµç¨‹

**å‘èˆ¹æ—¶ï¼ˆstartTrip äº‘å‡½æ•°ï¼‰ï¼š**
```javascript
await db.collection('orders').doc(orderId).update({
  data: {
    status: 'timing',
    'timing.startTime': new Date(),  // â† å¿…é¡»è®¾ç½®ï¼
    'boat.id': boatId,
    'boat.number': boatNumber
  }
})
```

**å…³é”®ï¼š**
- æ›´æ–° status æ—¶ï¼Œ**å¿…é¡»**åŒæ—¶è®¾ç½® startTime
- å¿…é¡»åŒæ—¶è®¾ç½®èˆ¹å·ä¿¡æ¯

---

### âŒ é”™è¯¯æ“ä½œ

**ä¸è¦æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“ï¼š**
```json
// âŒ é”™è¯¯ï¼šåªæ”¹çŠ¶æ€ï¼Œä¸è®¾ç½®æ—¶é—´
{
  "status": "timing"
  // ç¼ºå°‘ timing.startTimeï¼
}
```

**ä¸è¦è·³è¿‡å‘èˆ¹æµç¨‹ï¼š**
- ä¸è¦ç›´æ¥åœ¨æ•°æ®åº“æŠŠ 'paid' æ”¹ä¸º 'timing'
- å¿…é¡»é€šè¿‡ startTrip äº‘å‡½æ•°å‘èˆ¹

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šæ­£å¸¸è®¢å•ï¼ˆ2å°æ—¶å†…ï¼‰âœ…

1. åˆ›å»ºè®¢å• â†’ æ”¯ä»˜
2. 1å°æ—¶åæ‰«ç æ ¸é”€
3. é¢„æœŸï¼šæ­£å¸¸å‘èˆ¹ï¼Œæ— è­¦å‘Š

---

### æµ‹è¯•2ï¼šè¶…æ—¶è®¢å•ï¼ˆ2-24å°æ—¶ï¼‰âš ï¸

1. åˆ›å»ºè®¢å• â†’ æ”¯ä»˜
2. åœ¨æ•°æ®åº“ä¿®æ”¹ `createdAt`ï¼Œæ”¹ä¸º3å°æ—¶å‰
3. æ‰«ç æ ¸é”€
4. é¢„æœŸï¼šå¯ä»¥å‘èˆ¹ï¼Œä½†äº‘å‡½æ•°æ—¥å¿—æœ‰è­¦å‘Š

---

### æµ‹è¯•3ï¼šå¤±æ•ˆè®¢å•ï¼ˆ>24å°æ—¶ï¼‰âŒ

1. åˆ›å»ºè®¢å• â†’ æ”¯ä»˜
2. åœ¨æ•°æ®åº“ä¿®æ”¹ `createdAt`ï¼Œæ”¹ä¸º2å¤©å‰
3. æ‰«ç æ ¸é”€
4. é¢„æœŸï¼š
   ```
   é”™è¯¯ç ï¼š10004
   æç¤ºï¼šè®¢å•å·²è¶…æ—¶48å°æ—¶ï¼Œæ— æ³•æ ¸é”€
   ```

---

### æµ‹è¯•4ï¼šæ•°æ®å¼‚å¸¸è®¢å• âŒ

**åœºæ™¯Aï¼šstartTime ä¸º null**
1. å‘èˆ¹ä½† startTime = null
2. æ‰«ç æ”¶èˆ¹
3. é¢„æœŸï¼š
   ```
   é”™è¯¯ç ï¼š10005
   æç¤ºï¼šè®¢å•æ•°æ®å¼‚å¸¸ï¼šç¼ºå°‘å¼€å§‹æ—¶é—´
   ```

**åœºæ™¯Bï¼šstartTime æ˜¯1970å¹´**
1. startTime = new Date(0)
2. æ‰«ç æ”¶èˆ¹
3. é¢„æœŸï¼š
   ```
   é”™è¯¯ç ï¼š10007
   æç¤ºï¼šè®¢å•æ•°æ®å¼‚å¸¸ï¼šå¼€å§‹æ—¶é—´é”™è¯¯
   ```

**åœºæ™¯Cï¼šä½¿ç”¨æ—¶é•¿è¶…è¿‡48å°æ—¶**
1. startTime = 3å¤©å‰
2. æ‰«ç æ”¶èˆ¹
3. é¢„æœŸï¼š
   ```
   é”™è¯¯ç ï¼š10008
   æç¤ºï¼šä½¿ç”¨æ—¶é•¿å¼‚å¸¸ï¼ˆ72å°æ—¶ï¼‰
   ```

---

## ä¿®æ”¹çš„æ–‡ä»¶

### `cloudfunctions/scanCode/index.js`

**æ–°å¢åŠŸèƒ½ï¼š**
1. âœ… å‘èˆ¹æ—¶æ£€æŸ¥è®¢å•åˆ›å»ºæ—¶é—´ï¼ˆ24å°æ—¶è¶…æ—¶ï¼‰
2. âœ… æ”¶èˆ¹æ—¶éªŒè¯ startTime æœ‰æ•ˆæ€§
3. âœ… æ”¶èˆ¹æ—¶æ£€æŸ¥ä½¿ç”¨æ—¶é•¿åˆç†æ€§
4. âœ… æ–°å¢é”™è¯¯ç  10004-10008

---

## ä¸Šçº¿æ­¥éª¤

1. **ä¸Šä¼ äº‘å‡½æ•°**
   - å³é”® `scanCode` â†’ ã€ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ã€‘

2. **æ¸…ç†å¼‚å¸¸æ•°æ®**
   - åˆ é™¤æˆ–ä¿®æ­£ timing.startTime ä¸º null çš„è®¢å•

3. **æµ‹è¯•éªŒè¯**
   - æµ‹è¯•æ­£å¸¸æµç¨‹
   - æµ‹è¯•è¶…æ—¶åœºæ™¯
   - æµ‹è¯•å¼‚å¸¸æ•°æ®

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè®¢å•24å°æ—¶åä¸èƒ½æ ¸é”€ï¼Ÿ
**A:** é˜²æ­¢ç”¨æˆ·æ”¯ä»˜åé•¿æ—¶é—´ä¸ä½¿ç”¨ï¼Œå ç”¨èˆ¹åªèµ„æºã€‚

**è§£å†³ï¼š** è”ç³»ç®¡ç†å‘˜é€€æ¬¾åé‡æ–°ä¸‹å•

---

### Q2: å¦‚ä½•ä¿®æ”¹è¶…æ—¶æ—¶é—´ï¼Ÿ
**A:** ä¿®æ”¹ scanCode äº‘å‡½æ•°ç¬¬58è¡Œï¼š

```javascript
// æ”¹ä¸º48å°æ—¶
if (hoursSinceCreated > 48) {
  return { code: 10004, message: 'è®¢å•å·²è¶…æ—¶' }
}
```

---

### Q3: å¦‚æœç”¨æˆ·åœ¨æ¸¸èˆ¹æ—¶è¶…è¿‡48å°æ—¶æ€ä¹ˆåŠï¼Ÿ
**A:** æ­£å¸¸æƒ…å†µä¸ä¼šè¶…è¿‡48å°æ—¶ã€‚å¦‚æœç¡®å®è¶…è¿‡ï¼š

1. å‘˜å·¥ç«¯æ— æ³•æ‰«ç æ”¶èˆ¹ï¼ˆä¼šæç¤ºå¼‚å¸¸ï¼‰
2. éœ€è¦ç®¡ç†å‘˜åœ¨æ•°æ®åº“æ‰‹åŠ¨ç»“ç®—
3. æˆ–è”ç³»æŠ€æœ¯äººå‘˜è°ƒæ•´

---

## ç›‘æ§å»ºè®®

### 1. å®šæœŸæ£€æŸ¥å¼‚å¸¸è®¢å•
```javascript
// æŸ¥è¯¢ timing çŠ¶æ€ä½† startTime ä¸ºç©ºçš„è®¢å•
db.collection('orders').where({
  status: 'timing',
  'timing.startTime': db.command.eq(null)
}).get()
```

### 2. å®šæœŸæ£€æŸ¥è¶…æ—¶è®¢å•
```javascript
// æŸ¥è¯¢è¶…è¿‡24å°æ—¶æœªæ ¸é”€çš„è®¢å•
const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000)
db.collection('orders').where({
  status: 'paid',
  createdAt: db.command.lt(yesterday)
}).get()
```

### 3. å®šæœŸæ£€æŸ¥è¶…é•¿ä½¿ç”¨è®¢å•
```javascript
// æŸ¥è¯¢ä½¿ç”¨è¶…è¿‡12å°æ—¶çš„è®¢å•
const twelveHoursAgo = new Date(Date.now() - 12 * 60 * 60 * 1000)
db.collection('orders').where({
  status: 'timing',
  'timing.startTime': db.command.lt(twelveHoursAgo)
}).get()
```

---

**æœ€åæ›´æ–°ï¼š** 2025-02-05 02:15
