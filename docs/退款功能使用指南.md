# 退款功能使用指南

## 功能概述

退款功能支持两种方式：
1. **手动退款** - 用户主动申请退款
2. **自动退款** - 超期未核销自动退款

---

## 一、部署云函数（必须）

在微信开发者工具中，依次部署以下云函数：

### 1. refundOrder（手动退款）
- 右键 → "上传并部署：云端安装依赖"
- 功能：处理用户申请退款

### 2. refundCallback（退款回调）
- 右键 → "上传并部署：云端安装依赖"
- 功能：接收微信退款结果通知

### 3. autoRefundTask（自动退款定时任务）
- 右键 → "上传并部署：云端安装依赖"
- 功能：定时检查超期订单并自动退款

### 4. getAppConfig（更新配置读取）
- 右键 → "上传并部署：云端安装依赖"
- 功能：返回自动退款配置

---

## 二、配置定时任务（重要）

### 在云开发控制台配置定时触发器

1. 进入**云开发控制台** → **云函数** → **autoRefundTask**
2. 点击 **"定时触发器"** 标签页
3. 点击 **"添加触发器"**
4. 配置如下：

```
触发器名称：autoRefund
触发周期：自定义
Cron 表达式：0 0 2 * * * *
```

**说明：**
- `0 0 2 * * * *` 表示每天凌晨 2:00 执行
- 可以自定义时间，格式：`秒 分 时 日 月 周 年`

### Cron 表达式示例

```
0 0 2 * * * *   # 每天凌晨 2:00
0 0 */6 * * * * # 每隔 6 小时
0 30 3 * * * *  # 每天凌晨 3:30
```

---

## 三、数据库配置

### 在 app_settings 集合配置自动退款

在**云开发控制台** → **数据库** → `app_settings` 集合 → 编辑 `global_settings` 文档：

```json
{
  "_id": "global_settings",
  "autoRefundEnabled": true,  // 是否启用自动退款
  "autoRefundDays": 7,        // 超期天数（7天）
  ...
}
```

**配置说明：**
- `autoRefundEnabled`: `true` 启用 / `false` 关闭
- `autoRefundDays`: 超期天数（如 7、15、30）

**示例：**
- 设置为 7 天：购买后 7 天未核销自动退款
- 设置为 15 天：购买后 15 天未核销自动退款

---

## 四、功能使用

### 1. 手动退款（用户操作）

**用户端操作：**
1. 进入订单详情页
2. 订单状态为"已支付待核销"时，显示 **"申请退款"** 按钮
3. 点击按钮 → 弹出确认框
4. 确认后提交退款申请
5. 退款成功后，1-3 个工作日到账

**订单状态变化：**
```
已支付待核销 (paid) → 退款处理中 (refundStatus: processing) → 已退款 (refunded)
```

**退款规则：**
- ✅ 全额退款（0 手续费）
- ✅ 钱原路返回微信账户
- ✅ 仅限"已支付待核销"状态

### 2. 自动退款（系统自动）

**触发条件：**
- 订单状态为"已支付待核销"
- 订单创建时间超过 X 天（配置的天数）
- 未申请过退款

**执行流程：**
```
每天凌晨 2:00
    ↓
查询超期订单
    ↓
批量退款
    ↓
更新订单状态
    ↓
记录日志
```

**查看执行日志：**
1. 云开发控制台 → 云函数 → autoRefundTask
2. 点击"日志"查看执行记录

---

## 五、测试

### 测试手动退款

1. 创建一个测试订单并支付（建议用 0.01 元测试）
2. 进入订单详情页
3. 点击"申请退款"
4. 确认退款成功提示
5. 检查微信账户，1-3 个工作日到账

### 测试自动退款

**方式1：手动触发（推荐）**

在云开发控制台调用 `autoRefundTask` 云函数：

```json
{}
```

会立即执行一次自动退款任务，查看返回结果。

**方式2：修改订单创建时间**

在数据库中，将某个"已支付"订单的 `createdAt` 改为 8 天前：

```json
{
  "createdAt": {"$date": "2026-02-07T00:00:00.000Z"}  // 8天前
}
```

等待定时任务执行（或手动触发），该订单会被自动退款。

---

## 六、常见问题

### Q1: 退款失败怎么办？

**检查清单：**
1. ✅ 商户平台已授权退款 API
2. ✅ 订单状态为"已支付待核销"
3. ✅ 订单有有效的支付信息（outTradeNo）
4. ✅ 云函数已正确部署

**查看错误日志：**
- 云开发控制台 → 云函数 → refundOrder → 日志

### Q2: 自动退款没有执行？

**检查清单：**
1. ✅ 定时触发器已配置
2. ✅ `autoRefundEnabled` 为 `true`
3. ✅ 订单创建时间确实超过配置天数

**手动触发测试：**
直接调用 `autoRefundTask` 云函数，查看返回结果。

### Q3: 如何关闭自动退款？

在数据库 `app_settings` 中修改：

```json
{
  "autoRefundEnabled": false
}
```

### Q4: 如何修改自动退款天数？

在数据库 `app_settings` 中修改：

```json
{
  "autoRefundDays": 15  // 改为15天
}
```

修改后立即生效。

### Q5: 已核销的订单可以退款吗？

**不可以。** 退款功能仅支持"已支付待核销"状态的订单。

### Q6: 退款多久到账？

微信官方说明：1-3 个工作日原路返回支付账户。

---

## 七、订单状态说明

### 订单 status 字段

- `pending` - 待支付
- `paid` - 已支付待核销
- `timing` - 计时中
- `completed` - 已完成
- `refunded` - 已退款 ✨
- `cancelled` - 已取消

### 退款 refundStatus 字段

- `none` - 未退款
- `processing` - 退款处理中
- `success` - 退款成功
- `failed` - 退款失败

---

## 八、数据库字段说明

### orders 表新增字段

```javascript
{
  // 退款相关
  refundStatus: 'none',          // 退款状态
  refundAmount: 0,               // 退款金额（元）
  refundReason: '',              // 退款原因
  refundAt: null,                // 退款完成时间
  refundId: '',                  // 微信退款单号
  isAutoRefund: false,           // 是否自动退款
  refundFailReason: ''           // 退款失败原因
}
```

---

## 九、安全建议

1. ✅ 定期检查退款日志，防止异常退款
2. ✅ 监控自动退款任务执行情况
3. ✅ 合理设置自动退款天数（建议 7-15 天）
4. ✅ 重要操作前备份数据库

---

## 十、总结

**部署清单：**
- [x] 部署 4 个云函数
- [x] 配置定时触发器（每天凌晨 2:00）
- [x] 数据库配置自动退款（7天）
- [x] 测试手动退款
- [x] 测试自动退款

全部完成后，退款功能即可正常使用！
