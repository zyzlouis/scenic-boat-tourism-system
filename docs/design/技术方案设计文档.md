# 景区游船计时收费系统 - 技术方案设计文档

| **文档版本** | **V1.0**                     |
| ------------ | ---------------------------- |
| **文档状态** | 设计中 (In Design)           |
| **撰写人**   | 技术架构师                   |
| **创建时间** | 2026-02-04                   |
| **对应项目** | 景区游船计时收费系统 MVP     |

---

## 1. 技术选型 (Technology Stack)

### 1.1 前端技术栈

#### 用户端小程序
- **框架**: 微信原生小程序框架
- **语言**: JavaScript / WXML / WXSS
- **状态管理**: 小程序全局状态 (app.globalData)
- **UI组件**: WeUI / Vant Weapp
- **支付**: 微信支付 API (wx.requestPayment)
- **扫码**: 微信扫码 API (wx.scanCode)
- **实时通信**: WebSocket (用于计时实时更新)

#### 员工端小程序
- **框架**: 微信原生小程序框架
- **语言**: JavaScript / WXML / WXSS
- **UI组件**: WeUI / Vant Weapp
- **扫码**: 微信扫码 API (wx.scanCode)

### 1.2 后端技术栈

- **运行环境**: Node.js 18.x LTS
- **Web框架**: Express.js 4.x
- **数据库**: MySQL 8.0 (关系型数据库，确保资金事务一致性)
- **缓存**: Redis 7.x (用于订单状态缓存、计时任务)
- **ORM**: Sequelize (MySQL ORM)
- **认证**: JWT (JSON Web Token)
- **支付对接**: 微信支付 API v3
- **定时任务**: node-cron (用于超时订单处理)
- **日志**: Winston + Morgan
- **进程管理**: PM2

### 1.3 开发工具

- **版本控制**: Git
- **包管理**: npm / yarn
- **代码规范**: ESLint + Prettier
- **API文档**: Swagger / Apifox
- **数据库管理**: MySQL Workbench / Navicat
- **API测试**: Postman / Apifox

---

## 2. 系统架构设计 (System Architecture)

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        微信生态                              │
│  ┌──────────────────┐         ┌──────────────────┐         │
│  │  用户端小程序     │         │  员工端小程序     │         │
│  │  (client-user)   │         │  (client-staff)  │         │
│  └────────┬─────────┘         └────────┬─────────┘         │
│           │                             │                    │
└───────────┼─────────────────────────────┼───────────────────┘
            │                             │
            │         HTTPS / WSS         │
            ▼                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      Nginx (反向代理)                        │
└─────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Node.js 后端服务                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  API 路由层 (Express Routes)                         │  │
│  ├──────────────────────────────────────────────────────┤  │
│  │  业务逻辑层 (Services)                               │  │
│  │  - 订单服务 (OrderService)                           │  │
│  │  - 支付服务 (PaymentService)                         │  │
│  │  - 计时服务 (TimingService)                          │  │
│  │  - 核销服务 (VerificationService)                    │  │
│  ├──────────────────────────────────────────────────────┤  │
│  │  数据访问层 (Models / Sequelize ORM)                 │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
            │                             │
            ▼                             ▼
┌─────────────────────┐       ┌─────────────────────┐
│   MySQL 数据库       │       │   Redis 缓存         │
│   - 用户表           │       │   - 订单状态缓存     │
│   - 订单表           │       │   - 计时任务队列     │
│   - 船只表           │       │   - 分布式锁         │
│   - 价格配置表       │       └─────────────────────┘
└─────────────────────┘
            │
            ▼
┌─────────────────────┐
│   微信支付 API       │
│   - 下单             │
│   - 退款             │
│   - 回调             │
└─────────────────────┘
```

### 2.2 数据流设计

#### 购票流程
```
用户小程序 -> 后端 /api/order/create -> MySQL (创建订单)
                                      -> 微信支付 API (统一下单)
                                      -> 返回支付参数
用户完成支付 -> 微信支付回调 -> 后端 /api/payment/callback
                                      -> 更新订单状态
                                      -> 生成核销码
```

#### 发船流程
```
员工扫码 -> 后端 /api/verification/scan (第一次)
                                      -> 验证核销码有效性
                                      -> 弹出"输入船号"界面
员工输入船号 -> 后端 /api/verification/start
                                      -> 绑定船号
                                      -> 开始计时 (Redis 记录开始时间)
                                      -> 更新订单状态为"计时中"
                                      -> WebSocket 推送计时更新到用户端
```

#### 收船流程
```
员工扫码 -> 后端 /api/verification/scan (第二次)
                                      -> 停止计时
                                      -> 计算总时长和费用
                                      -> 展示账单预览
员工确认 -> 后端 /api/verification/end
                                      -> 计算退款金额
                                      -> 调用微信退款 API
                                      -> 更新订单状态为"已完成"
                                      -> 推送服务通知
```

---

## 3. 核心模块设计 (Core Modules)

### 3.1 计时服务 (TimingService)

**功能**: 负责游船租赁的计时逻辑

**核心方法**:
- `startTiming(orderId, boatNumber)`: 开始计时
- `stopTiming(orderId)`: 停止计时
- `getCurrentTime(orderId)`: 获取当前已用时长
- `calculateFee(orderId)`: 计算费用

**实现方案**:
```javascript
// 使用 Redis 存储计时信息
// Key: timing:order:{orderId}
// Value: {
//   startTime: timestamp,
//   boatNumber: 'E-001',
//   boatType: 'powered',
//   status: 'running'
// }

// 计费逻辑
function calculateFee(usedMinutes, pricing) {
  const { basePrice, includedMinutes, overtimeRate, capAmount } = pricing;

  if (usedMinutes <= includedMinutes) {
    return 0; // 不超时，无额外费用
  }

  const overtimeMinutes = usedMinutes - includedMinutes;
  const overtimeFee = overtimeMinutes * overtimeRate;

  // 封顶金额限制
  return Math.min(overtimeFee, capAmount);
}
```

### 3.2 支付服务 (PaymentService)

**功能**: 对接微信支付，处理支付和退款

**核心方法**:
- `createPayment(orderId, amount, openId)`: 创建支付订单
- `handleCallback(callbackData)`: 处理支付回调
- `refundDeposit(orderId, refundAmount)`: 退还押金

**关键点**:
- 使用微信支付 API v3
- 处理支付回调的幂等性
- 退款异步处理（避免阻塞用户）

### 3.3 核销服务 (VerificationService)

**功能**: 处理核销码扫描、发船、收船逻辑

**核心方法**:
- `scanCode(code, staffId)`: 扫描核销码
- `startTrip(orderId, boatNumber)`: 发船（开始计时）
- `endTrip(orderId)`: 收船（结束计时）
- `findByBoatNumber(boatNumber)`: 通过船号反查订单

**状态流转**:
```
待核销 (pending) -> 计时中 (timing) -> 已完成 (completed)
```

### 3.4 订单服务 (OrderService)

**功能**: 订单管理、状态更新

**核心方法**:
- `createOrder(userId, boatType)`: 创建订单
- `getOrderDetail(orderId)`: 获取订单详情
- `updateOrderStatus(orderId, status)`: 更新订单状态
- `getUserOrders(userId)`: 获取用户订单列表

---

## 4. 数据库设计概要 (详见数据库设计文档)

### 核心表
- `users` - 用户表
- `orders` - 订单表
- `boats` - 船只表
- `pricing_config` - 价格配置表
- `payments` - 支付记录表
- `refunds` - 退款记录表
- `staff` - 员工表
- `verification_logs` - 核销记录表

---

## 5. 接口设计概要 (详见API接口文档)

### 用户端接口
- `POST /api/auth/login` - 微信登录
- `GET /api/boats/types` - 获取船型列表
- `POST /api/order/create` - 创建订单
- `GET /api/order/:id` - 获取订单详情
- `GET /api/order/list` - 获取订单列表
- `POST /api/payment/prepay` - 发起支付
- `POST /api/payment/callback` - 支付回调（内部）

### 员工端接口
- `POST /api/staff/login` - 员工登录
- `POST /api/verification/scan` - 扫描核销码
- `POST /api/verification/start` - 开始计时（发船）
- `POST /api/verification/end` - 结束计时（收船）
- `GET /api/verification/boat/:boatNumber` - 船号反查订单
- `POST /api/verification/force-end` - 强制结束订单（管理员）

---

## 6. 安全设计 (Security Design)

### 6.1 认证与授权
- **用户端**: 微信登录 -> 换取自定义 Token (JWT)
- **员工端**: 账号密码登录 -> JWT Token，区分员工和管理员权限
- **Token过期策略**: Access Token 7天，Refresh Token 30天

### 6.2 数据安全
- **HTTPS**: 全站 HTTPS 加密传输
- **敏感信息加密**: 用户手机号、员工密码使用 bcrypt 加密存储
- **SQL注入防护**: 使用 ORM (Sequelize) 参数化查询
- **XSS防护**: 输入验证和输出转义

### 6.3 支付安全
- **微信支付签名验证**: 验证回调签名，防止伪造
- **订单幂等性**: 支付回调处理幂等，防止重复扣款/退款
- **资金一致性**: 使用数据库事务确保订单状态与支付状态一致

### 6.4 接口防刷
- **限流**: 使用 Redis 实现接口限流（如：同一IP 60秒内最多10次请求）
- **防重放**: 核销码一次性使用，扫码后立即标记为已使用

---

## 7. 性能优化 (Performance Optimization)

### 7.1 数据库优化
- **索引**: 在高频查询字段上建立索引（orderId, userId, boatNumber）
- **读写分离**: 后期可扩展为主从架构
- **连接池**: 使用数据库连接池，避免频繁建立连接

### 7.2 缓存策略
- **热点数据缓存**: 价格配置、船型列表缓存到 Redis
- **订单状态缓存**: 计时中的订单缓存到 Redis，减少数据库查询
- **缓存更新策略**: Cache-Aside 模式，更新数据库后主动删除缓存

### 7.3 并发处理
- **分布式锁**: 使用 Redis 分布式锁处理高并发下的订单创建
- **队列**: 退款操作异步处理，避免阻塞主流程
- **WebSocket连接池**: 限制单服务器 WebSocket 连接数

---

## 8. 容错设计 (Fault Tolerance)

### 8.1 网络异常处理
- **超时重试**: 微信支付接口调用失败自动重试（最多3次）
- **降级策略**: Redis 不可用时，降级为数据库查询
- **断线重连**: WebSocket 断线自动重连

### 8.2 数据一致性
- **分布式事务**: 使用 TCC 模式处理支付+订单状态更新
- **补偿机制**: 支付成功但订单状态未更新，定时任务补偿
- **日志审计**: 所有资金操作记录详细日志，便于对账和排查

### 8.3 异常订单处理
- **超时订单**: 定时任务扫描超过24小时仍在"计时中"的订单，自动结算
- **支付异常**: 支付成功但回调丢失，定时任务主动查询支付状态
- **退款失败**: 退款失败自动重试，记录到待处理队列，人工介入

---

## 9. 部署架构 (Deployment Architecture)

### 9.1 开发环境
- **本地开发**: Node.js + MySQL + Redis 本地安装
- **小程序开发**: 微信开发者工具

### 9.2 测试环境
- **云服务器**: 阿里云 / 腾讯云（1核2G起）
- **域名**: 测试域名（需备案）
- **HTTPS证书**: Let's Encrypt 免费证书

### 9.3 生产环境
- **云服务器**: 阿里云 / 腾讯云（2核4G起，可扩展）
- **负载均衡**: Nginx 反向代理
- **数据库**: RDS MySQL（主从架构）
- **缓存**: Redis 云服务
- **CDN**: 静态资源 CDN 加速
- **监控**: PM2 监控 + 日志收集（ELK）

### 9.4 CI/CD
- **版本控制**: Git + GitHub / GitLab
- **自动化部署**: GitHub Actions / Jenkins
- **发布流程**: 开发 -> 测试 -> 预发布 -> 生产

---

## 10. 项目目录结构

```
景区游船项目/
├── backend/                    # 后端服务
│   ├── src/
│   │   ├── config/            # 配置文件（数据库、Redis、微信支付等）
│   │   ├── controllers/       # 控制器层
│   │   ├── services/          # 业务逻辑层
│   │   ├── models/            # 数据模型（Sequelize）
│   │   ├── routes/            # 路由定义
│   │   ├── middlewares/       # 中间件（认证、日志、错误处理）
│   │   ├── utils/             # 工具函数
│   │   └── app.js             # Express 应用入口
│   ├── tests/                 # 单元测试
│   ├── package.json
│   └── README.md
│
├── client-user/               # 用户端小程序
│   ├── pages/                 # 页面目录
│   │   ├── index/            # 首页（船型选择）
│   │   ├── order/            # 订单详情
│   │   └── orders/           # 订单列表
│   ├── components/            # 自定义组件
│   ├── utils/                 # 工具函数
│   ├── app.js
│   ├── app.json
│   └── app.wxss
│
├── client-staff/              # 员工端小程序
│   ├── pages/
│   │   ├── scan/             # 扫码核销
│   │   ├── search/           # 船号查询
│   │   └── login/            # 员工登录
│   ├── components/
│   ├── utils/
│   ├── app.js
│   ├── app.json
│   └── app.wxss
│
└── docs/                      # 文档目录
    ├── design/                # 设计文档
    ├── api/                   # API 接口文档
    └── database/              # 数据库设计文档
```

---

## 11. 开发计划 (Development Plan)

### 阶段一：基础设施搭建（预计2-3天）
- 后端框架搭建
- 数据库设计与建表
- API 接口框架

### 阶段二：核心功能开发（预计5-7天）
- 用户端：购票、支付、订单详情
- 员工端：扫码核销、发船、收船
- 后端：订单、支付、计时服务

### 阶段三：测试与优化（预计2-3天）
- 功能测试
- 性能测试
- Bug修复

### 阶段四：部署上线（预计1-2天）
- 服务器部署
- 小程序提审
- 上线监控

---

## 12. 风险评估 (Risk Assessment)

| 风险项               | 风险等级 | 应对措施                                       |
| -------------------- | -------- | ---------------------------------------------- |
| 微信支付对接复杂     | 中       | 提前熟悉文档，准备测试账号，留足联调时间       |
| 高并发下性能瓶颈     | 中       | 压力测试，Redis缓存，数据库优化                |
| 网络不稳定导致计时误差 | 高       | 服务端计时为准，客户端仅展示；异常订单补偿机制 |
| 退款失败             | 高       | 自动重试机制，人工介入流程，详细日志记录       |
| 恶意刷单             | 中       | 实名认证、限流、风控规则                       |

---

## 13. 后续迭代计划 (Future Iterations)

### MVP 后续功能
- 管理后台 Web 端（财务报表、价格配置）
- 信用免押（对接芝麻信用）
- IoT 硬件对接（闸机、定位设备）
- 数据分析（热门时段、船只利用率）
- 营销功能（优惠券、会员卡）

---

**文档结束**

下一步请参考：
- [数据库设计文档](../database/数据库设计文档.md)
- [API接口文档](../api/API接口文档.md)
