# 紧急修复清单 - 订单详情数据显示问题

## 🔴 问题现状

**症状**：
- 订单号、船型：✅ 显示正常
- 基础票价、押金、订单总额、创建时间：❌ 显示为空

**原因分析**：
从云函数日志看，只有 `getOrderList` 被调用，**没有看到 `getOrderDetail` 被调用**

---

## ✅ 修复方案

### 方案1：确认 getOrderDetail 已部署（最可能）

**操作步骤**：

1. **重新部署 getOrderDetail**
   ```
   右键 cloudfunctions/getOrderDetail
   → 上传并部署：云端安装依赖
   ```

2. **等待部署完成**（查看控制台确认）

3. **清除缓存并重新编译**
   - 微信开发者工具 → 清缓存
   - 重新编译

4. **重新测试**
   - 创建新订单 → 支付 → 查看详情
   - 查看云函数日志，确认 getOrderDetail 被调用

---

### 方案2：检查数据库中的订单数据

**步骤**：

1. 打开云开发控制台 → 数据库
2. 选择 `orders` 集合
3. 找到测试订单（根据订单号查找）
4. 检查数据结构：

**应该有的字段**：
```json
{
  "_id": "xxx",
  "orderNo": "ORD...",
  "boatType": {
    "id": "xxx",
    "code": "DOUBLE",
    "name": "双人船"
  },
  "pricing": {
    "basePrice": 50,           // ← 检查这个
    "depositAmount": 100,      // ← 检查这个
    "includedMinutes": 60,
    "overtimeRate": 1
  },
  "totalAmount": 150,          // ← 检查这个
  "createdAt": "2026-02-04...", // ← 检查这个
  "status": "paid"
}
```

**如果缺少字段**：
说明 createOrder 或 mockPayment 云函数有问题

---

### 方案3：添加调试日志

临时在 `order-detail.js` 的 `loadOrderDetail` 方法中添加日志：

```javascript
async loadOrderDetail() {
  try {
    this.setData({ loading: true });

    console.log('🔍 开始加载订单详情，orderId:', this.data.orderId);
    const res = await cloud.getOrderDetail(this.data.orderId);
    console.log('📦 getOrderDetail 返回结果:', res);

    if (res.code === 200) {
      console.log('✅ 订单数据:', res.data);
      this.setData({
        order: res.data,
        loading: false
      });

      // ... 后续代码
    }
  } catch (error) {
    console.error('❌ 加载订单详情失败:', error);
    // ...
  }
}
```

然后查看控制台输出，看看具体返回了什么数据。

---

## 🎯 最可能的原因和解决方案

### 原因1：getOrderDetail 未部署或部署失败

**解决**：重新部署（见方案1）

### 原因2：createOrder 创建的订单数据不完整

**解决**：检查并重新部署 createOrder 云函数

### 原因3：mockPayment 没有正确保存数据

**解决**：检查并重新部署 mockPayment 云函数

---

## 📝 临时解决方案

如果上面的方案都不行，可以直接在数据库中手动修改订单数据：

1. 打开云开发控制台 → 数据库 → orders
2. 找到测试订单
3. 点击"编辑"
4. 手动添加缺失的字段：

```json
{
  "pricing": {
    "basePrice": 50,
    "depositAmount": 100,
    "includedMinutes": 60,
    "overtimeRate": 1
  },
  "totalAmount": 150
}
```

5. 保存
6. 刷新订单详情页面

---

## 🔧 立即执行的操作（按顺序）

### 第1步：构建 npm（二维码）
```
工具 → 构建 npm
```

### 第2步：重新部署 getOrderDetail
```
右键 getOrderDetail → 上传并部署
```

### 第3步：清缓存并编译
```
清缓存 → 重新编译
```

### 第4步：创建新订单测试
```
选船型 → 立即租赁 → 支付 → 查看详情
```

### 第5步：查看日志
```
云开发控制台 → 云函数 → 日志
确认 getOrderDetail 被调用
```

---

## 🆘 如果还不行

**请提供以下信息**：

1. **控制台日志截图**（完整的，包括所有错误和日志）
2. **云函数日志截图**（getOrderDetail 的调用记录）
3. **数据库订单数据截图**（选一条测试订单，显示完整的JSON）

我会根据这些信息进一步排查！
