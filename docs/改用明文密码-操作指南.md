# 改用明文密码 - 操作指南

## 已完成的修改

### 1. 云函数已改为明文密码

**修改的云函数：**
- ✅ `staffLogin` - 改为明文密码对比
- ✅ `createStaff` - 去掉密码加密
- ✅ `manageStaff` - 去掉密码加密
- ✅ `fixStaffPasswords` - 改为将加密密码改回明文

### 2. 需要部署的云函数

在微信开发者工具中，依次部署以下云函数：

1. **staffLogin**（必须）
   - 右键 → "上传并部署：云端安装依赖"

2. **createStaff**（如果使用）
   - 右键 → "上传并部署：云端安装依赖"

3. **manageStaff**（如果使用）
   - 右键 → "上传并部署：云端安装依赖"

4. **fixStaffPasswords**（必须，一次性工具）
   - 右键 → "上传并部署：云端安装依赖"

---

## 第一步：修复数据库中的加密密码

### 1. 检查哪些员工需要修复

在**云开发控制台** → **云函数** → `fixStaffPasswords` → 测试：

```json
{
  "action": "check"
}
```

**返回结果示例：**
```json
{
  "code": 200,
  "message": "检查完成",
  "data": {
    "total": 5,
    "alreadyPlainText": 0,
    "needFix": 5,
    "fixed": [
      {
        "username": "admin",
        "realName": "管理员",
        "currentPassword": "(加密)",
        "status": "need_fix"
      },
      ...
    ]
  }
}
```

### 2. 执行修复

**重要提示：**
- 加密后的密码**无法还原**
- 修复时会将所有加密密码改为统一的明文密码（默认 123456）
- 请记住这个密码，通知员工使用

**调用参数：**
```json
{
  "action": "fix",
  "defaultPassword": "123456"
}
```

**返回结果示例：**
```json
{
  "code": 200,
  "message": "修复完成",
  "data": {
    "total": 5,
    "alreadyPlainText": 0,
    "needFix": 5,
    "fixed": [
      {
        "username": "admin",
        "realName": "管理员",
        "oldPassword": "(加密)",
        "newPassword": "123456",
        "status": "fixed"
      },
      ...
    ]
  }
}
```

### 3. 通知员工

修复完成后，通知所有员工：
- **新密码统一为：123456**（或您设置的默认密码）
- 登录后建议员工自行修改密码

---

## 第二步：今后如何添加员工

### 方式1：CMS 后台直接添加（推荐）✅

在**云开发控制台** → **数据库** → `staff` 集合 → **添加记录**：

```json
{
  "username": "staff05",
  "password": "abc123",
  "realName": "王五",
  "phone": "13800138005",
  "role": "staff",
  "enabled": true,
  "lastLoginAt": null,
  "sort": 1,
  "createdAt": {"$date": "2026-02-15T00:00:00.000Z"},
  "updatedAt": {"$date": "2026-02-15T00:00:00.000Z"}
}
```

**关键字段：**
- `password`: **直接填写明文密码**，如 "abc123"
- `enabled`: 必须为 `true`
- 其他字段按需填写

员工登录时：
- 用户名：staff05
- 密码：abc123（明文）

---

### 方式2：调用云函数添加

在云开发控制台调用 `manageStaff` 云函数：

```json
{
  "action": "create",
  "staffData": {
    "username": "staff06",
    "password": "xyz789",
    "realName": "赵六",
    "phone": "13800138006",
    "role": "staff"
  }
}
```

密码会直接保存为明文 "xyz789"。

---

## 常见操作

### 1. 重置员工密码

在云开发控制台调用 `manageStaff`：

```json
{
  "action": "resetPassword",
  "staffId": "员工的_id",
  "staffData": {
    "password": "new123"
  }
}
```

### 2. 查看员工密码

在云开发控制台 → 数据库 → `staff` 集合 → 点击员工记录：
- 可以直接看到 `password` 字段的明文密码

### 3. 批量修改密码

如果需要批量将所有员工密码改为 "newpass123"：

```json
{
  "action": "fix",
  "defaultPassword": "newpass123"
}
```

这会将所有加密密码改为明文 "newpass123"。

---

## 优势

✅ **简单易用** - CMS 后台直接填写密码，无需工具
✅ **方便管理** - 可以在数据库直接查看密码
✅ **不会出错** - 不再有加密不一致的问题
✅ **易于重置** - 直接修改数据库字段即可

---

## 注意事项

⚠️ 密码以明文存储，请注意：
1. 不要在数据库截图中泄露密码
2. 建议员工登录后修改密码
3. 定期提醒员工更新密码
4. 不要使用过于简单的密码（如：123）

---

## 测试确认

修复完成后，请测试：

1. ✅ 使用新密码（123456）登录员工端
2. ✅ CMS 后台添加新员工，使用明文密码
3. ✅ 新员工可以正常登录

全部测试通过即可正常使用！
