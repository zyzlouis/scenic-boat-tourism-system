# 景区游船系统 - 员工操作手册

> 版本：v1.0
> 更新时间：2026-02-15
> 适用人员：运营人员、管理员

---

## 目录

1. [访问后台管理系统](#1-访问后台管理系统)
2. [公告管理](#2-公告管理)
3. [轮播图管理](#3-轮播图管理)
4. [船只管理](#4-船只管理)
5. [船型配置](#5-船型配置)
6. [价格配置](#6-价格配置)
7. [基础设置](#7-基础设置)
8. [订单管理](#8-订单管理)
9. [常见问题](#9-常见问题)

---

## 1. 访问后台管理系统

### 1.1 登录方式

1. 打开浏览器，访问 [微信云开发控制台](https://console.cloud.tencent.com/tcb)
2. 使用管理员提供的账号登录
3. 选择环境 ID：`cc-5gos3ctb46510316`
4. 进入 **云开发** → **内容管理（CMS）**

### 1.2 CMS 界面说明

- 左侧菜单：各个数据集合（表）
- 顶部工具栏：新建、导入、导出、刷新等操作
- 主区域：数据列表和编辑区

---

## 2. 公告管理

### 2.1 功能说明

发布景区通知、活动公告、紧急通知等信息，用户在小程序首页和公告列表中可见。

### 2.2 操作步骤

**访问路径：** CMS → announcements（公告）

#### 新建公告

1. 点击右上角 **"添加记录"**
2. 填写以下字段：

| 字段名称 | 必填 | 说明 | 示例 |
|---------|------|------|------|
| **title** | ✅ | 公告标题 | "春节营业时间调整通知" |
| **content** | ✅ | 公告内容（支持换行） | "春节期间（2月15日-2月21日）营业时间调整为：\n上午8:00 - 晚上20:00" |
| **type** | ✅ | 公告类型 | `info` 普通通知<br>`warning` 警告通知<br>`urgent` 紧急通知 |
| **showOnHome** | ✅ | 是否首页显示 | `true` 显示<br>`false` 不显示 |
| **startDate** | ✅ | 生效开始时间 | 2026-02-15 00:00:00 |
| **endDate** | ✅ | 失效结束时间 | 2026-02-21 23:59:59 |
| **sort** | ✅ | 排序权重（数字越小越靠前） | 1, 2, 3... |
| **enabled** | ✅ | 是否启用 | `true` 启用<br>`false` 禁用 |

3. 点击 **"保存"**

#### 修改公告

1. 在列表中找到目标公告
2. 点击右侧 **"编辑"** 图标
3. 修改需要的字段
4. 点击 **"保存"**

#### 删除公告

1. 在列表中找到目标公告
2. 点击右侧 **"删除"** 图标
3. 确认删除

### 2.3 注意事项

- **紧急通知（urgent）** 会在首页顶部红色高亮显示，请谨慎使用
- **生效时间** 超过 `endDate` 后公告会自动失效
- **禁用公告**（enabled=false）不会在小程序中显示
- **sort 值** 建议使用 1、2、3... 等整数，数字越小排序越靠前

### 2.4 常见场景示例

#### 场景1：发布今日暴雨停运通知

```yaml
title: "今日因暴雨暂停运营"
content: "尊敬的游客：\n\n由于今日天气恶劣，为确保游客安全，景区游船暂停运营。已购票的游客可申请全额退款。\n\n给您带来不便，敬请谅解。"
type: "urgent"
showOnHome: true
startDate: 2026-02-16 00:00:00
endDate: 2026-02-16 23:59:59
sort: 0
enabled: true
```

#### 场景2：发布节假日营业时间调整

```yaml
title: "春节营业时间调整通知"
content: "春节期间（2月15日-2月21日）营业时间调整为：\n上午8:00 - 晚上20:00\n\n祝大家新春快乐！"
type: "info"
showOnHome: false
startDate: 2026-02-10 00:00:00
endDate: 2026-02-21 23:59:59
sort: 2
enabled: true
```

---

## 3. 轮播图管理

### 3.1 功能说明

管理小程序首页顶部轮播广告图，用于展示活动、促销、景区介绍等内容。

### 3.2 操作步骤

**访问路径：** CMS → banners（轮播图）

#### 新建轮播图

1. 点击右上角 **"添加记录"**
2. 填写以下字段：

| 字段名称 | 必填 | 说明 | 示例 |
|---------|------|------|------|
| **title** | ✅ | 轮播图标题（仅后台显示） | "春节特惠活动" |
| **imageUrl** | ✅ | 图片地址 | 上传制作好的图片 |
| **linkType** | ✅ | 点击跳转类型 | `none` 不跳转<br>`page` 小程序页面<br>`web` 外部网页 |
| **linkUrl** | ⚪ | 跳转链接（linkType 不为 none 时必填） | `/pages/activity/activity` 或 `https://example.com` |
| **sort** | ✅ | 排序权重（数字越小越靠前） | 1, 2, 3... |
| **enabled** | ✅ | 是否启用 | `true` 启用<br>`false` 禁用 |

3. 点击 **"保存"**



### 3.3 注意事项

- **图片尺寸推荐：** 750px × 400px（宽高比约 1.875:1）
- **图片大小：** 建议不超过 500KB，避免加载缓慢
- **图片格式：** 支持 JPG、PNG、WebP
- **轮播顺序：** 由 `sort` 字段控制，数字越小越靠前
- **禁用轮播图** 不会在小程序中显示

---

## 4. 船只管理

### 4.1 功能说明

管理景区所有游船的基本信息、状态和可用性。

### 4.2 操作步骤

**访问路径：** CMS → boats（船只）

#### 新建船只

1. 点击右上角 **"添加记录"**
2. 填写以下字段：

| 字段名称 | 必填 | 说明 | 示例 |
|---------|------|------|------|
| **boatNumber** | ✅ | 船号（唯一标识） | "A003", "B005" |
| **boatTypeCode** | ✅ | 船型代码 | `DOUBLE` 双人船<br>`FOUR` 四人船<br>`SIX` 六人船 |
| **status** | ✅ | 船只状态 | `idle` 空闲可用<br>`inUse` 使用中<br>`maintenance` 维护中 |
| **lastUsedAt** | ⚪ | 最后使用时间（自动更新） | 2026-02-16 10:30:00 |
| **sort** | ✅ | 排序权重 | 1, 2, 3... |
| **enabled** | ✅ | 是否启用 | `true` 启用<br>`false` 禁用 |

3. 点击 **"保存"**

#### 修改船只状态

**常见场景：**

- **船只进入维护** → 修改 `船只状态` 为 维护中
- **维护完成** → 修改 `船只状态` 为 `空闲`
- **暂时停用** → 修改 `是否启用` 为 `禁用`
- **重新启用** → 修改 `是否启用` 为 `启用`

### 4.3 注意事项

- **船号** 不能重复，每艘船必须有唯一的船号
- **船型代码** 必须与"船型配置"中的 `代码（code）` 字段对应
- **船只状态（status） = 维护** 的船只不会出现在用户选船列表中
- **enabled = false** 的船只会被完全隐藏，不可用
- **最后使用时间** 由系统自动更新，无需手动修改

### 4.4 常见场景示例

#### 场景1：新增一艘双人船

```yaml
boatNumber: "A010"
boatTypeCode: "DOUBLE"
status: "idle"
sort: 10
enabled: true
```

#### 场景2：A001 号船进入维护

找到 boatNumber = "A001" 的记录，修改：
```yaml
status: "maintenance"
```

---

## 5. 船型配置

### 5.1 功能说明

配置景区提供的船型种类（如双人船、四人船、六人船）。

### 5.2 操作步骤

**访问路径：** CMS → boatTypes（船型配置）

#### 新建船型

1. 点击右上角 **"添加记录"**
2. 填写以下字段：

| 字段名称 | 必填 | 说明 | 示例 |
|---------|------|------|------|
| **code** | ✅ | 船型代码（唯一标识，大写） | "DOUBLE", "FOUR", "SIX" |
| **name** | ✅ | 船型名称 | "双人船", "四人船" |
| **description** | ⚪ | 船型描述 | "适合情侣、朋友2人乘坐" |
| **maxCapacity** | ✅ | 最大载客人数 | 2, 4, 6 |
| **imageUrl** | ⚪ | 船型图片（云存储地址） | cloud://cc-5gos3ctb46510316.xxx/boat-double.jpg |
| **sort** | ✅ | 排序权重 | 1, 2, 3... |
| **enabled** | ✅ | 是否启用 | `true` 启用<br>`false` 禁用 |

3. 点击 **"保存"**

### 5.3 注意事项

- **船型代码（code）** 一旦创建后不要修改，否则会影响"船只"和"价格配置"的关联
- **禁用船型** 会导致该船型的所有船只不可用
- 删除船型前，请确保没有船只和价格配置引用该船型

---

## 6. 价格配置

### 6.1 功能说明

配置不同船型的租赁价格、押金、包含时长、超时费率等。

### 6.2 操作步骤

**访问路径：** CMS → pricingConfigs（价格配置）

#### 新建价格方案

1. 点击右上角 **"添加记录"**
2. 填写以下字段：

| 字段名称 | 必填 | 说明 | 示例 |
|---------|------|------|------|
| **boatTypeCode** | ✅ | 船型代码（必须与船型配置中的 code 对应） | "DOUBLE", "FOUR", "SIX" |
| **name** | ✅ | 价格方案名称 | "双人船-平日价", "四人船-节假日价" |
| **basePrice** | ✅ | 基础票价（元） | 50, 80, 120 |
| **depositAmount** | ✅ | 押金金额（元） | 100, 150, 200 |
| **includedMinutes** | ✅ | 包含时长（分钟） | 60（1小时），120（2小时） |
| **overtimeRate** | ✅ | 超时费率（元/分钟） | 1.0, 1.5, 2.0 |
| **capAmount** | ✅ | 封顶金额（元，超时费用上限） | 200, 300, 400 |
| **effectiveDate** | ⚪ | 生效开始日期 | 2026-02-15（可为空，表示立即生效） |
| **expiryDate** | ⚪ | 失效结束日期 | 2026-02-21（可为空，表示永久有效） |
| **isDefault** | ✅ | 是否默认价格 | `true` 是<br>`false` 否 |
| **sort** | ✅ | 排序权重 | 1, 2, 3... |
| **enabled** | ✅ | 是否启用 | `true` 启用<br>`false` 禁用 |

3. 点击 **"保存"**

### 6.3 价格计算逻辑

用户最终费用计算公式：

```
基础票价 = basePrice
押金 = depositAmount

使用时长 <= includedMinutes：
  超时费用 = 0
  退还押金 = depositAmount
  最终费用 = basePrice

使用时长 > includedMinutes：
  超时分钟数 = 使用时长 - includedMinutes
  超时费用 = min(超时分钟数 × overtimeRate, capAmount)
  退还押金 = depositAmount - 超时费用
  最终费用 = basePrice + 超时费用
```

**示例计算：**

双人船配置：
- basePrice = 50 元
- depositAmount = 100 元
- includedMinutes = 60 分钟
- overtimeRate = 1.0 元/分钟
- capAmount = 200 元

用户使用 90 分钟：
- 超时 = 90 - 60 = 30 分钟
- 超时费用 = 30 × 1.0 = 30 元
- 退还押金 = 100 - 30 = 70 元
- 最终费用 = 50 + 30 = 80 元

### 6.4 注意事项

- **每个船型至少要有一个默认价格**（isDefault = true）
- **同一船型只能有一个 isDefault = true 的配置**
- **effectiveDate 和 expiryDate** 可用于设置节假日特殊价格
- **禁用价格配置** 会导致该船型无法下单
- **修改价格** 不会影响已有订单，只对新订单生效

### 6.5 常见场景示例

#### 场景1：新增双人船平日价格

```yaml
boatTypeCode: "DOUBLE"
name: "双人船-平日价"
basePrice: 50
depositAmount: 100
includedMinutes: 60
overtimeRate: 1.0
capAmount: 200
effectiveDate: null
expiryDate: null
isDefault: true
sort: 1
enabled: true
```

#### 场景2：新增春节特惠价（2月15日-2月21日）

```yaml
boatTypeCode: "FOUR"
name: "四人船-春节特惠"
basePrice: 68
depositAmount: 150
includedMinutes: 90
overtimeRate: 1.2
capAmount: 300
effectiveDate: 2026-02-15
expiryDate: 2026-02-21
isDefault: false
sort: 1
enabled: true
```

---

## 7. 基础设置

### 7.1 功能说明

配置小程序的全局设置，包括景区名称、联系方式、营业时间、退款规则、自动退款等。

### 7.2 操作步骤

**访问路径：** CMS → app_settings（基础设置）

**重要：** 这个集合只有一条记录（_id = "global_settings"），只需修改，不要新建或删除。

#### 修改基础设置

1. 找到 `_id = "global_settings"` 的记录
2. 点击 **"编辑"**
3. 修改以下字段：

| 字段名称 | 必填 | 说明 | 示例 |
|---------|------|------|------|
| **scenicName** | ✅ | 景区名称 | "翠屏湖景区" |
| **contactPhone** | ✅ | 客服电话 | "0593-88888888" |
| **openTime** | ✅ | 营业开始时间 | "08:00" |
| **closeTime** | ✅ | 营业结束时间 | "18:00" |
| **refundRules** | ✅ | 退款规则（支持换行） | "1. 未核销的订单可全额退款；\n2. 已核销但未发船的订单可申请退款..." |
| **safetyNotice** | ✅ | 安全须知（支持换行） | "安全须知：\n\n1. 请穿好救生衣，听从工作人员指挥；\n2. 禁止在船上站立、打闹..." |
| **aboutUs** | ✅ | 关于我们（支持换行） | "翠屏湖景区位于XX省XX市，湖面面积约500亩..." |
| **logoUrl** | ⚪ | Logo 图片 | logo.png |
| **autoRefundEnabled** | ✅ | 是否启用自动退款 | `true` 启用<br>`false` 禁用 |
| **autoRefundDays** | ✅ | 自动退款天数 | 7（表示7天后自动退款） |

4. 点击 **"保存"**

### 7.3 注意事项

- **自动退款功能：** 当 `autoRefundEnabled = true` 时，系统会在每天凌晨 2:00 自动检查超过 `autoRefundDays` 天未核销的订单并自动退款
- **修改营业时间** 会立即在小程序中生效
- **退款规则** 和 **安全须知** 支持换行符（`\n`），建议使用编辑器编辑后复制粘贴

### 7.4 常见场景示例

#### 场景1：修改营业时间

```yaml
openTime: "09:00"
closeTime: "19:00"
```

#### 场景2：关闭自动退款功能

```yaml
autoRefundEnabled: false
```

#### 场景3：将自动退款天数改为 15 天

```yaml
autoRefundDays: 15
```

---

## 8. 订单管理

### 8.1 功能说明

查看和管理所有订单，包括订单状态、退款处理等。

### 8.2 操作步骤

**访问路径：** CMS → orders（订单）

#### 查看订单

订单列表会显示所有用户创建的订单，包括以下信息：
- 订单号（orderNo）
- 用户 OpenID（_openid）
- 船型（boatTypeName）
- 船号（boatNumber）
- 订单金额（totalAmount）
- 订单状态（status）
- 退款状态（refundStatus）
- 创建时间（createdAt）

#### 订单状态说明

| 状态值 | 中文名称 | 说明 |
|--------|---------|------|
| **pending** | 待支付 | 用户已创建订单但未支付 |
| **paid** | 待核销 | 用户已支付，等待工作人员核销 |
| **verified** | 待发船 | 已核销，等待发船 |
| **timing** | 计时中 | 船只已出发，正在计时 |
| **ended** | 结算中 | 船只已归还，正在结算 |
| **completed** | 已完成 | 订单已完成结算 |
| **refunded** | 已退款 | 订单已退款 |
| **cancelled** | 已取消 | 订单已取消 |
| **timeout** | 超时异常 | 订单超时异常 |

#### 退款状态说明

| 状态值 | 中文名称 | 说明 |
|--------|---------|------|
| **none** | 未退款 | 未申请退款 |
| **processing** | 退款处理中 | 正在处理退款 |
| **success** | 退款成功 | 退款成功 |
| **failed** | 退款失败 | 退款失败 |

### 8.3 手动处理退款失败的订单

如果订单的 `refundStatus = "failed"`，可以尝试以下操作：

1. 记录订单的 `_id`
2. 进入 **云开发控制台** → **云函数** → **refundOrder**
3. 点击 **"测试"** 标签页
4. 输入以下参数：
   ```json
   {
     "orderId": "订单_id",
     "reason": "手动重试退款"
   }
   ```
5. 点击 **"运行测试"**
6. 查看返回结果，确认退款是否成功

### 8.4 注意事项

- **不要手动修改订单状态**，订单状态由系统自动管理
- **退款记录** 可以在订单中查看 `refundAmount`、`refundAt`、`refundId` 等字段
- **已完成订单** 不能退款
- **待支付订单** 超过 30 分钟会自动取消

---

## 9. 常见问题

### 9.1 轮播图上传后不显示？

**原因：**
1. `enabled` 字段设置为 `false`
2. 图片地址错误
3. 小程序缓存未刷新

**解决方法：**
1. 检查 `enabled` 字段是否为 `true`
2. 在浏览器中访问 `imageUrl`，确认图片可以正常显示
3. 在小程序中下拉刷新首页

---

### 9.2 公告发布后用户看不到？

**原因：**
1. `enabled` 字段设置为 `false`
2. `startDate` 晚于当前时间
3. `endDate` 早于当前时间
4. `showOnHome` 设置为 `false`（仅在首页不显示，公告列表可见）

**解决方法：**
1. 检查 `enabled` 是否为 `true`
2. 检查 `startDate` 和 `endDate` 时间范围是否包含当前时间
3. 如果希望在首页显示，设置 `showOnHome = true`

---

### 9.3 修改价格后用户下单价格没变？

**原因：**
1. 修改的不是 `isDefault = true` 的价格配置
2. 修改的价格配置 `enabled = false`
3. 小程序缓存未刷新

**解决方法：**
1. 确保修改的价格配置 `isDefault = true` 且 `enabled = true`
2. 让用户下拉刷新首页或重新进入小程序

---

### 9.4 船只维护后如何恢复正常？

**操作步骤：**
1. 进入 CMS → boats
2. 找到对应的船只记录
3. 修改 `status` 从 `maintenance` 改为 `idle`
4. 点击保存

---

### 9.5 如何临时停用某艘船？

**操作步骤：**
1. 进入 CMS → boats
2. 找到对应的船只记录
3. 修改 `enabled` 从 `true` 改为 `false`
4. 点击保存

**注意：** `enabled = false` 会完全隐藏该船，用户无法选择。如果只是临时维护，建议使用 `status = maintenance`。

---

### 9.6 自动退款功能如何开启/关闭？

**操作步骤：**
1. 进入 CMS → app_settings
2. 找到 `_id = "global_settings"` 的记录
3. 修改 `autoRefundEnabled`：
   - `true` = 开启自动退款
   - `false` = 关闭自动退款
4. 修改 `autoRefundDays` 设置超期天数（如 7、15、30）
5. 点击保存

---

### 9.7 如何查看自动退款执行记录？

**操作步骤：**
1. 进入 **云开发控制台** → **云函数** → **autoRefundTask**
2. 点击 **"日志"** 标签页
3. 查看最近的执行记录
4. 查找包含 "自动退款任务" 关键词的日志

---

### 9.8 数据误删除怎么办？

**预防措施：**
- 重要数据修改前先截图备份
- 删除前再次确认

**恢复方法：**
- 云开发数据库有回档功能，请联系管理员处理

---

## 10. 联系技术支持

如果遇到以下情况，请联系技术管理员：

- 云函数报错
- 订单状态异常
- 退款失败无法解决
- 数据批量操作需求
- 系统功能调整需求

---

**文档结束**

> 建议打印本手册或保存为 PDF，方便随时查阅。
