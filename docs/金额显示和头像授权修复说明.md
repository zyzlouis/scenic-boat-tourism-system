# 金额显示和头像授权修复说明

**修复时间**：2026-02-12
**修复问题**：支付页面金额不显示、充值记录余额不显示、个人中心头像授权

---

## 🐛 问题总结

### 问题1：支付页面金额不显示
- **现象**：门票价格、押金、应付金额只显示 `¥` 符号，数字部分不显示
- **原因**：`toFixed(2)` 方法调用失败（数据类型问题）

### 问题2：充值记录页面余额不显示
- **现象**：充值记录列表中，每条记录的余额只显示 `¥` 符号，数字部分不显示
- **原因**：同样是 `toFixed(2)` 方法调用失败

### 问题3：个人中心头像授权
- **现象**：点击"授权登录"按钮无法获取用户微信头像
- **原因**：使用了已废弃的 `wx.getUserProfile()` API（2021年微信官方已废弃）

---

## ✅ 修复内容

### 修复1：支付页面金额显示

**修改文件**：`client-user/pages/payment/payment.wxml`

**修改内容**：
1. 引入 WXS 格式化模块
2. 将所有 `toFixed(2)` 替换为 `format.formatMoney()`

```xml
<!-- 修复前 -->
<text class="amount-value">¥{{order.pricing.basePrice.toFixed(2)}}</text>
<text class="amount-value">¥{{order.pricing.depositAmount.toFixed(2)}}</text>
<text class="amount-value total">¥{{order.totalAmount.toFixed(2)}}</text>

<!-- 修复后 -->
<text class="amount-value">¥{{format.formatMoney(order.pricing.basePrice)}}</text>
<text class="amount-value">¥{{format.formatMoney(order.pricing.depositAmount)}}</text>
<text class="amount-value total">¥{{format.formatMoney(order.totalAmount)}}</text>
```

---

### 修复2：充值记录页面余额显示

**修改文件**：`client-user/pages/recharge-logs/recharge-logs.wxml`

**修改内容**：
1. 引入 WXS 格式化模块
2. 将所有 `toFixed(2)` 替换为 `format.formatMoney()`

```xml
<!-- 修复前 -->
<view class="log-amount">
  {{item.changeAmount > 0 ? '+' : ''}}{{item.changeAmount.toFixed(2)}}
</view>
<text class="log-balance">余额：¥{{item.afterBalance.toFixed(2)}}</text>

<!-- 修复后 -->
<view class="log-amount">
  {{item.changeAmount > 0 ? '+' : ''}}{{format.formatMoney(item.changeAmount)}}
</view>
<text class="log-balance">余额：¥{{format.formatMoney(item.afterBalance)}}</text>
```

---

### 修复3：个人中心头像授权

**修改文件**：
- `client-user/pages/profile/profile.wxml`
- `client-user/pages/profile/profile.js`
- `client-user/pages/profile/profile.wxss`

#### (1) profile.wxml - 使用新的头像授权方式

```xml
<!-- 修复前：使用废弃的 getUserProfile -->
<view class="user-header">
  <image
    class="avatar"
    src="{{userInfo ? userInfo.avatarUrl : '/images/default-avatar.png'}}"
  />
  <view class="user-info">
    <view class="nickname">{{userInfo ? userInfo.nickName : '未登录'}}</view>
    <view wx:if="{{!userInfo}}" class="login-tip">
      <van-button size="small" type="primary" bind:click="getUserProfile">授权登录</van-button>
    </view>
  </view>
</view>

<!-- 修复后：使用 button open-type="chooseAvatar" -->
<view class="user-header">
  <image
    class="avatar"
    src="{{avatarUrl || '/images/default-avatar.png'}}"
  />
  <view class="user-info">
    <view class="nickname">{{nickName || '未登录'}}</view>
    <view wx:if="{{!avatarUrl}}" class="login-tip">
      <button
        class="avatar-btn"
        open-type="chooseAvatar"
        bindchooseavatar="onChooseAvatar"
        size="small"
      >
        授权登录
      </button>
    </view>
  </view>
</view>
```

#### (2) profile.js - 新增头像选择处理

```javascript
// 修复前：使用 userInfo
data: {
  userInfo: null,
  balance: 0,
  // ...
},

async getUserProfile() {
  const { userInfo } = await wx.getUserProfile({
    desc: '用于完善会员资料'
  })
  // ...
}

// 修复后：使用 avatarUrl 和 nickName
data: {
  avatarUrl: '',
  nickName: '',
  balance: 0,
  // ...
},

// 选择头像（新方案）
onChooseAvatar(e) {
  const { avatarUrl } = e.detail
  console.log('🎭 用户选择头像:', avatarUrl)

  this.setData({
    avatarUrl,
    nickName: '微信用户' // 默认昵称
  })

  // 保存到本地存储
  wx.setStorageSync('avatarUrl', avatarUrl)
  wx.setStorageSync('nickName', '微信用户')

  wx.showToast({
    title: '授权成功',
    icon: 'success'
  })
}
```

#### (3) profile.wxss - 添加按钮样式

```css
.avatar-btn {
  padding: 8rpx 24rpx;
  font-size: 24rpx;
  background-color: #07c160;
  color: #ffffff;
  border-radius: 6rpx;
  border: none;
  line-height: 1.5;
}

.avatar-btn::after {
  border: none;
}
```

---

## 🔧 WXS 格式化模块

**文件**：`client-user/utils/format.wxs`

这是一个通用的 WXS 模块，提供安全的金额格式化功能：

```javascript
/* WXS 格式化工具 */

/* 格式化金额（保留2位小数） */
var formatMoney = function(amount) {
  if (amount == null || amount == undefined || amount == '') {
    return '0.00';
  }

  var num = parseFloat(amount);

  if (isNaN(num)) {
    return '0.00';
  }

  return num.toFixed(2);
};

module.exports = {
  formatMoney: formatMoney
};
```

**说明**：
- WXS 使用类似 ES5 的语法
- 不支持 ES6+ 特性（箭头函数、const/let、模板字符串等）
- 使用 `/* */` 注释，不使用 `//`
- 使用 `==` 而不是 `===`
- 使用 `parseFloat()` 而不是 `Number()`

---

## 📋 修改文件清单

| 序号 | 文件路径 | 修改内容 | 问题 |
|-----|---------|---------|------|
| 1 | `client-user/utils/format.wxs` | 创建 WXS 格式化模块 | 问题1、2 |
| 2 | `client-user/pages/payment/payment.wxml` | 引入 WXS，替换 toFixed(2) | 问题1 |
| 3 | `client-user/pages/recharge-logs/recharge-logs.wxml` | 引入 WXS，替换 toFixed(2) | 问题2 |
| 4 | `client-user/pages/profile/profile.wxml` | 使用 button open-type="chooseAvatar" | 问题3 |
| 5 | `client-user/pages/profile/profile.js` | 添加 onChooseAvatar 方法 | 问题3 |
| 6 | `client-user/pages/profile/profile.wxss` | 添加 avatar-btn 样式 | 问题3 |

---

## 🚀 测试步骤

### 第一步：重新编译小程序

在微信开发者工具中点击【编译】按钮，确保没有编译错误。

---

### 第二步：测试支付页面金额显示

1. **创建订单**
   - 在首页选择任意船型
   - 点击【立即租赁】创建订单
   - 自动跳转到支付页面

2. **查看金额显示**
   - ✅ **门票价格**：应显示完整金额（如 ¥50.00）
   - ✅ **押金**：应显示完整金额（如 ¥100.00）
   - ✅ **应付金额**：应显示完整金额（如 ¥150.00）

---

### 第三步：测试充值记录页面

1. **进入充值记录**
   - 点击底部 Tab【我的】
   - 点击【充值记录】

2. **查看充值记录列表**
   - ✅ 每条记录应显示完整的**变动金额**（如 +500.00）
   - ✅ 每条记录应显示完整的**余额**（如 余额：¥500.00）

---

### 第四步：测试个人中心头像授权

1. **查看初始状态**
   - 进入个人中心页面
   - 左上角显示默认头像（圆形）
   - 昵称显示"未登录"
   - 下方显示绿色按钮"授权登录"

2. **点击授权登录**
   - 点击【授权登录】按钮
   - 会弹出微信原生的头像选择器
   - 可以选择相册照片或拍照

3. **选择头像后**
   - ✅ 左上角圆形框显示用户选择的头像
   - ✅ 昵称显示"微信用户"
   - ✅ 授权登录按钮消失，显示"普通用户"或"VIP会员"标签
   - ✅ 弹出"授权成功"提示

4. **退出再进入**
   - 返回首页
   - 再次进入个人中心
   - ✅ 头像和昵称仍然保存（存储在本地）

---

## 📊 修复前后对比

### 修复前

| 功能 | 状态 | 显示内容 |
|------|------|---------|
| 支付页面-门票价格 | ❌ | ¥（空白） |
| 支付页面-押金 | ❌ | ¥（空白） |
| 支付页面-应付金额 | ❌ | ¥（空白） |
| 充值记录-变动金额 | ❌ | +（空白） |
| 充值记录-余额 | ❌ | 余额：¥（空白） |
| 个人中心-头像授权 | ❌ | 使用废弃API，无法获取头像 |

### 修复后

| 功能 | 状态 | 显示内容 |
|------|------|---------|
| 支付页面-门票价格 | ✅ | ¥50.00 |
| 支付页面-押金 | ✅ | ¥100.00 |
| 支付页面-应付金额 | ✅ | ¥150.00 |
| 充值记录-变动金额 | ✅ | +500.00 |
| 充值记录-余额 | ✅ | 余额：¥500.00 |
| 个人中心-头像授权 | ✅ | 使用新API，可正常获取头像 |

---

## 🎓 技术要点

### 1. WXS 模块使用

**优点**：
- 在视图层运行，性能更好
- 避免 JS 逻辑层和视图层频繁通信
- 处理数据格式化更可靠

**注意事项**：
- 只能使用 ES5 语法
- 不能访问 Page 或 Component 的数据
- 不能调用微信 API

---

### 2. 微信头像授权新方案

**旧方案（已废弃）**：
```javascript
wx.getUserProfile({
  desc: '用于完善会员资料'
})
```

**新方案（推荐）**：
```xml
<button open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
  选择头像
</button>
```

**区别**：
- 旧方案可以获取头像和昵称
- 新方案只能获取头像，不能获取真实昵称
- 新方案用户体验更好，不需要额外授权弹窗

---

### 3. 数据类型问题

**问题根源**：
- 数据库或云函数返回的数字可能是字符串类型
- 直接调用 `toFixed(2)` 会失败
- 页面显示为空白

**解决方案**：
1. **JavaScript 层**：使用 `Number()` 强制转换
2. **视图层**：使用 WXS 的 `parseFloat()` 转换

---

## ⚠️ 重要提醒

### 1. 关联页面检查原则

以后修改功能时，必须检查所有关联页面：
- 如果修改余额相关功能，检查：个人中心、支付页面、充值记录、订单详情
- 如果修改订单相关功能，检查：订单列表、订单详情、支付页面
- 如果修改用户信息，检查：个人中心、我的页面、订单页面

### 2. 修改后自检清单

每次修改完成后，必须自检：
- ✅ 代码是否编译通过（没有语法错误）
- ✅ 功能是否正常工作（实际测试）
- ✅ 控制台是否有报错
- ✅ 关联页面是否受影响

### 3. 常见错误记录

| 错误类型 | 典型场景 | 预防措施 |
|---------|---------|---------|
| WXS 语法错误 | 使用 ES6+ 语法 | 严格使用 ES5 语法 |
| toFixed 失败 | 数据类型不对 | 使用 WXS 或 Number() 转换 |
| API 废弃 | 使用旧版微信 API | 查阅最新官方文档 |
| 关联页面遗漏 | 只修改单个页面 | 梳理功能关联关系 |

---

**文档版本**：v1.0
**修复时间**：2026-02-12
**状态**：✅ 所有问题已修复，等待测试验证
