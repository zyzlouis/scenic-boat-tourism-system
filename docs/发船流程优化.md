# 发船流程优化说明

## 修复的问题

### 问题1：输入船号体验差 ❌

**旧流程：**
```
扫码 → 弹出输入框（包含订单信息） → 用户需要手动删除信息 → 输入船号
```

**问题：**
- `wx.showModal` 的 `editable: true` + `content` 组合使用时
- content 的文本会作为输入框的**初始值**
- 用户必须手动删除这些文字才能输入船号
- 体验极差！

**旧代码：**
```javascript
wx.showModal({
  title: '发船 - 请输入船号',
  editable: true,
  content: `游客：${data.userNickname}\n船型：${data.boatTypeName}\n包含时长：${data.includedMinutes}分钟`,
  // ↑ 这些文字会出现在输入框中！
});
```

---

### 问题2：发船后用户端不更新 ❌

**现象：**
- 员工端发船成功
- 用户端订单详情页没有任何变化
- 没有显示"计时中"状态
- 已用时长不更新

**根本原因：**
- 用户端 `order-detail.js` 缺少 `onShow` 生命周期
- 用户在支付后停留在订单详情页（状态为 "paid"）
- 员工发船后，订单变为 "timing"
- 但用户端页面不会自动刷新（除非下拉刷新）

---

## 解决方案

### 方案1：分步输入船号 ✅

**新流程：**
```
扫码 → 第1步：确认订单信息 → 第2步：纯输入框输入船号 → 发船成功
```

**新代码：**
```javascript
// 第1步：显示订单信息确认（不可编辑）
showInputBoatNumber(data) {
  wx.showModal({
    title: '📋 发船确认',
    content: `游客：${data.userNickname}\n船型：${data.boatTypeName}\n包含时长：${data.includedMinutes}分钟`,
    confirmText: '下一步',
    cancelText: '取消',
    success: (res) => {
      if (res.confirm) {
        this.showBoatNumberInput(data);  // 进入第2步
      }
    }
  });
}

// 第2步：纯输入框（无任何预填内容）
showBoatNumberInput(data) {
  wx.showModal({
    title: '🚤 请输入船号',
    editable: true,
    placeholderText: '例如: E-001 或 P-005',
    content: '',  // 空内容，保持输入框干净
    confirmText: '确认发船',
    cancelText: '返回',
    success: (res) => {
      if (res.confirm) {
        const boatNumber = (res.content || '').trim().toUpperCase();
        if (boatNumber) {
          this.startTrip(data.orderId, boatNumber);
        } else {
          // 船号为空，重新输入
          wx.showToast({
            title: '船号不能为空',
            icon: 'none'
          });
          setTimeout(() => {
            this.showBoatNumberInput(data);
          }, 2000);
        }
      } else if (res.cancel) {
        // 点击"返回"，回到第1步
        this.showInputBoatNumber(data);
      }
    }
  });
}
```

**优点：**
- ✅ 信息展示清晰
- ✅ 输入框干净，无需删除内容
- ✅ 支持返回修改
- ✅ 船号自动转大写
- ✅ 为空时自动重新输入

---

### 方案2：添加页面刷新机制 ✅

**新增生命周期方法：**

```javascript
// 页面显示时自动刷新
onShow() {
  if (this.data.orderId) {
    this.loadOrderDetail();  // 重新加载订单数据
  }
}

// 页面隐藏时停止定时器（节省资源）
onHide() {
  if (this.data.timer) {
    clearInterval(this.data.timer);
    this.setData({ timer: null });
  }
}
```

**刷新时机：**
1. ✅ 页面首次加载（`onLoad`）
2. ✅ 页面每次显示（`onShow`） ← **新增**
3. ✅ 下拉刷新（`onPullDownRefresh`）
4. ✅ 计时中每5秒自动刷新（`startTimer`）

**流程示例：**
```
用户支付 → 进入订单详情（paid）
    ↓
切换到其他页面或最小化
    ↓
员工扫码发船（paid → timing）
    ↓
用户切回订单详情页
    ↓
onShow 自动刷新 → 显示计时中状态 ✅
```

---

## 修改的文件

### 1. `client-staff/pages/scan/scan.js`

**修改内容：**
- ✅ 将 `showInputBoatNumber` 拆分为两步
- ✅ 新增 `showBoatNumberInput` 方法
- ✅ 优化输入验证和错误处理

**新增功能：**
- 两步式输入流程
- 支持返回上一步
- 船号自动转大写
- 空值自动重新输入

---

### 2. `client-user/pages/order-detail/order-detail.js`

**修改内容：**
- ✅ 新增 `onShow` 生命周期（页面显示时刷新）
- ✅ 新增 `onHide` 生命周期（页面隐藏时停止定时器）
- ✅ 优化 `startTimer` 方法（添加日志）

**新增功能：**
- 自动刷新机制
- 资源优化（隐藏时停止定时器）
- 调试日志

---

## 测试流程

### 测试1：输入船号流程 ✅

**步骤：**
1. 员工端扫描用户二维码
2. 看到第1步弹窗：显示游客信息，点击【下一步】
3. 看到第2步弹窗：纯输入框（无任何文字），输入船号（如：E-001）
4. 点击【确认发船】

**预期结果：**
- ✅ 两步流程清晰
- ✅ 输入框干净，无需删除文字
- ✅ 发船成功提示

**如果船号为空：**
- ✅ 提示"船号不能为空"
- ✅ 2秒后自动重新弹出输入框

**如果点击返回：**
- ✅ 回到第1步（订单信息确认）

---

### 测试2：用户端实时更新 ✅

**场景A：用户停留在订单详情页**
1. 用户支付后停留在订单详情页（状态：待核销）
2. 员工扫码发船
3. **用户端页面切到后台再切回来**

**预期结果：**
- ✅ `onShow` 触发，自动刷新订单数据
- ✅ 状态变为"计时中"（绿色）
- ✅ 显示"已用时长"看板
- ✅ 每5秒自动更新时长

---

**场景B：用户在其他页面**
1. 用户支付后返回首页或订单列表
2. 员工扫码发船
3. 用户再次进入订单详情页

**预期结果：**
- ✅ `onShow` 触发，加载最新数据
- ✅ 直接显示"计时中"状态
- ✅ 时长正常更新

---

**场景C：计时中切换页面**
1. 订单正在计时中（定时器运行）
2. 用户切到其他页面

**预期结果：**
- ✅ `onHide` 触发，停止定时器（节省资源）
- ✅ 用户切回时，`onShow` 重新加载数据并启动定时器

---

## 用户操作建议

### 如果用户端没有立即更新

**方法1：切换页面**
```
订单详情页 → 返回上一页 → 再次进入订单详情
```
触发 `onShow`，自动刷新

**方法2：下拉刷新**
```
在订单详情页下拉
```
手动触发刷新

**方法3：最小化再打开**
```
点击Home键 → 重新打开小程序
```
触发 `onShow`，自动刷新

---

## 技术说明

### wx.showModal 的 editable 陷阱

**错误示例：**
```javascript
wx.showModal({
  editable: true,
  content: '这是提示文字'  // ❌ 这些文字会出现在输入框中！
});
```

**正确写法：**
```javascript
// 信息展示：不可编辑
wx.showModal({
  editable: false,  // 或不设置
  content: '这是提示文字'  // ✅ 正确显示为提示
});

// 纯输入：无预填内容
wx.showModal({
  editable: true,
  content: '',  // ✅ 输入框为空
  placeholderText: '请输入...'
});
```

---

### 页面生命周期完整流程

```
用户打开页面
    ↓
  onLoad  ← 只执行一次，初始化数据
    ↓
  onShow  ← 每次显示都执行（包括首次）
    ↓
用户切走/最小化
    ↓
  onHide  ← 页面隐藏
    ↓
用户切回
    ↓
  onShow  ← 再次显示（刷新数据）
    ↓
用户关闭页面
    ↓
 onUnload ← 页面卸载，清理资源
```

**关键点：**
- `onLoad` 只执行一次
- `onShow` 每次显示都执行（**适合刷新数据**）
- `onHide` 适合停止定时器、暂停音视频等

---

## 性能优化

### 定时器管理策略

**优化前：**
- ❌ 页面隐藏时定时器仍在运行
- ❌ 浪费资源，频繁调用云函数

**优化后：**
- ✅ 页面隐藏时停止定时器（`onHide`）
- ✅ 页面显示时重新启动（`onShow`）
- ✅ 节省资源，减少云函数调用

---

**最后更新：** 2025-02-05 02:00
