# 用户授权方案说明

## 当前方案：云开发自动登录（匿名登录）

### 为什么不需要 wx.getUserProfile()？

对于游船租赁系统，我们采用了**云开发自动登录**方案：

1. **云开发会自动获取用户的 openid**
   - 无需用户授权
   - 无需获取头像和昵称
   - 用户体验更流畅

2. **openid 足够满足业务需求**
   - ✅ 创建订单并关联到用户
   - ✅ 查询用户的订单列表
   - ✅ 订单支付和退款
   - ✅ 区分不同用户

3. **符合微信小程序最佳实践**
   - 不强制用户授权
   - 降低用户流失率
   - 提升转化率

## wx.getUserProfile() 的限制

微信官方规定：
- `wx.getUserProfile()` **必须**由用户主动点击按钮触发
- 不能在弹窗回调、异步操作后调用
- 不能在小程序启动时自动弹出

**错误示例**：
```javascript
// ❌ 错误：在 showModal 回调中调用
wx.showModal({
  success: (res) => {
    if (res.confirm) {
      wx.getUserProfile()  // 会失败！
    }
  }
})

// ❌ 错误：在异步操作后调用
async function login() {
  await someAsyncOperation()
  wx.getUserProfile()  // 会失败！
}
```

**正确示例**：
```javascript
// ✅ 正确：在用户点击事件中直接调用
<button bindtap="handleLogin">授权登录</button>

handleLogin() {
  wx.getUserProfile({
    desc: '用于完善会员资料'
  })
}
```

## 当前的用户流程

### 用户端

1. **浏览船型** → 无需登录
2. **点击"立即租赁"** → 无需登录，直接创建订单
3. **支付押金** → 使用微信支付，自动关联 openid
4. **查看订单** → 使用 openid 查询

### 数据库中的用户标识

```javascript
// orders 集合
{
  _id: "xxx",
  _openid: "oABC123...",  // 云开发自动添加
  orderNo: "202402040001",
  boatType: {...},
  status: "paid"
}
```

## 如果需要用户信息怎么办？

### 场景1：显示用户昵称和头像（可选）

在"我的"页面添加一个"完善资料"按钮：

```javascript
// pages/profile/profile.wxml
<button bindtap="getUserInfo">完善个人信息</button>

// pages/profile/profile.js
getUserInfo() {
  // 用户主动点击，可以正常调用
  wx.getUserProfile({
    desc: '用于完善会员资料',
    success: (res) => {
      // 保存到数据库
      this.saveUserInfo(res.userInfo)
    }
  })
}
```

### 场景2：需要手机号（支付后验证）

使用微信官方的手机号快速验证组件：

```xml
<button open-type="getPhoneNumber" bindgetphonenumber="getPhoneNumber">
  获取手机号
</button>
```

## 优化建议

### 1. 首页流程（当前实现）
```
用户打开小程序
  ↓
浏览船型（无需登录）
  ↓
点击"立即租赁"（无需登录）
  ↓
创建订单（云开发自动获取openid）
  ↓
支付押金
  ↓
完成！
```

**优点**：
- ✅ 流程简单，转化率高
- ✅ 无需弹窗打断用户
- ✅ 符合微信规范

### 2. 如需用户信息（可选实现）

在"我的订单"页面：
```
展示订单列表
  ↓
显示"游客"（默认）
  ↓
提示：完善信息可享受会员优惠
  ↓
用户点击"完善信息"按钮
  ↓
调用 wx.getUserProfile()
  ↓
保存用户信息到 users 集合
```

## 总结

**当前方案的优势**：
1. ✅ 符合微信小程序最佳实践
2. ✅ 用户体验流畅，无打断
3. ✅ 避免 getUserProfile 调用失败
4. ✅ 满足核心业务需求

**什么时候需要改进**：
- 需要显示用户昵称和头像
- 需要建立会员体系
- 需要推送消息通知
- 需要获取用户手机号

**如何改进**：
- 在"我的"页面添加"完善资料"入口
- 让用户**主动点击按钮**授权
- 不强制要求，保持可选
