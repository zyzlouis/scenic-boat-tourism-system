# 核销码二维码集成方案

## 当前状态
✅ 页面结构已添加（order-detail.wxml）
⏸️ 使用临时方案（仅显示文字）
❌ 需要集成真正的二维码库

---

## 推荐方案：使用 weapp-qrcode

### 步骤1：安装依赖

在 `client-user` 目录下执行：

```bash
cd client-user
npm install --save weapp-qrcode
```

### 步骤2：构建 npm

在微信开发者工具中：
1. 点击菜单：工具 → 构建 npm
2. 等待构建完成

### 步骤3：修改代码

在 `pages/order-detail/order-detail.js` 中：

```javascript
// 在文件顶部引入
const QRCode = require('weapp-qrcode');

// 修改 generateQRCode 方法
generateQRCode(text) {
  const qrcode = new QRCode('qrcode', {
    text: text,
    width: 200,
    height: 200,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  });
}
```

---

## 备选方案1：使用 wxacode（推荐）⭐

使用微信小程序码（更专业）

### 创建云函数 generateWXACode

```javascript
// cloudfunctions/generateWXACode/index.js
const cloud = require('wx-server-sdk')
cloud.init()

exports.main = async (event, context) => {
  const { scene } = event

  try {
    const result = await cloud.openapi.wxacode.getUnlimited({
      scene: scene,  // 核销码
      page: 'pages/order-detail/order-detail'
    })

    return {
      code: 200,
      data: {
        buffer: result.buffer
      }
    }
  } catch (err) {
    return {
      code: 500,
      message: err.message
    }
  }
}
```

然后在页面中：

```javascript
async generateQRCode(verificationCode) {
  const res = await wx.cloud.callFunction({
    name: 'generateWXACode',
    data: { scene: verificationCode }
  })

  // 将 buffer 转为临时文件路径
  const fs = wx.getFileSystemManager()
  const filePath = `${wx.env.USER_DATA_PATH}/qrcode.png`

  fs.writeFile({
    filePath: filePath,
    data: res.result.data.buffer,
    encoding: 'binary',
    success: () => {
      this.setData({ qrcodePath: filePath })
    }
  })
}
```

---

## 备选方案2：在线 API

使用在线二维码生成 API（不推荐，依赖网络）

```javascript
generateQRCode(text) {
  const qrcodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(text)}`

  this.setData({
    qrcodeUrl: qrcodeUrl
  })
}
```

WXML:
```xml
<image src="{{qrcodeUrl}}" class="qrcode-image" />
```

---

## 最快方案：直接下载 weapp-qrcode.js ⚡

### 1. 下载文件

从这里下载：https://github.com/yingye/weapp-qrcode/blob/master/dist/weapp-qrcode.js

### 2. 放到项目中

```
client-user/
└── utils/
    └── weapp-qrcode.js
```

### 3. 在 order-detail.js 中引入

```javascript
const QRCode = require('../../utils/weapp-qrcode.js');
```

### 4. 使用

```javascript
generateQRCode(text) {
  new QRCode('qrcode', {
    text: text,
    width: 200,
    height: 200,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  });
}
```

---

## 我的建议 ⭐

**立即使用：方案3（直接下载文件）**
- 优点：最快，不需要npm，不需要构建
- 缺点：需要手动下载一个文件

**长期使用：方案1（weapp-qrcode npm包）**
- 优点：专业，易维护
- 缺点：需要npm环境

---

## 当前临时方案的问题

现在代码中只是用 canvas 绘制了文字，不是真正的二维码。
这个临时方案可以让您看到页面布局，但**无法扫描**。

---

## 需要我帮您做什么？

1. **方案A**：我帮您下载 weapp-qrcode.js 文件并集成（推荐）
2. **方案B**：您自己安装 npm 包
3. **方案C**：先用临时方案，后续再升级

**请告诉我您选择哪个方案，我立即帮您完成！**
