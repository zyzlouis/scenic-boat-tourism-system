# 取消订单功能开发说明

**开发时间**：2026-02-12
**功能**：待支付订单取消功能

---

## 📋 需求分析

### 用户痛点
- 用户点击船型后立即创建订单
- 如果点错了会生成待支付订单
- 之前无法取消，导致订单列表堆积很多无用订单

### 解决方案
- 只有待支付（pending）状态的订单可以取消
- 同时在订单详情页和支付页面提供取消功能
- 取消需要二次确认，防止误操作
- 取消后订单状态变为 cancelled，仍然显示在订单列表中

---

## ✅ 功能实现

### 1. 创建取消订单云函数

**文件**：`cloudfunctions/cancelOrder/index.js`

**功能**：
- 验证订单存在性
- 验证用户权限（只能取消自己的订单）
- 验证订单状态（只有待支付可以取消）
- 更新订单状态为 cancelled
- 记录取消时间 cancelledAt

**代码逻辑**：
```javascript
// 1. 查询订单
const { data: order } = await db.collection('orders').doc(orderId).get()

// 2. 验证是否是订单所有者
if (order._openid !== wxContext.OPENID) {
  return { success: false, message: '无权操作此订单' }
}

// 3. 验证订单状态（只有待支付状态可以取消）
if (order.status !== 'pending') {
  return { success: false, message: '只有待支付的订单可以取消' }
}

// 4. 更新订单状态为 cancelled
await db.collection('orders').doc(orderId).update({
  data: {
    status: 'cancelled',
    cancelledAt: new Date(),
    updatedAt: new Date()
  }
})
```

---

### 2. 订单详情页添加取消按钮

#### (1) 修改 WXML

**文件**：`client-user/pages/order-detail/order-detail.wxml`

**修改内容**：
1. 添加取消状态的提示文字
2. 底部操作栏添加"取消订单"按钮

```xml
<!-- 状态描述 -->
<view class="status-desc">
  <text wx:if="{{order.status === 'pending'}}">请尽快完成支付</text>
  <text wx:if="{{order.status === 'cancelled'}}">订单已取消</text>
  <!-- ... -->
</view>

<!-- 操作按钮 -->
<view class="action-bar">
  <van-button
    wx:if="{{order.status === 'pending'}}"
    type="default"
    size="large"
    round
    bindtap="cancelOrder"
    custom-class="cancel-btn"
  >
    取消订单
  </van-button>
  <van-button
    wx:if="{{order.status === 'pending'}}"
    type="primary"
    size="large"
    round
    bindtap="gotoPayment"
    custom-class="pay-btn"
  >
    去支付
  </van-button>
</view>
```

#### (2) 修改 JS

**文件**：`client-user/pages/order-detail/order-detail.js`

**新增方法**：
```javascript
async cancelOrder() {
  // 1. 弹出确认弹窗
  const result = await wx.showModal({
    title: '确认取消订单？',
    content: '取消后此订单将无法恢复',
    confirmText: '确认取消',
    cancelText: '我再想想',
    confirmColor: '#f44336'
  });

  if (!result.confirm) {
    return;
  }

  // 2. 显示 loading
  wx.showLoading({
    title: '取消中...',
    mask: true
  });

  // 3. 调用云函数
  const res = await wx.cloud.callFunction({
    name: 'cancelOrder',
    data: {
      orderId: this.data.orderId
    }
  });

  // 4. 处理结果
  if (res.result.success) {
    wx.showToast({
      title: '订单已取消',
      icon: 'success',
      duration: 2000
    });

    // 5. 延迟返回订单列表
    setTimeout(() => {
      wx.navigateBack();
    }, 2000);
  }
}
```

#### (3) 修改 WXSS

**文件**：`client-user/pages/order-detail/order-detail.wxss`

**添加样式**：
```css
.action-bar {
  display: flex;
  gap: 20rpx;
}

.cancel-btn {
  flex: 1;
}

.pay-btn {
  flex: 1;
}
```

---

### 3. 支付页面添加取消链接

#### (1) 修改 WXML

**文件**：`client-user/pages/payment/payment.wxml`

**修改内容**：
在支付按钮上方添加"取消订单"文字链接

```xml
<view class="footer">
  <view class="cancel-link" bindtap="cancelOrder">
    <text>取消订单</text>
  </view>
  <van-button type="primary" size="large" round block bind:click="doPay">
    立即支付
  </van-button>
</view>
```

#### (2) 修改 JS

**文件**：`client-user/pages/payment/payment.js`

**新增方法**：
```javascript
async cancelOrder() {
  // 确认弹窗
  const result = await wx.showModal({
    title: '确认取消订单？',
    content: '取消后此订单将无法恢复',
    confirmText: '确认取消',
    cancelText: '我再想想',
    confirmColor: '#f44336'
  })

  if (!result.confirm) {
    return
  }

  // 调用云函数
  const res = await wx.cloud.callFunction({
    name: 'cancelOrder',
    data: {
      orderId: this.data.order._id
    }
  })

  if (res.result.success) {
    wx.showToast({
      title: '订单已取消',
      icon: 'success'
    })

    // 返回订单列表
    setTimeout(() => {
      wx.switchTab({
        url: '/pages/order-list/order-list'
      })
    }, 2000)
  }
}
```

#### (3) 修改 WXSS

**文件**：`client-user/pages/payment/payment.wxss`

**添加样式**：
```css
.cancel-link {
  text-align: center;
  padding: 20rpx 0;
  margin-bottom: 16rpx;
}

.cancel-link text {
  font-size: 28rpx;
  color: #999999;
  text-decoration: underline;
}
```

---

### 4. filters.wxs 已支持 cancelled 状态

**文件**：`client-user/utils/filters.wxs`

已经定义了 cancelled 状态：
- 状态文本：`已取消`
- 状态颜色：`#f44336`（红色）

订单列表页面会自动显示已取消的订单。

---

## 📊 功能流程图

### 订单详情页取消流程
```
用户进入订单详情页（pending 状态）
  ↓
查看订单信息
  ↓
点击【取消订单】按钮
  ↓
弹出确认弹窗
  ├─ 点击【我再想想】→ 关闭弹窗，不做任何操作
  └─ 点击【确认取消】
      ↓
  显示"取消中..."loading
      ↓
  调用 cancelOrder 云函数
      ↓
  订单状态更新为 cancelled
      ↓
  显示"订单已取消"提示
      ↓
  2秒后自动返回订单列表
```

### 支付页面取消流程
```
用户进入支付页面
  ↓
查看支付金额
  ↓
点击【取消订单】文字链接
  ↓
弹出确认弹窗
  ├─ 点击【我再想想】→ 关闭弹窗，继续支付
  └─ 点击【确认取消】
      ↓
  调用 cancelOrder 云函数
      ↓
  显示"订单已取消"提示
      ↓
  2秒后跳转到订单列表
```

---

## 🎨 界面设计

### 订单详情页底部按钮布局

```
┌──────────────────────────────────────┐
│                                      │
│  ┌──────────┐  ┌──────────┐         │
│  │ 取消订单  │  │   去支付  │         │
│  │  (灰色)  │  │  (蓝色)  │         │
│  └──────────┘  └──────────┘         │
│                                      │
└──────────────────────────────────────┘
```

- 左边：取消订单按钮（次要按钮，灰色）
- 右边：去支付按钮（主要按钮，蓝色）
- 两个按钮宽度相同，均匀分布

### 支付页面底部布局

```
┌──────────────────────────────────────┐
│                                      │
│          取消订单（下划线）            │
│                                      │
│  ┌────────────────────────────────┐ │
│  │         立即支付                │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

- 上方：取消订单文字链接（灰色，有下划线）
- 下方：立即支付按钮（主要按钮，蓝色，圆角）

---

## 🔧 技术实现细节

### 1. 订单状态流转

```
pending (待支付)
  ├─→ paid (用户支付成功)
  └─→ cancelled (用户主动取消) ✅ 新增
```

### 2. 取消权限控制

**只有满足以下条件才能取消**：
1. ✅ 订单存在
2. ✅ 是订单所有者（_openid 匹配）
3. ✅ 订单状态为 pending

**以下情况不能取消**：
- ❌ 订单不存在
- ❌ 不是订单所有者
- ❌ 订单已支付（paid）
- ❌ 订单已核销（verified）
- ❌ 订单计时中（timing）
- ❌ 订单已完成（completed）
- ❌ 订单已取消（cancelled）

### 3. 二次确认机制

使用 `wx.showModal()` 实现二次确认：
- 标题：确认取消订单？
- 内容：取消后此订单将无法恢复
- 取消按钮：我再想想（灰色）
- 确认按钮：确认取消（红色 #f44336）

### 4. 取消后的处理

#### 订单详情页
- 使用 `wx.navigateBack()` 返回上一页
- 通常是订单列表页

#### 支付页面
- 使用 `wx.switchTab()` 跳转到订单列表
- 因为订单列表在 TabBar 中

---

## 📋 修改文件清单

| 序号 | 文件路径 | 修改内容 |
|-----|---------|---------|
| 1 | `cloudfunctions/cancelOrder/index.js` | 创建取消订单云函数 |
| 2 | `cloudfunctions/cancelOrder/package.json` | 云函数依赖配置 |
| 3 | `client-user/pages/order-detail/order-detail.wxml` | 添加取消按钮和状态提示 |
| 4 | `client-user/pages/order-detail/order-detail.js` | 添加 cancelOrder 方法 |
| 5 | `client-user/pages/order-detail/order-detail.wxss` | 添加按钮布局样式 |
| 6 | `client-user/pages/payment/payment.wxml` | 添加取消链接 |
| 7 | `client-user/pages/payment/payment.js` | 添加 cancelOrder 方法 |
| 8 | `client-user/pages/payment/payment.wxss` | 添加取消链接样式 |

**说明**：
- `filters.wxs` 已支持 cancelled 状态，无需修改
- `order-list` 订单列表页无需修改，自动显示已取消订单

---

## 🚀 部署步骤

### 第一步：部署云函数

1. 在微信开发者工具中找到 `cloudfunctions/cancelOrder`
2. 右键点击，选择【上传并部署：云端安装依赖】
3. 等待部署完成

### 第二步：重新编译小程序

在微信开发者工具中点击【编译】按钮

---

## 🧪 测试步骤

### 测试场景1：订单详情页取消订单

1. **创建待支付订单**
   - 在首页选择任意船型
   - 点击【立即租赁】
   - 自动跳转到支付页面
   - 点击左上角返回，回到订单列表

2. **进入订单详情**
   - 在订单列表中点击刚创建的订单
   - 进入订单详情页

3. **查看取消按钮**
   - ✅ 底部应该显示两个按钮：【取消订单】和【去支付】
   - ✅ 取消订单按钮在左边，灰色
   - ✅ 去支付按钮在右边，蓝色

4. **点击取消订单**
   - 点击【取消订单】按钮
   - ✅ 弹出确认弹窗
   - ✅ 标题：确认取消订单？
   - ✅ 内容：取消后此订单将无法恢复
   - ✅ 左边按钮：我再想想
   - ✅ 右边按钮：确认取消（红色）

5. **测试取消流程**
   - 先点击【我再想想】，弹窗关闭，订单不变
   - 再次点击【取消订单】
   - 点击【确认取消】
   - ✅ 显示"取消中..."loading
   - ✅ 显示"订单已取消"提示
   - ✅ 2秒后自动返回订单列表

6. **验证订单状态**
   - 在订单列表中找到刚取消的订单
   - ✅ 状态显示：已取消（红色）
   - 点击进入订单详情
   - ✅ 状态卡片显示：已取消（红色背景）
   - ✅ 状态描述：订单已取消
   - ✅ 底部不显示任何操作按钮

---

### 测试场景2：支付页面取消订单

1. **创建新的待支付订单**
   - 在首页选择船型
   - 进入支付页面

2. **查看取消链接**
   - ✅ 支付按钮上方显示"取消订单"文字链接
   - ✅ 文字为灰色，有下划线

3. **点击取消订单**
   - 点击"取消订单"文字链接
   - ✅ 弹出确认弹窗（同上）

4. **完成取消**
   - 点击【确认取消】
   - ✅ 显示"订单已取消"提示
   - ✅ 2秒后跳转到订单列表
   - ✅ 订单状态为"已取消"

---

### 测试场景3：已支付订单不能取消

1. **创建并支付订单**
   - 创建订单并完成支付（余额支付或微信支付）

2. **进入订单详情**
   - ✅ 底部不显示【取消订单】按钮
   - ✅ 只显示核销码

3. **尝试通过云函数取消（安全测试）**
   - 在控制台手动调用 cancelOrder 云函数
   - ✅ 返回错误：只有待支付的订单可以取消

---

## 📊 数据库变化

### orders 集合新增字段

| 字段名 | 类型 | 说明 |
|-------|------|------|
| cancelledAt | Date | 订单取消时间（仅 cancelled 状态有值） |

### 订单状态值

| 状态值 | 说明 | 显示文本 | 颜色 |
|-------|------|---------|------|
| pending | 待支付 | 待支付 | #ff9800 橙色 |
| paid | 已支付 | 待核销 | #2196f3 蓝色 |
| cancelled | 已取消 | 已取消 | #f44336 红色 ✅ |
| timing | 计时中 | 计时中 | #4caf50 绿色 |
| completed | 已完成 | 已完成 | #9e9e9e 灰色 |

---

## ⚠️ 注意事项

### 1. 取消后订单仍显示在列表中
- 用户选择：显示在列表中，标记为"已取消"状态
- 便于用户查看历史记录
- 可以在订单详情查看取消的订单信息

### 2. 取消操作不可逆
- 一旦取消，无法恢复为待支付状态
- 用户需要重新创建订单

### 3. 只有待支付订单可以取消
- 已支付、计时中、已完成的订单不能取消
- 云函数会验证订单状态

### 4. 需要二次确认
- 防止用户误操作
- 确认按钮为红色，突出警示

---

## 🎯 用户价值

1. **避免误操作**
   - 点错船型可以立即取消
   - 不会堆积无用订单

2. **提升体验**
   - 操作简单，一键取消
   - 同时在两个页面提供取消入口

3. **数据可追溯**
   - 取消的订单仍然保留
   - 可以查看取消的订单历史

---

**文档版本**：v1.0
**开发时间**：2026-02-12
**状态**：✅ 开发完成，等待部署测试
