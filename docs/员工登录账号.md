# 员工端登录账号说明

## 当前可用账号

根据数据库 `staff` 集合的数据：

### 管理员账号
```
用户名：ADMIN001（员工编号）
或者：13800000000（手机号）
密码：admin123
```

**字段对应关系：**
- 用户名可以使用：`staffNo`（员工编号）或 `phone`（手机号）
- 密码使用：`password` 字段

---

## 修复内容

### 问题1：字段不匹配
**旧代码：** 云函数查询 `username` 字段，但数据库没有这个字段

**新代码：** 支持使用 `staffNo` 或 `phone` 登录
```javascript
db.collection('staff').where(db.command.or([
  { staffNo: username, isActive: true, isDeleted: false },
  { phone: username, isActive: true, isDeleted: false }
]))
```

### 问题2：硬编码密码
**旧代码：** 密码硬编码为 `admin/admin123`，根本不读数据库

**新代码：** 使用数据库的 `password` 字段验证
```javascript
const isPasswordValid = password === staff.password
```

---

## 使用步骤

### 1. 上传云函数
在微信开发者工具中：
1. 找到 `cloudfunctions/staffLogin` 文件夹
2. 右键 → 选择【上传并部署：云端安装依赖】
3. 等待上传完成

### 2. 登录测试
在员工小程序登录页面输入：
- **用户名：** `ADMIN001` 或 `13800000000`
- **密码：** `admin123`

### 3. 如果还是登录失败
检查云函数日志：
1. 打开云开发控制台
2. 点击【云函数】
3. 找到 `staffLogin` 函数
4. 点击【日志】查看错误信息

---

## 添加新员工账号

在数据库 `staff` 集合中添加记录：

```json
{
  "staffNo": "STAFF001",
  "name": "张三",
  "password": "123456",
  "phone": "13800000001",
  "role": "staff",
  "isActive": true,
  "isDeleted": false,
  "createdAt": new Date()
}
```

**登录时：**
- 用户名：`STAFF001` 或 `13800000001`
- 密码：`123456`

---

## 安全建议

### ⚠️ 当前问题
- 密码明文存储（不安全）
- 密码直接比对（不安全）

### ✅ 生产环境改进
1. 使用 bcrypt 加密密码
2. 添加登录失败次数限制
3. 添加验证码功能
4. 使用 JWT Token

### 密码加密示例（生产环境）
```javascript
// 注册时加密
const bcrypt = require('bcryptjs');
const hashedPassword = await bcrypt.hash('admin123', 10);

// 登录时验证
const isValid = await bcrypt.compare(inputPassword, staff.password);
```

---

## 数据库字段说明

### staff 集合字段
| 字段 | 类型 | 说明 | 必填 |
|------|------|------|------|
| staffNo | String | 员工编号（登录用） | ✅ |
| name | String | 真实姓名 | ✅ |
| password | String | 登录密码 | ✅ |
| phone | String | 手机号（登录用） | ✅ |
| role | String | 角色（admin/staff） | ✅ |
| isActive | Boolean | 是否启用 | ✅ |
| isDeleted | Boolean | 是否删除 | ✅ |
| createdAt | Date | 创建时间 | ✅ |
| lastLoginAt | Date | 最后登录时间 | - |
| updatedAt | Date | 更新时间 | - |

---

**最后更新：** 2025-02-05 01:35
