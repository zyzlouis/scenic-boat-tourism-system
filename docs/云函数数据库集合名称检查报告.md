# 云函数数据库集合名称检查报告

## 检查时间
2024-02-04 17:35

## 问题说明
之前代码中存在数据库集合名称错误：
- ❌ `pricingConfig`（错误，没有s）
- ✅ `pricingConfigs`（正确，有s）

## 已修复的云函数

### 1. getBoatTypes ✅
- **文件**：`cloudfunctions/getBoatTypes/index.js`
- **问题**：第22行 `collection('pricingConfig')`
- **状态**：✅ 已修复为 `pricingConfigs`
- **部署状态**：✅ 已重新部署

### 2. createOrder ✅
- **文件**：`cloudfunctions/createOrder/index.js`
- **问题**：第67行 `collection('pricingConfig')`
- **状态**：✅ 已修复为 `pricingConfigs`
- **部署状态**：⏳ 待部署

## 所有云函数集合名称检查

### ✅ createOrder
- boatTypes ✓
- pricingConfigs ✓
- orders ✓

### ✅ endTrip
- orders ✓
- boats ✓
- verificationLogs ✓

### ✅ findByBoatNumber
- orders ✓
- users ✓

### ✅ getBoatTypes
- boatTypes ✓
- pricingConfigs ✓

### ✅ getOrderDetail
- orders ✓

### ✅ getPendingOrders
- orders ✓
- users ✓

### ✅ scanCode
- orders ✓
- users ✓

### ✅ staffLogin
- staff ✓

### ✅ startTrip
- boats ✓
- orders ✓
- verificationLogs ✓

## 数据库集合清单

以下是系统使用的所有集合名称（标准）：

| 集合名称 | 说明 | 使用的云函数 |
|---------|------|-------------|
| boatTypes | 船型表 | getBoatTypes, createOrder |
| pricingConfigs | 计费配置表 | getBoatTypes, createOrder |
| boats | 船只表 | startTrip, endTrip |
| orders | 订单表 | createOrder, scanCode, startTrip, endTrip, getOrderDetail, findByBoatNumber, getPendingOrders |
| users | 用户表 | scanCode, findByBoatNumber, getPendingOrders |
| staff | 员工表 | staffLogin |
| verificationLogs | 核销记录表 | startTrip, endTrip |

## 检查结论

✅ **所有云函数的集合名称已检查完毕，均正确无误**

## 待办事项

- [x] 修复 getBoatTypes
- [x] 修复 createOrder
- [ ] 重新部署 createOrder 云函数
- [ ] 测试完整流程

## 问题根源分析

### 为什么会出现这个问题？

1. **数据库设计文档中使用的是复数形式**：`pricingConfigs`
2. **代码编写时部分云函数使用了单数形式**：`pricingConfig`
3. **缺少统一的命名规范检查机制**

### 如何避免类似问题？

1. ✅ 使用本检查报告作为标准
2. ✅ 每次修改集合查询时，对照此文档
3. ✅ 部署前在云开发控制台确认集合名称
4. ✅ 添加云函数单元测试（未来优化）

## 错误日志示例

```
Error: collection.get:fail -502005 database collection not exists.
[ResourceNotFound] Db or Table not exist: pricingConfig.
```

**解读**：尝试查询 `pricingConfig` 集合，但数据库中只有 `pricingConfigs` 集合。

## 最后检查清单

在部署任何云函数前，请检查：
- [ ] 集合名称是否完全匹配数据库中的名称
- [ ] 字段名称是否与数据库设计一致
- [ ] 查询条件中的字段是否存在
- [ ] 返回数据的字段映射是否正确
