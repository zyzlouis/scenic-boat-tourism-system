# 登录转圈问题修复说明

## 问题现象

登录成功后，按钮一直显示"登录中..."转圈状态，无法跳转到主页。

控制台显示：
```
✅ 员工登录成功
{_id: "...", staffNo: "ADMIN001", realName: "管理员", ...}
```

---

## 问题根源

### ❌ 错误代码
```javascript
// login.js
wx.switchTab({
  url: '/pages/scan/scan'
});
```

### ⚠️ 为什么失败？

**`wx.switchTab()` 的限制：**
- 只能跳转到 tabBar 页面
- 目标页面必须在 `app.json` 的 `tabBar` 配置中定义

**当前问题：**
- `app.json` 中没有配置 `tabBar`
- `/pages/scan/scan` 不是 tabBar 页面
- 因此 `wx.switchTab()` 调用失败，页面无法跳转
- 但 `loading` 状态没有被重置，所以一直转圈

---

## 解决方案

### ✅ 正确代码
```javascript
// 使用 wx.reLaunch() 代替
wx.reLaunch({
  url: '/pages/scan/scan'
});
```

### 微信小程序跳转方法对比

| 方法 | 用途 | 限制 | 返回栈 |
|------|------|------|--------|
| `wx.switchTab` | 跳转到 tabBar 页面 | **必须是 tabBar 页面** | 清空 |
| `wx.reLaunch` | 关闭所有页面，打开新页面 | 无 | 清空 |
| `wx.redirectTo` | 关闭当前页面，跳转新页面 | 不能跳转 tabBar | 不增加 |
| `wx.navigateTo` | 保留当前页面，跳转新页面 | 不能跳转 tabBar，最多10层 | 增加 |
| `wx.navigateBack` | 返回上一页 | 必须有上一页 | 减少 |

### 选择 `wx.reLaunch` 的原因

1. ✅ 清空所有页面栈（登录后应该清空之前的页面）
2. ✅ 无需 tabBar 配置
3. ✅ 适合登录跳转场景

---

## 修改的文件

### `client-staff/pages/login/login.js`

**修改1：onLoad 中的跳转**
```javascript
// ❌ 旧代码
if (app.checkLogin()) {
  wx.switchTab({
    url: '/pages/scan/scan'
  });
}

// ✅ 新代码
if (app.checkLogin()) {
  wx.reLaunch({
    url: '/pages/scan/scan'
  });
}
```

**修改2：登录成功后的跳转**
```javascript
// ❌ 旧代码
setTimeout(() => {
  wx.switchTab({
    url: '/pages/scan/scan'
  });
}, 1000);

// ✅ 新代码
setTimeout(() => {
  wx.reLaunch({
    url: '/pages/scan/scan'
  });
}, 1500);
```

---

## 测试步骤

### 第1步：重新编译
点击微信开发者工具的【编译】按钮

### 第2步：登录测试
- 用户名：`ADMIN001`
- 密码：`admin123`
- 点击【登录】

### 第3步：验证结果
- ✅ 显示"登录成功"提示
- ✅ 1.5秒后自动跳转到扫码页面
- ✅ 按钮不再一直转圈

---

## 如果还需要 TabBar

如果以后需要底部导航栏，可以在 `app.json` 中添加：

```json
{
  "tabBar": {
    "color": "#7A7E83",
    "selectedColor": "#07c160",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/scan/scan",
        "text": "扫码",
        "iconPath": "images/scan.png",
        "selectedIconPath": "images/scan-active.png"
      },
      {
        "pagePath": "pages/orders/orders",
        "text": "订单",
        "iconPath": "images/order.png",
        "selectedIconPath": "images/order-active.png"
      },
      {
        "pagePath": "pages/search/search",
        "text": "查询",
        "iconPath": "images/search.png",
        "selectedIconPath": "images/search-active.png"
      }
    ]
  }
}
```

**注意：** 添加 tabBar 后需要：
1. 准备图标文件（40×40px）
2. 所有 tabBar 页面都不能使用 `wx.redirectTo` 或 `wx.navigateTo` 跳转
3. 登录跳转可以使用 `wx.switchTab` 了

---

## 常见错误

### 错误1：navigateTo 跳转 tabBar 失败
```javascript
// ❌ 错误
wx.navigateTo({
  url: '/pages/scan/scan'  // 如果 scan 是 tabBar 页面
});
```

**解决：** 使用 `wx.switchTab`

### 错误2：switchTab 跳转非 tabBar 失败
```javascript
// ❌ 错误
wx.switchTab({
  url: '/pages/scan/scan'  // 如果 scan 不是 tabBar 页面
});
```

**解决：** 使用 `wx.navigateTo` 或 `wx.reLaunch`

### 错误3：跳转失败但没有错误提示
**原因：** 跳转 API 失败时不会抛出异常，只会在控制台打印警告

**解决：** 使用 fail 回调捕获错误
```javascript
wx.reLaunch({
  url: '/pages/scan/scan',
  success: () => {
    console.log('跳转成功');
  },
  fail: (err) => {
    console.error('跳转失败:', err);
    wx.showToast({
      title: '页面跳转失败',
      icon: 'none'
    });
  }
});
```

---

**最后更新：** 2025-02-05 01:45
