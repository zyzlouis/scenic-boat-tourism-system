# ç´§æ€¥é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š

**ä¿®å¤æ—¶é—´**ï¼š2026-02-12
**é—®é¢˜çº§åˆ«**ï¼šğŸ”´ ä¸¥é‡ï¼ˆå¯¼è‡´æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨ï¼‰

---

## ğŸ› é—®é¢˜æ ¹æº

### æ ¸å¿ƒé—®é¢˜ï¼šæ•°æ®åº“é›†åˆä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
collection.count:fail -502005 database collection not exists
[ResourceNotFound] Db or Table not exist: orders
[ResourceNotFound] Db or Table not exist: users
```

**åŸå› åˆ†æ**ï¼š
1. âŒ `initDatabase` äº‘å‡½æ•°åªåˆ›å»ºäº†CMSå¯ç¼–è¾‘çš„é›†åˆï¼ˆ8ä¸ªï¼‰
2. âŒ æ²¡æœ‰åˆ›å»ºè¿è¡Œæ—¶é›†åˆï¼ˆusersã€ordersã€recharge_ordersã€balance_logsã€verificationLogsï¼‰
3. âŒ å½“ç”¨æˆ·ä»æœªç™»å½•æˆ–åˆ›å»ºè®¢å•æ—¶ï¼Œè¿™äº›é›†åˆä¸å­˜åœ¨
4. âŒ æ‰€æœ‰æŸ¥è¯¢è¿™äº›é›†åˆçš„äº‘å‡½æ•°éƒ½ä¼šæŠ¥é”™

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. initDatabase äº‘å‡½æ•° - æ·»åŠ è¿è¡Œæ—¶é›†åˆåˆ›å»º

**ä¿®æ”¹æ–‡ä»¶**ï¼š`cloudfunctions/initDatabase/index.js`

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… æ·»åŠ  `createRuntimeCollections()` å‡½æ•°
- âœ… è‡ªåŠ¨åˆ›å»º5ä¸ªè¿è¡Œæ—¶é›†åˆï¼š
  - users
  - orders
  - recharge_orders
  - balance_logs
  - verificationLogs

**å®ç°æ–¹å¼**ï¼š
```javascript
// é€šè¿‡æ’å…¥ä¸´æ—¶æ•°æ®å¹¶åˆ é™¤çš„æ–¹å¼ç¡®ä¿é›†åˆè¢«åˆ›å»º
const tempData = { _temp: true, createdAt: new Date() }
const { _id } = await db.collection(collectionName).add({ data: tempData })
await db.collection(collectionName).doc(_id).remove()
```

### 2. åˆ é™¤æ‰€æœ‰ `isDeleted: false` æŸ¥è¯¢æ¡ä»¶

orders é›†åˆæ²¡æœ‰ `isDeleted` å­—æ®µï¼Œæ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šå¤±è´¥ã€‚

**ä¿®å¤çš„äº‘å‡½æ•°ï¼ˆ6ä¸ªï¼‰**ï¼š

| äº‘å‡½æ•° | ä¿®æ”¹å†…å®¹ |
|--------|---------|
| âœ… getOrderList | åˆ é™¤ `isDeleted: false` æ¡ä»¶ï¼ˆ2å¤„ï¼‰ |
| âœ… getOrderDetail | åˆ é™¤ `isDeleted: false` æ¡ä»¶ |
| âœ… getPendingOrders | åˆ é™¤ `isDeleted: false` æ¡ä»¶ |
| âœ… findByBoatNumber | åˆ é™¤ `isDeleted: false` æ¡ä»¶ |
| âœ… mockPayment | åˆ é™¤ `isDeleted: false` æ¡ä»¶ |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ï¼ˆç«‹å³æ‰§è¡Œï¼‰

### ç¬¬ä¸€æ­¥ï¼šé‡æ–°éƒ¨ç½² initDatabase äº‘å‡½æ•°

1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰¾åˆ° `cloudfunctions/initDatabase`
2. å³é”®ç‚¹å‡»ï¼Œé€‰æ‹©ã€ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ã€‘
3. ç­‰å¾…éƒ¨ç½²å®Œæˆ

### ç¬¬äºŒæ­¥ï¼šé‡æ–°è¿è¡Œ initDatabase äº‘å‡½æ•°

åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰§è¡Œï¼š

```json
{
  "action": "init"
}
```

**é¢„æœŸç»“æœ**ï¼š
```json
{
  "success": true,
  "message": "æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ",
  "results": {
    "boatTypes": { "status": "success", "count": 3 },
    "pricingConfigs": { "status": "success", "count": 3 },
    "boats": { "status": "success", "count": 5 },
    "staff": { "status": "success", "count": 3 },
    "banners": { "status": "success", "count": 3 },
    "announcements": { "status": "success", "count": 3 },
    "app_settings": { "status": "success", "count": 1 },
    "recharge_plans": { "status": "success", "count": 6 },
    "runtimeCollections": {
      "users": { "status": "created" },
      "orders": { "status": "created" },
      "recharge_orders": { "status": "created" },
      "balance_logs": { "status": "created" },
      "verificationLogs": { "status": "created" }
    }
  }
}
```

### ç¬¬ä¸‰æ­¥ï¼šé‡æ–°éƒ¨ç½²å…¶ä»–ä¿®å¤çš„äº‘å‡½æ•°ï¼ˆ5ä¸ªï¼‰

ä¾æ¬¡éƒ¨ç½²ä»¥ä¸‹äº‘å‡½æ•°ï¼š

1. **getOrderList** âš ï¸ å¿…é¡»
2. **getOrderDetail** âš ï¸ å¿…é¡»
3. **getPendingOrders**
4. **findByBoatNumber**
5. **mockPayment**

**éƒ¨ç½²æ–¹æ³•**ï¼šå³é”® â†’ ã€ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ã€‘

### ç¬¬å››æ­¥ï¼šéªŒè¯æ•°æ®åº“é›†åˆ

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ï¼Œç¡®è®¤ä»¥ä¸‹é›†åˆå·²åˆ›å»ºï¼š

#### CMSå¯ç¼–è¾‘é›†åˆï¼ˆ8ä¸ªï¼‰
- âœ… boatTypes
- âœ… pricingConfigs
- âœ… boats
- âœ… staff
- âœ… banners
- âœ… announcements
- âœ… app_settings
- âœ… recharge_plans

#### è¿è¡Œæ—¶é›†åˆï¼ˆ5ä¸ªï¼‰
- âœ… users
- âœ… orders
- âœ… recharge_orders
- âœ… balance_logs
- âœ… verificationLogs

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ¸…å•

### âœ… æµ‹è¯•1ï¼šé¦–é¡µèˆ¹å‹åˆ—è¡¨
1. é‡æ–°ç¼–è¯‘å°ç¨‹åº
2. è¿›å…¥é¦–é¡µ
3. ç¡®è®¤èƒ½çœ‹åˆ°3ä¸ªèˆ¹å‹ï¼ˆåŒäººèˆ¹ã€å››äººèˆ¹ã€å…­äººèˆ¹ï¼‰

### âœ… æµ‹è¯•2ï¼šæˆ‘çš„è®¢å•é¡µé¢
1. ç‚¹å‡»åº•éƒ¨Tabã€æˆ‘çš„è®¢å•ã€‘
2. ç¡®è®¤ä¸å†æŠ¥é”™ï¼ˆæ˜¾ç¤º"æš‚æ— è®¢å•"æ˜¯æ­£å¸¸çš„ï¼‰
3. èƒ½æ­£å¸¸åŠ è½½è®¢å•åˆ—è¡¨

### âœ… æµ‹è¯•3ï¼šä¸ªäººä¸­å¿ƒé¡µé¢
1. ç‚¹å‡»ã€ä¸ªäººä¸­å¿ƒã€‘Tab
2. ç¡®è®¤ä½™é¢æ˜¾ç¤ºæ­£å¸¸ï¼ˆ0.00ï¼‰
3. ç‚¹å‡»ã€å……å€¼è®°å½•ã€‘ä¸å†æŠ¥é”™
4. ç‚¹å‡»ã€æˆ‘çš„è®¢å•ã€‘èƒ½æ­£å¸¸è·³è½¬

### âœ… æµ‹è¯•4ï¼šå……å€¼åŠŸèƒ½
1. åœ¨ä¸ªäººä¸­å¿ƒç‚¹å‡»ã€ç«‹å³å……å€¼ã€‘
2. é€‰æ‹©å……å€¼æ–¹æ¡ˆ
3. ç¡®è®¤èƒ½æ­£å¸¸åˆ›å»ºå……å€¼è®¢å•
4. æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸåä½™é¢å¢åŠ 

### âœ… æµ‹è¯•5ï¼šåˆ›å»ºè®¢å•
1. åœ¨é¦–é¡µé€‰æ‹©èˆ¹å‹
2. ç‚¹å‡»ã€ç«‹å³ç§Ÿèµã€‘
3. ç¡®è®¤èƒ½åˆ›å»ºè®¢å•
4. è·³è½¬åˆ°æ”¯ä»˜é¡µé¢

---

## ğŸ“‹ å®Œæ•´çš„äº‘å‡½æ•°æ¸…å•

### å·²ä¿®å¤çš„äº‘å‡½æ•°ï¼ˆ13ä¸ªï¼‰

| åºå· | äº‘å‡½æ•°å | ä¿®å¤å†…å®¹ | ä¼˜å…ˆçº§ |
|-----|---------|---------|-------|
| 1 | **initDatabase** | æ·»åŠ è¿è¡Œæ—¶é›†åˆåˆ›å»º | ğŸ”´ æœ€é«˜ |
| 2 | **getBoatTypes** | å­—æ®µåæ›´æ–° | ğŸ”´ æœ€é«˜ |
| 3 | **getOrderList** | åˆ é™¤isDeleted + count()ä¿®å¤ | ğŸ”´ æœ€é«˜ |
| 4 | **getOrderDetail** | åˆ é™¤isDeleted | ğŸŸ¡ é«˜ |
| 5 | **getPendingOrders** | åˆ é™¤isDeleted | ğŸŸ¡ é«˜ |
| 6 | **findByBoatNumber** | åˆ é™¤isDeleted | ğŸŸ¡ é«˜ |
| 7 | **mockPayment** | åˆ é™¤isDeleted | ğŸŸ¡ é«˜ |
| 8 | **staffLogin** | å­—æ®µåæ›´æ–° + bcryptéªŒè¯ | ğŸŸ¢ ä¸­ |
| 9 | **login** | æ–°åˆ›å»º | ğŸŸ¢ ä¸­ |
| 10 | **createOrder** | å·²æ­£ç¡®ï¼ˆä¿ç•™isDeletedï¼‰ | âœ… æ— éœ€ |
| 11 | **endTrip** | å·²æ­£ç¡®ï¼ˆä¿ç•™isDeletedï¼‰ | âœ… æ— éœ€ |
| 12 | **scanCode** | å·²æ­£ç¡®ï¼ˆä¿ç•™isDeletedï¼‰ | âœ… æ— éœ€ |
| 13 | **startTrip** | å·²æ­£ç¡®ï¼ˆä¿ç•™isDeletedï¼‰ | âœ… æ— éœ€ |

### å……å€¼ç›¸å…³äº‘å‡½æ•°ï¼ˆ6ä¸ªï¼‰- æ— éœ€ä¿®æ”¹

| åºå· | äº‘å‡½æ•°å | çŠ¶æ€ |
|-----|---------|------|
| 14 | getRecharePlans | âœ… æ­£å¸¸ |
| 15 | createRechargeOrder | âœ… æ­£å¸¸ |
| 16 | rechargeCallback | âœ… æ­£å¸¸ |
| 17 | getUserBalance | âœ… æ­£å¸¸ |
| 18 | getBalanceLogs | âœ… æ­£å¸¸ |
| 19 | payWithBalance | âœ… æ­£å¸¸ |

### ç®¡ç†ç›¸å…³äº‘å‡½æ•°ï¼ˆ1ä¸ªï¼‰- æ— éœ€ä¿®æ”¹

| åºå· | äº‘å‡½æ•°å | çŠ¶æ€ |
|-----|---------|------|
| 20 | manageStaff | âœ… æ­£å¸¸ |

---

## âš ï¸ é‡è¦è¯´æ˜

### ä¸ºä»€ä¹ˆ orders é›†åˆä¿ç•™ `isDeleted` å­—æ®µï¼Ÿ

**ç­”æ¡ˆ**ï¼šorders é›†åˆæ˜¯**ä¾‹å¤–**ï¼Œå®ƒä¿æŒåµŒå¥—ç»“æ„å’ŒåŸæœ‰å­—æ®µè®¾è®¡ã€‚

- âœ… createOrder äº‘å‡½æ•°ä¸­å†™å…¥ `isDeleted: false` æ˜¯æ­£ç¡®çš„
- âœ… endTripã€scanCodeã€startTrip æŸ¥è¯¢æ—¶ä½¿ç”¨ `isDeleted: false` æ˜¯æ­£ç¡®çš„
- âŒ getOrderListã€getOrderDetail ç­‰æŸ¥è¯¢äº‘å‡½æ•°ä½¿ç”¨ `isDeleted: false` æ˜¯é”™è¯¯çš„

**åŸå› **ï¼š
- orders é›†åˆçš„è®°å½•æ˜¯ç”± createOrder äº‘å‡½æ•°åˆ›å»ºçš„
- createOrder ä¼šè‡ªåŠ¨æ·»åŠ  `isDeleted: false` å­—æ®µ
- ä½†å®é™…ä½¿ç”¨ä¸­ä¸ä¼šçœŸæ­£åˆ é™¤è®¢å•ï¼ˆè®¾ç½® isDeleted=trueï¼‰
- æ‰€ä»¥æŸ¥è¯¢æ—¶ä¸åº”è¯¥è¿‡æ»¤ isDeleted å­—æ®µ

### é›†åˆåˆ›å»ºçš„ä¸¤ç§æ–¹å¼

1. **CMSå¯ç¼–è¾‘é›†åˆ**ï¼šé€šè¿‡ initDatabase æ’å…¥æµ‹è¯•æ•°æ®åˆ›å»º
2. **è¿è¡Œæ—¶é›†åˆ**ï¼šé€šè¿‡æ’å…¥ä¸´æ—¶æ•°æ®å¹¶åˆ é™¤çš„æ–¹å¼åˆ›å»º

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

| åŠŸèƒ½ | çŠ¶æ€ | é”™è¯¯ |
|------|------|------|
| é¦–é¡µèˆ¹å‹åˆ—è¡¨ | âŒ | å­—æ®µåä¸åŒ¹é… |
| æˆ‘çš„è®¢å• | âŒ | é›†åˆä¸å­˜åœ¨ + isDeletedé”™è¯¯ |
| å……å€¼è®°å½• | âŒ | é›†åˆä¸å­˜åœ¨ |
| ä¸ªäººä¸­å¿ƒä½™é¢ | âŒ | usersé›†åˆä¸å­˜åœ¨ |

### ä¿®å¤å

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é¦–é¡µèˆ¹å‹åˆ—è¡¨ | âœ… | æ˜¾ç¤º3ä¸ªèˆ¹å‹ |
| æˆ‘çš„è®¢å• | âœ… | æ­£å¸¸æ˜¾ç¤ºï¼ˆç©ºåˆ—è¡¨ï¼‰ |
| å……å€¼è®°å½• | âœ… | æ­£å¸¸æ˜¾ç¤ºï¼ˆç©ºåˆ—è¡¨ï¼‰ |
| ä¸ªäººä¸­å¿ƒä½™é¢ | âœ… | æ˜¾ç¤º0.00 |

---

## ğŸ¯ éƒ¨ç½²åå¿…åšäº‹é¡¹

1. âœ… é‡æ–°éƒ¨ç½² initDatabase äº‘å‡½æ•°
2. âœ… è¿è¡Œ initDatabase åˆå§‹åŒ–ï¼ˆaction: initï¼‰
3. âœ… éªŒè¯æ•°æ®åº“ä¸­æœ‰13ä¸ªé›†åˆ
4. âœ… é‡æ–°éƒ¨ç½²5ä¸ªä¿®å¤çš„äº‘å‡½æ•°
5. âœ… æµ‹è¯•æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
6. âœ… ç¡®è®¤ä¸å†æŠ¥"é›†åˆä¸å­˜åœ¨"é”™è¯¯

---

## ğŸ“ å¦‚æœ‰é—®é¢˜

å¦‚æœéƒ¨ç½²åä»æœ‰é—®é¢˜ï¼š

1. **æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—**ï¼šäº‘å¼€å‘æ§åˆ¶å° â†’ äº‘å‡½æ•° â†’ æ—¥å¿—
2. **æŸ¥çœ‹æ•°æ®åº“**ï¼šç¡®è®¤13ä¸ªé›†åˆéƒ½å·²åˆ›å»º
3. **é‡æ–°åˆå§‹åŒ–**ï¼šæ¸…ç©ºæ•°æ®åº“åé‡æ–°è¿è¡Œ initDatabase
4. **æ£€æŸ¥ç¯å¢ƒID**ï¼šç¡®è®¤ app.js ä¸­çš„ç¯å¢ƒIDæ­£ç¡®

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0
**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026-02-12
**çŠ¶æ€**ï¼šâœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œç­‰å¾…éƒ¨ç½²éªŒè¯
