# 员工密码修复指南

## 问题说明

如果工作人员通过**微信云开发控制台的CMS后台直接添加员工**，密码字段没有加密，导致员工无法登录。

## 解决方案

使用 `fixStaffPasswords` 云函数批量修复所有员工的密码。

## 使用步骤

### 1. 部署云函数

在微信开发者工具中：
1. 右键点击 `cloudfunctions/fixStaffPasswords`
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成

### 2. 检查哪些员工需要修复

在微信开发者工具的**云开发控制台** → **云函数**页面：

**调用参数：**
```json
{
  "action": "check"
}
```

**返回结果示例：**
```json
{
  "code": 200,
  "message": "检查完成",
  "data": {
    "total": 10,
    "alreadyEncrypted": 3,
    "needFix": 7,
    "fixed": [
      {
        "username": "staff01",
        "realName": "张三",
        "currentPassword": "123456",
        "status": "need_fix"
      },
      ...
    ],
    "errors": []
  }
}
```

### 3. 修复密码

确认需要修复后，执行修复操作：

**调用参数：**
```json
{
  "action": "fix",
  "defaultPassword": "123456"
}
```

**参数说明：**
- `action`: "fix" - 执行修复
- `defaultPassword`: "123456" - 默认密码（可选，如果员工原密码为空或太短，将使用此密码）

**返回结果示例：**
```json
{
  "code": 200,
  "message": "修复完成",
  "data": {
    "total": 10,
    "alreadyEncrypted": 3,
    "needFix": 7,
    "fixed": [
      {
        "username": "staff01",
        "realName": "张三",
        "originalPassword": "123456",
        "newPassword": "123456",
        "status": "fixed"
      },
      ...
    ],
    "errors": []
  }
}
```

### 4. 通知员工

修复完成后，请通知员工：
- 如果之前设置了密码，密码不变（已加密）
- 如果密码为空或无效，已重置为默认密码（如：123456）
- 员工首次登录后建议修改密码

## 注意事项

1. **修复操作不可逆**，建议先执行 `action: "check"` 检查
2. 修复后，员工使用**原密码**登录（如果原密码有效）
3. 如果原密码为空或太短，将使用 `defaultPassword`（默认123456）
4. 已经加密的密码不会被修改

## 今后添加员工的正确方式

**方式1：通过云函数添加（推荐）**

在云开发控制台调用 `manageStaff` 云函数：

```json
{
  "action": "create",
  "staffData": {
    "username": "staff05",
    "password": "123456",
    "realName": "王五",
    "phone": "13800138005",
    "role": "staff"
  }
}
```

**方式2：通过CMS后台添加后，立即修复**

如果必须通过CMS后台添加，添加后立即运行 `fixStaffPasswords` 云函数修复。

## 常见问题

### Q: 修复后员工还是无法登录？

A: 请检查：
1. 员工账号的 `enabled` 字段是否为 `true`
2. 确认使用正确的用户名和密码登录
3. 查看云函数 `staffLogin` 的日志，确认错误信息

### Q: 如何重置某个员工的密码？

A: 调用 `manageStaff` 云函数：

```json
{
  "action": "resetPassword",
  "staffId": "员工ID",
  "staffData": {
    "password": "新密码"
  }
}
```

### Q: 如何避免这个问题？

A:
1. **优先使用云函数** `manageStaff` 或 `createStaff` 添加员工
2. 如果使用CMS后台，添加后立即运行 `fixStaffPasswords` 修复
3. 培训管理员使用正确的添加流程
