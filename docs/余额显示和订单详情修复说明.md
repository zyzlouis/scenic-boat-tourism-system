# 余额显示和订单详情页修复说明

**修复时间**：2026-02-12
**修复问题**：用户余额不显示、订单详情页一直转圈

---

## 🐛 问题描述

### 问题1：订单详情页一直转圈
- **现象**：用户支付成功后，点击确定跳转到订单详情页，页面一直显示 loading 转圈
- **影响**：必须重新进入小程序才能看到订单信息

### 问题2：余额不显示
- **现象**：用户充值成功后，个人中心页面不显示余额
- **现象**：支付页面也不显示储值卡余额
- **后台状态**：功能正常，数据库记录正确，扣款成功

---

## ✅ 已修复内容

### 1. 订单详情页参数名不匹配 ⚠️ 高优先级

**问题根源**：
- `pages/payment/payment.js` 第122行：传递参数名为 `id`
- `pages/order-detail/order-detail.js` 第14行：接收参数名为 `orderId`
- 参数名不匹配导致 orderId 为 undefined，页面无法加载订单数据

**修复内容**：
修改 `pages/payment/payment.js` 第122行

```javascript
// 修复前
wx.redirectTo({
  url: `/pages/order-detail/order-detail?id=${this.data.order._id}`
})

// 修复后
wx.redirectTo({
  url: `/pages/order-detail/order-detail?orderId=${this.data.order._id}`
})
```

**修复文件**：
- ✅ `client-user/pages/payment/payment.js`

---

### 2. 余额显示调试日志 🔍 诊断工具

**目的**：添加详细的 console.log 日志，以便诊断余额不显示的根本原因

**修复内容**：

#### (1) 个人中心页面 - profile.js

```javascript
async loadBalance() {
  this.setData({ loading: true })

  try {
    const res = await wx.cloud.callFunction({
      name: 'getUserBalance'
    })

    console.log('💰 getUserBalance 返回结果:', res.result)

    if (res.result.success) {
      const balanceData = {
        balance: res.result.balance || 0,
        totalRecharge: res.result.totalRecharge || 0,
        totalGift: res.result.totalGift || 0,
        isVip: res.result.isVip || false
      }

      console.log('💰 准备更新余额数据:', balanceData)
      this.setData(balanceData)
      console.log('💰 余额数据已更新到页面:', this.data)
    } else {
      console.error('❌ getUserBalance 返回失败:', res.result)
    }
  } catch (error) {
    console.error('❌ 获取余额失败:', error)
    wx.showToast({
      title: '获取余额失败',
      icon: 'none'
    })
  } finally {
    this.setData({ loading: false })
  }
}
```

#### (2) 支付页面 - payment.js

```javascript
async loadBalance() {
  try {
    const res = await wx.cloud.callFunction({
      name: 'getUserBalance'
    })

    console.log('💰 [支付页面] getUserBalance 返回结果:', res.result)

    if (res.result.success) {
      this.setData({
        balance: res.result.balance || 0
      })

      console.log('💰 [支付页面] 余额已更新:', this.data.balance)
    }
  } catch (error) {
    console.error('❌ [支付页面] 获取余额失败:', error)
  }
}
```

**修复文件**：
- ✅ `client-user/pages/profile/profile.js`
- ✅ `client-user/pages/payment/payment.js`

---

## 🚀 测试步骤

### 第一步：重新编译小程序

1. 在微信开发者工具中，点击【编译】按钮
2. 确保没有编译错误
3. 打开调试器（Console 面板）

---

### 第二步：测试订单详情页修复

#### 测试场景：余额支付后跳转订单详情

1. **进入支付页面**
   - 在首页选择任意船型
   - 点击【立即租赁】创建订单
   - 自动跳转到支付页面

2. **使用余额支付**
   - 选择【余额支付】
   - 点击【立即支付】
   - 支付成功后会弹出提示框

3. **跳转到订单详情**
   - 点击提示框的【确定】按钮
   - ✅ **预期结果**：立即跳转到订单详情页，显示订单信息（不再转圈）
   - ❌ **修复前**：页面一直转圈，必须重新进入小程序才能看到订单

4. **验证订单信息**
   - 核销码正常显示
   - 订单号正常显示
   - 订单状态正常显示

---

### 第三步：测试余额显示（关键）

#### 测试场景1：充值后查看余额

1. **进入充值页面**
   - 点击底部 Tab【我的】
   - 点击【立即充值】

2. **完成充值**
   - 选择充值方案（例如：充100送20）
   - 点击【立即充值】
   - 等待充值成功提示

3. **返回个人中心**
   - 点击充值成功提示框的【确定】
   - 自动返回个人中心

4. **查看控制台日志**（重要！）
   - 打开微信开发者工具的 Console 面板
   - 查找以下日志：

   ```
   💰 getUserBalance 返回结果: {success: true, balance: 120, ...}
   💰 准备更新余额数据: {balance: 120, totalRecharge: 100, ...}
   💰 余额数据已更新到页面: {balance: 120, ...}
   ```

5. **验证余额显示**
   - ✅ **预期结果**：个人中心页面显示余额 ¥120.00
   - 📊 如果余额仍然不显示，请截图控制台日志发给我

---

#### 测试场景2：支付页面查看余额

1. **创建新订单**
   - 在首页选择船型
   - 点击【立即租赁】
   - 跳转到支付页面

2. **查看余额支付选项**
   - 查找【余额支付】选项
   - ✅ **预期结果**：显示"余额：¥120.00"
   - 查看控制台日志：

   ```
   💰 [支付页面] getUserBalance 返回结果: {success: true, balance: 120}
   💰 [支付页面] 余额已更新: 120
   ```

3. **使用余额支付**
   - 选择【余额支付】
   - 点击【立即支付】
   - 支付成功后弹出提示框

4. **验证扣款后余额**
   - 提示框显示"剩余余额：¥XX.XX"
   - 返回个人中心，余额应该减少

---

## 🔍 诊断余额显示问题

### 如果余额仍然不显示，请检查以下日志：

#### 1. 检查云函数返回值
```
💰 getUserBalance 返回结果: {success: true, balance: xxx, ...}
```

**如果看到这条日志**：
- ✅ 云函数调用成功
- ✅ 返回了余额数据
- 问题可能在 setData() 或页面渲染

**如果没有看到这条日志**：
- ❌ 云函数可能没有被调用
- ❌ 或者调用失败

---

#### 2. 检查数据准备
```
💰 准备更新余额数据: {balance: 120, totalRecharge: 100, ...}
```

**如果看到这条日志**：
- ✅ 数据格式正确
- ✅ balance 不是 undefined 或 null

**如果数据异常**：
- 检查是否 balance 为 undefined、null、NaN
- 检查是否 getUserBalance 云函数返回的数据结构不正确

---

#### 3. 检查页面数据更新
```
💰 余额数据已更新到页面: {balance: 120, loading: false, ...}
```

**如果看到这条日志**：
- ✅ setData() 已执行
- ✅ 数据已经绑定到 this.data

**如果页面仍不显示**：
- 问题可能在 WXML 模板
- 可能是 toFixed(2) 调用出错
- 可能是页面渲染问题

---

## 📋 如果问题仍未解决

### 请提供以下信息：

1. **控制台完整日志**
   - 从进入个人中心开始
   - 到余额不显示为止
   - 截图所有日志（特别是 💰 和 ❌ 开头的）

2. **网络面板日志**
   - 打开微信开发者工具的【Network】面板
   - 筛选 `getUserBalance` 云函数调用
   - 查看请求和响应内容
   - 截图请求和响应

3. **数据库截图**
   - 打开云开发控制台 → 数据库
   - 找到 `users` 集合
   - 查看你的用户记录（通过 _openid 识别）
   - 截图 balance、totalRecharge、totalGift 字段

4. **页面元素检查**
   - 在模拟器上右键个人中心页面
   - 选择【审查元素】
   - 查找余额显示的 `<text>` 元素
   - 查看元素的实际内容
   - 截图元素树

---

## 📝 修复文件清单

| 序号 | 文件路径 | 修复内容 | 优先级 |
|-----|---------|---------|-------|
| 1 | `client-user/pages/payment/payment.js` | 修复订单详情页参数名 | 🔴 最高 |
| 2 | `client-user/pages/profile/profile.js` | 添加余额加载调试日志 | 🔍 诊断 |
| 3 | `client-user/pages/payment/payment.js` | 添加余额加载调试日志 | 🔍 诊断 |

---

## ⚠️ 重要提醒

1. **订单详情页修复是确定的**
   - 问题根源已确认：参数名不匹配
   - 修复后应该立即生效

2. **余额显示问题需要进一步诊断**
   - 代码逻辑看起来是正确的
   - 需要通过日志来定位具体原因
   - 可能的原因：
     - 数据库中的 balance 字段类型不正确（字符串而不是数字）
     - 页面生命周期问题（onShow 没有触发）
     - WXML 模板渲染问题（toFixed 调用失败）
     - 其他未知原因

3. **测试建议**
   - 先测试订单详情页修复（这个应该没问题）
   - 再测试余额显示，重点关注控制台日志
   - 如果余额仍不显示，发送日志截图给我分析

---

**文档版本**：v1.0
**修复时间**：2026-02-12
**状态**：✅ 订单详情页已修复，余额显示问题待诊断
