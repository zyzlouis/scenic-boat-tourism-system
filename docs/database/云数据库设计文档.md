# æ™¯åŒºæ¸¸èˆ¹è®¡æ—¶æ”¶è´¹ç³»ç»Ÿ - äº‘æ•°æ®åº“è®¾è®¡æ–‡æ¡£

| **æ–‡æ¡£ç‰ˆæœ¬** | **V2.0 (äº‘å¼€å‘ç‰ˆ)**          |
| ------------ | ---------------------------- |
| **æ•°æ®åº“**   | å¾®ä¿¡äº‘å¼€å‘ - äº‘æ•°æ®åº“ï¼ˆMongoDBï¼‰ |
| **åˆ›å»ºæ—¶é—´** | 2026-02-04                   |

---

## ğŸ“‹ æ•°æ®åº“è¯´æ˜

å¾®ä¿¡äº‘å¼€å‘ä½¿ç”¨çš„æ˜¯ **MongoDB** æ–‡æ¡£å‹æ•°æ®åº“ï¼Œä¸ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ï¼ˆMySQLï¼‰æœ‰ä»¥ä¸‹ä¸»è¦åŒºåˆ«ï¼š

### MySQL vs MongoDB

| ç‰¹æ€§ | MySQL | MongoDB |
|------|-------|---------|
| æ•°æ®ç»“æ„ | è¡¨ï¼ˆTableï¼‰ | é›†åˆï¼ˆCollectionï¼‰ |
| æ•°æ®è¡Œ | è¡Œï¼ˆRowï¼‰ | æ–‡æ¡£ï¼ˆDocumentï¼‰ |
| ä¸»é”® | id | _idï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ |
| æŸ¥è¯¢è¯­è¨€ | SQL | MongoDBæŸ¥è¯¢è¯­æ³• |
| å…³è”æŸ¥è¯¢ | JOIN | èšåˆï¼ˆAggregateï¼‰æˆ–åµŒå…¥æ–‡æ¡£ |
| äº‹åŠ¡æ”¯æŒ | å®Œæ•´æ”¯æŒ | 4.0+ç‰ˆæœ¬æ”¯æŒ |

---

## ğŸ—„ï¸ é›†åˆï¼ˆCollectionï¼‰è®¾è®¡

### 1. usersï¼ˆç”¨æˆ·é›†åˆï¼‰

**é›†åˆå**: `users`

**æ–‡æ¡£ç»“æ„**:
```javascript
{
  _id: "auto_generated_id",           // è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£ID
  _openid: "user_openid_from_wx",     // äº‘å¼€å‘è‡ªåŠ¨æ·»åŠ çš„openid
  openid: "user_openid",              // å¾®ä¿¡openidï¼ˆå†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
  unionid: "user_unionid",            // å¾®ä¿¡unionidï¼ˆå¯é€‰ï¼‰
  nickname: "å¼ ä¸‰",                    // æ˜µç§°
  avatarUrl: "https://...",           // å¤´åƒURL
  phone: "13800138000",               // æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰
  isVip: false,                       // æ˜¯å¦VIP
  isDeleted: false,                   // è½¯åˆ é™¤æ ‡è®°
  createdAt: Date,                    // åˆ›å»ºæ—¶é—´
  updatedAt: Date                     // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•**:
```javascript
// openid å”¯ä¸€ç´¢å¼•
db.collection('users').createIndex({
  openid: 1
}, {
  unique: true
})
```

---

### 2. boatTypesï¼ˆèˆ¹å‹é›†åˆï¼‰

**é›†åˆå**: `boatTypes`

**æ–‡æ¡£ç»“æ„**:
```javascript
{
  _id: "boat_type_id",
  typeCode: "powered",                // èˆ¹å‹ç¼–ç 
  typeName: "æœ‰åŠ¨åŠ›èˆ¹",                // èˆ¹å‹åç§°
  description: "é…æœ‰ç”µåŠ¨é©¬è¾¾...",      // æè¿°
  maxCapacity: 4,                     // æœ€å¤§è½½å®¢é‡
  imageUrl: "https://...",            // å›¾ç‰‡URL
  sortOrder: 1,                       // æ’åº
  isActive: true,                     // æ˜¯å¦å¯ç”¨
  isDeleted: false,                   // è½¯åˆ é™¤
  createdAt: Date,
  updatedAt: Date
}
```

**åˆå§‹æ•°æ®**:
```javascript
[
  {
    typeCode: "powered",
    typeName: "æœ‰åŠ¨åŠ›èˆ¹",
    description: "é…æœ‰ç”µåŠ¨é©¬è¾¾ï¼Œé€Ÿåº¦è¾ƒå¿«ï¼Œé€‚åˆè¿œè·ç¦»æ¸¸ç©",
    maxCapacity: 4,
    imageUrl: "cloud://...",
    sortOrder: 1,
    isActive: true,
    isDeleted: false
  },
  {
    typeCode: "unpowered",
    typeName: "æ— åŠ¨åŠ›èˆ¹",
    description: "è„šè¸æˆ–æ‰‹åˆ’ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œé€‚åˆæ‚ é—²æ¸¸æ¹–",
    maxCapacity: 2,
    imageUrl: "cloud://...",
    sortOrder: 2,
    isActive: true,
    isDeleted: false
  }
]
```

---

### 3. pricingConfigï¼ˆä»·æ ¼é…ç½®é›†åˆï¼‰

**é›†åˆå**: `pricingConfig`

**æ–‡æ¡£ç»“æ„**:
```javascript
{
  _id: "pricing_id",
  boatTypeId: "boat_type_id",         // å…³è”èˆ¹å‹ID
  priceName: "æœ‰åŠ¨åŠ›èˆ¹-å¹³æ—¥ä»·",         // ä»·æ ¼æ–¹æ¡ˆåç§°
  basePrice: 50.00,                   // åŸºç¡€ç¥¨ä»·ï¼ˆå…ƒï¼‰
  depositAmount: 100.00,              // æŠ¼é‡‘é‡‘é¢ï¼ˆå…ƒï¼‰
  includedMinutes: 60,                // åŒ…å«æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  overtimeRate: 1.00,                 // è¶…æ—¶è´¹ç‡ï¼ˆå…ƒ/åˆ†é’Ÿï¼‰
  capAmount: 200.00,                  // å°é¡¶é‡‘é¢ï¼ˆå…ƒï¼‰
  effectiveDate: Date,                // ç”Ÿæ•ˆæ—¥æœŸï¼ˆå¯é€‰ï¼‰
  expiryDate: Date,                   // å¤±æ•ˆæ—¥æœŸï¼ˆå¯é€‰ï¼‰
  isDefault: true,                    // æ˜¯å¦é»˜è®¤ä»·æ ¼
  isActive: true,                     // æ˜¯å¦å¯ç”¨
  isDeleted: false,
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•**:
```javascript
// èˆ¹å‹ID + é»˜è®¤ä»·æ ¼ å¤åˆç´¢å¼•
db.collection('pricingConfig').createIndex({
  boatTypeId: 1,
  isDefault: 1,
  isActive: 1
})
```

---

### 4. boatsï¼ˆèˆ¹åªé›†åˆï¼‰

**é›†åˆå**: `boats`

**æ–‡æ¡£ç»“æ„**:
```javascript
{
  _id: "boat_id",
  boatNumber: "E-001",                // èˆ¹å·ï¼ˆå”¯ä¸€ï¼‰
  boatTypeId: "boat_type_id",         // å…³è”èˆ¹å‹ID
  status: "idle",                     // çŠ¶æ€ï¼šidle/in_use/maintenance
  lastUsedAt: Date,                   // æœ€åä½¿ç”¨æ—¶é—´
  isActive: true,
  isDeleted: false,
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•**:
```javascript
// èˆ¹å·å”¯ä¸€ç´¢å¼•
db.collection('boats').createIndex({
  boatNumber: 1
}, {
  unique: true
})

// çŠ¶æ€ç´¢å¼•ï¼ˆæŸ¥è¯¢ç©ºé—²èˆ¹åªï¼‰
db.collection('boats').createIndex({
  status: 1
})
```

---

### 5. ordersï¼ˆè®¢å•é›†åˆï¼‰â­æ ¸å¿ƒé›†åˆ

**é›†åˆå**: `orders`

**æ–‡æ¡£ç»“æ„**:
```javascript
{
  _id: "order_id",
  _openid: "user_openid",             // äº‘å¼€å‘è‡ªåŠ¨æ·»åŠ 
  orderNo: "ORD20260204123456",       // è®¢å•å·ï¼ˆå”¯ä¸€ï¼‰
  userId: "user_id",                  // å…³è”ç”¨æˆ·ID

  // èˆ¹å‹å’Œèˆ¹åªä¿¡æ¯ï¼ˆåµŒå…¥å­—æ®µï¼Œå‡å°‘æŸ¥è¯¢ï¼‰
  boatType: {
    id: "boat_type_id",
    code: "powered",
    name: "æœ‰åŠ¨åŠ›èˆ¹"
  },
  boat: {
    id: "boat_id",                    // å‘èˆ¹åæ‰æœ‰
    number: "E-001"
  },

  // ä»·æ ¼å¿«ç…§ï¼ˆè®¢å•åˆ›å»ºæ—¶çš„ä»·æ ¼ï¼‰
  pricing: {
    id: "pricing_id",
    basePrice: 50.00,
    depositAmount: 100.00,
    includedMinutes: 60,
    overtimeRate: 1.00,
    capAmount: 200.00
  },

  totalAmount: 150.00,                // è®¢å•æ€»é¢ï¼ˆç¥¨ä»·+æŠ¼é‡‘ï¼‰
  verificationCode: "VF123456ABC",    // æ ¸é”€ç ï¼ˆå”¯ä¸€ï¼‰

  // è®¢å•çŠ¶æ€
  status: "pending",                  // pending/paid/timing/ended/completed/cancelled

  // è®¡æ—¶ä¿¡æ¯
  timing: {
    startTime: Date,                  // å¼€å§‹æ—¶é—´
    endTime: Date,                    // ç»“æŸæ—¶é—´
    usedSeconds: 0,                   // ä½¿ç”¨ç§’æ•°
    usedMinutes: 0,                   // ä½¿ç”¨åˆ†é’Ÿæ•°ï¼ˆå‘ä¸Šå–æ•´ï¼‰
    overtimeMinutes: 0,               // è¶…æ—¶åˆ†é’Ÿæ•°
    overtimeFee: 0.00,                // è¶…æ—¶è´¹ç”¨
    isAbnormal: false                 // æ˜¯å¦å¼‚å¸¸ï¼ˆè¶…24å°æ—¶ï¼‰
  },

  // ç»“ç®—ä¿¡æ¯
  settlement: {
    finalAmount: 50.00,               // æœ€ç»ˆè´¹ç”¨
    refundAmount: 100.00,             // é€€æ¬¾é‡‘é¢
    refundedAt: Date                  // é€€æ¬¾æ—¶é—´
  },

  // æ”¯ä»˜ä¿¡æ¯
  payment: {
    transactionId: "wx_pay_id",       // å¾®ä¿¡æ”¯ä»˜äº¤æ˜“å·
    paidAt: Date,                     // æ”¯ä»˜æ—¶é—´
    method: "wechat"                  // æ”¯ä»˜æ–¹å¼
  },

  remark: "",                         // å¤‡æ³¨
  isDeleted: false,
  createdAt: Date,
  updatedAt: Date,
  completedAt: Date
}
```

**ç´¢å¼•**:
```javascript
// è®¢å•å·å”¯ä¸€ç´¢å¼•
db.collection('orders').createIndex({
  orderNo: 1
}, {
  unique: true
})

// æ ¸é”€ç å”¯ä¸€ç´¢å¼•
db.collection('orders').createIndex({
  verificationCode: 1
}, {
  unique: true
})

// ç”¨æˆ·ID + çŠ¶æ€ å¤åˆç´¢å¼•
db.collection('orders').createIndex({
  userId: 1,
  status: 1,
  createdAt: -1
})

// èˆ¹å·æŸ¥è¯¢ç´¢å¼•
db.collection('orders').createIndex({
  'boat.number': 1,
  status: 1
})

// çŠ¶æ€ç´¢å¼•ï¼ˆæŸ¥è¯¢è®¡æ—¶ä¸­çš„è®¢å•ï¼‰
db.collection('orders').createIndex({
  status: 1
})
```

---

### 6. staffï¼ˆå‘˜å·¥é›†åˆï¼‰

**é›†åˆå**: `staff`

**æ–‡æ¡£ç»“æ„**:
```javascript
{
  _id: "staff_id",
  username: "admin",                  // ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
  password: "bcrypt_hashed_password", // å¯†ç ï¼ˆbcryptåŠ å¯†ï¼‰
  realName: "å¼ ä¸‰",                   // çœŸå®å§“å
  phone: "13800138000",              // æ‰‹æœºå·
  role: "admin",                      // è§’è‰²ï¼šstaff/admin
  isActive: true,
  lastLoginAt: Date,
  isDeleted: false,
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•**:
```javascript
// ç”¨æˆ·åå”¯ä¸€ç´¢å¼•
db.collection('staff').createIndex({
  username: 1
}, {
  unique: true
})
```

**åˆå§‹æ•°æ®**:
```javascript
[
  {
    username: "admin",
    password: "$2b$10$...",  // admin123 çš„bcryptå“ˆå¸Œ
    realName: "ç³»ç»Ÿç®¡ç†å‘˜",
    role: "admin",
    isActive: true
  },
  {
    username: "staff01",
    password: "$2b$10$...",  // staff123 çš„bcryptå“ˆå¸Œ
    realName: "å¼ ä¸‰",
    role: "staff",
    isActive: true
  }
]
```

---

### 7. verificationLogsï¼ˆæ ¸é”€è®°å½•é›†åˆï¼‰

**é›†åˆå**: `verificationLogs`

**æ–‡æ¡£ç»“æ„**:
```javascript
{
  _id: "log_id",
  orderId: "order_id",                // å…³è”è®¢å•ID
  staffId: "staff_id",                // å…³è”å‘˜å·¥ID
  staffName: "å¼ ä¸‰",                  // å‘˜å·¥å§“åï¼ˆå†—ä½™ï¼‰
  boatId: "boat_id",                  // å…³è”èˆ¹åªID
  boatNumber: "E-001",                // èˆ¹å·ï¼ˆå†—ä½™ï¼‰
  actionType: "start",                // æ“ä½œç±»å‹ï¼šstart/end
  scanTime: Date,                     // æ‰«ç æ—¶é—´
  remark: "",                         // å¤‡æ³¨
  createdAt: Date
}
```

**ç´¢å¼•**:
```javascript
// è®¢å•IDç´¢å¼•
db.collection('verificationLogs').createIndex({
  orderId: 1,
  createdAt: -1
})

// å‘˜å·¥IDç´¢å¼•
db.collection('verificationLogs').createIndex({
  staffId: 1,
  createdAt: -1
})
```

---

## ğŸ”„ æ•°æ®åº“æ“ä½œç¤ºä¾‹

### äº‘å¼€å‘æ•°æ®åº“API

```javascript
const db = wx.cloud.database()
const _ = db.command

// 1. æŸ¥è¯¢
const { data } = await db.collection('orders')
  .where({
    userId: 'user_id',
    status: 'timing'
  })
  .orderBy('createdAt', 'desc')
  .limit(10)
  .get()

// 2. æ’å…¥
await db.collection('orders').add({
  data: {
    orderNo: 'ORD...',
    userId: 'user_id',
    status: 'pending',
    createdAt: new Date()
  }
})

// 3. æ›´æ–°
await db.collection('orders').doc('order_id').update({
  data: {
    status: 'timing',
    'timing.startTime': new Date(),
    updatedAt: new Date()
  }
})

// 4. åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
await db.collection('orders').doc('order_id').update({
  data: {
    isDeleted: true,
    updatedAt: new Date()
  }
})

// 5. èšåˆæŸ¥è¯¢ï¼ˆæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼‰
await db.collection('orders')
  .aggregate()
  .lookup({
    from: 'users',
    localField: 'userId',
    foreignField: '_id',
    as: 'user'
  })
  .end()
```

---

## ğŸ’¡ è®¾è®¡è¯´æ˜

### 1. åµŒå…¥æ–‡æ¡£ vs å¼•ç”¨

**åµŒå…¥æ–‡æ¡£**ï¼ˆæ¨èï¼‰:
- å°†ç›¸å…³æ•°æ®ç›´æ¥åµŒå…¥åˆ°æ–‡æ¡£ä¸­
- å‡å°‘æŸ¥è¯¢æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½
- é€‚ç”¨äºä¸€å¯¹ä¸€ã€ä¸€å¯¹å°‘çš„å…³ç³»

**ç¤ºä¾‹**ï¼šè®¢å•ä¸­åµŒå…¥èˆ¹å‹å’Œä»·æ ¼ä¿¡æ¯
```javascript
{
  boatType: { id, code, name },
  pricing: { basePrice, depositAmount, ... }
}
```

**å¼•ç”¨**ï¼ˆæŒ‰éœ€ä½¿ç”¨ï¼‰:
- å­˜å‚¨å…³è”æ–‡æ¡£çš„ID
- éœ€è¦æ—¶é€šè¿‡èšåˆæŸ¥è¯¢å…³è”
- é€‚ç”¨äºä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³ç³»

### 2. æ•°æ®å†—ä½™

ä¸ºäº†æŸ¥è¯¢æ€§èƒ½ï¼Œé€‚å½“å†—ä½™æ•°æ®ï¼š
- è®¢å•ä¸­å†—ä½™èˆ¹å‹åç§°ã€èˆ¹å·ç­‰
- æ ¸é”€è®°å½•ä¸­å†—ä½™å‘˜å·¥å§“å
- é¿å…æ¯æ¬¡éƒ½éœ€è¦å…³è”æŸ¥è¯¢

### 3. è½¯åˆ é™¤

æ‰€æœ‰é›†åˆä½¿ç”¨ `isDeleted` å­—æ®µè¿›è¡Œè½¯åˆ é™¤ï¼Œè€Œéç‰©ç†åˆ é™¤ã€‚

---

## ğŸ“Š æ•°æ®åº“æƒé™è®¾ç½®

åœ¨äº‘å¼€å‘æ§åˆ¶å°è®¾ç½®æ•°æ®åº“æƒé™ï¼š

```json
{
  "read": "auth",
  "write": "auth"
}
```

**æƒé™è¯´æ˜**:
- `true`: æ‰€æœ‰äººå¯è¯»å†™ï¼ˆä¸å®‰å…¨ï¼Œä»…æµ‹è¯•ç”¨ï¼‰
- `false`: æ‰€æœ‰äººä¸å¯è¯»å†™
- `auth`: ä»…ç™»å½•ç”¨æˆ·å¯è¯»å†™
- è‡ªå®šä¹‰æƒé™ï¼šä½¿ç”¨äº‘å‡½æ•°æ§åˆ¶

---

## ğŸ” å®‰å…¨è§„åˆ™

ä½¿ç”¨äº‘å‡½æ•°æ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œè€Œéç›´æ¥åœ¨å°ç¨‹åºç«¯æ“ä½œï¼Œç¡®ä¿ï¼š
1. æ•°æ®éªŒè¯
2. æƒé™æ§åˆ¶
3. ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§

---

**æ–‡æ¡£ç»“æŸ**

ä¸‹ä¸€æ­¥ï¼šåˆ›å»ºäº‘å‡½æ•°æ¥æ“ä½œè¿™äº›é›†åˆã€‚
