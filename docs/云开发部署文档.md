# 景区游船计时收费系统 - 云开发部署文档

| **文档版本** | **V2.0 (云开发版)**          |
| ------------ | ---------------------------- |
| **创建时间** | 2026-02-04                   |

---

## 📋 云开发简介

微信小程序云开发是微信官方提供的一体化后端云服务，包括：
- ☁️ **云函数**（Serverless函数）
- 🗄️ **云数据库**（MongoDB）
- 📦 **云存储**（文件存储）
- 🔐 **云调用**（服务端API）

**优势**：
- ✅ 无需购买服务器
- ✅ 无需运维管理
- ✅ 自动扩容
- ✅ 按量付费
- ✅ 与小程序深度集成

---

## 🚀 快速开始

### 第一步：开通云开发

1. **登录微信公众平台**
   - 访问: https://mp.weixin.qq.com/
   - 使用小程序管理员账号登录

2. **开通云开发**
   - 进入 **开发 -> 云开发**
   - 点击 **开通**
   - 选择 **基础版** 或 **专业版**（基础版免费，有配额限制）
   - 创建环境（环境ID会自动生成，如：`cloud1-xxx`）

3. **记录环境ID**
   - 记录您的云环境ID，后续配置需要用到

---

### 第二步：配置小程序

1. **修改小程序配置**

打开 `client-user/app.js`，修改环境ID：

```javascript
wx.cloud.init({
  env: 'your-env-id',  // 替换为您的云环境ID
  traceUser: true
})
```

同样修改员工端小程序 `client-staff/app.js`。

2. **配置project.config.json**

在小程序根目录添加/修改 `project.config.json`：

```json
{
  "cloudfunctionRoot": "cloudfunctions/",
  "setting": {
    "es6": true,
    "enhance": true
  }
}
```

---

### 第三步：初始化云数据库

1. **创建数据库集合**

在微信开发者工具中：
- 点击 **云开发控制台**
- 进入 **数据库**
- 点击 **添加集合**

依次创建以下集合：
- `users` - 用户集合
- `boatTypes` - 船型集合
- `pricingConfig` - 价格配置集合
- `boats` - 船只集合
- `orders` - 订单集合
- `staff` - 员工集合
- `verificationLogs` - 核销记录集合

2. **导入初始数据**

在云开发控制台 -> 数据库 -> 选择集合 -> 导入数据

**船型数据 (boatTypes.json)**:
```json
[
  {
    "typeCode": "powered",
    "typeName": "有动力船",
    "description": "配有电动马达，速度较快，适合远距离游玩",
    "maxCapacity": 4,
    "imageUrl": "",
    "sortOrder": 1,
    "isActive": true,
    "isDeleted": false,
    "createdAt": {"$date": "2026-02-04T00:00:00.000Z"},
    "updatedAt": {"$date": "2026-02-04T00:00:00.000Z"}
  },
  {
    "typeCode": "unpowered",
    "typeName": "无动力船",
    "description": "脚踏或手划，速度较慢，适合悠闲游湖",
    "maxCapacity": 2,
    "imageUrl": "",
    "sortOrder": 2,
    "isActive": true,
    "isDeleted": false,
    "createdAt": {"$date": "2026-02-04T00:00:00.000Z"},
    "updatedAt": {"$date": "2026-02-04T00:00:00.000Z"}
  }
]
```

**价格配置数据 (pricingConfig.json)** - 需要先获取船型的_id：
```json
[
  {
    "boatTypeId": "boat_type_id_here",
    "priceName": "有动力船-平日价",
    "basePrice": 50.00,
    "depositAmount": 100.00,
    "includedMinutes": 60,
    "overtimeRate": 1.00,
    "capAmount": 200.00,
    "effectiveDate": null,
    "expiryDate": null,
    "isDefault": true,
    "isActive": true,
    "isDeleted": false,
    "createdAt": {"$date": "2026-02-04T00:00:00.000Z"},
    "updatedAt": {"$date": "2026-02-04T00:00:00.000Z"}
  }
]
```

**船只数据 (boats.json)**:
```json
[
  {"boatNumber": "E-001", "boatTypeId": "boat_type_id_here", "status": "idle", "isActive": true, "isDeleted": false},
  {"boatNumber": "E-002", "boatTypeId": "boat_type_id_here", "status": "idle", "isActive": true, "isDeleted": false},
  {"boatNumber": "P-001", "boatTypeId": "boat_type_id_here", "status": "idle", "isActive": true, "isDeleted": false}
]
```

3. **设置数据库权限**

在云开发控制台 -> 数据库 -> 选择集合 -> 权限设置

建议设置为：
```json
{
  "read": "auth",
  "write": false
}
```

说明：
- 读权限设为 `auth`（仅登录用户可读）
- 写权限设为 `false`（仅云函数可写，保证数据安全）

---

### 第四步：部署云函数

1. **在微信开发者工具中打开项目**

2. **右键点击cloudfunctions目录**
   - 选择 **当前环境** -> 选择您的云环境

3. **逐个部署云函数**

右键点击每个云函数文件夹，选择 **上传并部署：云端安装依赖**：

- `getBoatTypes` - 获取船型列表
- `createOrder` - 创建订单
- `getOrderDetail` - 获取订单详情
- `getOrderList` - 获取订单列表
- `scanCode` - 扫码核销
- `startTrip` - 发船
- `endTrip` - 收船
- `findByBoatNumber` - 船号反查
- `getPendingOrders` - 待处理订单
- `login` - 员工登录

4. **验证云函数部署**

在云开发控制台 -> 云函数 中查看已部署的函数。

---

### 第五步：测试

1. **测试云数据库**

在云开发控制台 -> 数据库中查看数据。

2. **测试云函数**

在云开发控制台 -> 云函数 -> 选择函数 -> 测试：

```json
{
  "name": "getBoatTypes",
  "data": {}
}
```

点击 **测试** 按钮，查看返回结果。

3. **小程序端测试**

- 用户端：打开小程序，查看船型列表是否正常
- 员工端：测试扫码功能

---

## 📊 云开发配额

### 基础版（免费）配额

| 资源 | 免费配额 | 超出后计费 |
|------|---------|-----------|
| 云函数调用次数 | 10万次/月 | ¥0.0133/万次 |
| 云函数资源使用量 | 4万GBs/月 | ¥0.00011108/GBs |
| 云存储容量 | 5GB | ¥0.0043/GB/天 |
| 云存储下载流量 | 5GB/月 | ¥0.15/GB |
| 云数据库容量 | 2GB | ¥0.07/GB/天 |
| 云数据库读操作 | 5万次/天 | ¥0.015/万次 |
| 云数据库写操作 | 3万次/天 | ¥0.05/万次 |

**建议**：
- 初期使用免费配额足够
- 生产环境建议升级到专业版
- 定期查看用量，避免超额

---

## 🔧 常见问题

### 1. 云函数调用失败

**问题**: 小程序调用云函数时报错

**解决**:
- 检查云函数是否部署成功
- 检查环境ID配置是否正确
- 查看云函数日志（云开发控制台 -> 云函数 -> 日志）

### 2. 数据库权限错误

**问题**: `permission denied`

**解决**:
- 检查数据库权限设置
- 确认使用云函数操作数据库，而非小程序端直接操作

### 3. 云函数超时

**问题**: 云函数执行超过20秒

**解决**:
- 优化云函数代码，减少数据库查询次数
- 使用数据库索引
- 考虑异步处理耗时操作

### 4. 找不到集合

**问题**: `collection not exists`

**解决**:
- 检查集合名称拼写
- 确认集合已在云开发控制台创建

---

## 🔐 安全最佳实践

1. **数据库权限**
   - 不要将写权限设为 `true`
   - 所有写操作通过云函数执行

2. **云函数验证**
   - 在云函数中验证参数
   - 检查用户权限

3. **敏感数据**
   - 密码使用bcrypt加密
   - 不要在客户端存储敏感信息

---

## 📈 监控与运维

### 查看云函数日志

云开发控制台 -> 云函数 -> 选择函数 -> 日志

### 查看数据库统计

云开发控制台 -> 数据库 -> 统计

### 查看用量

云开发控制台 -> 设置 -> 用量统计

---

## 🔄 更新部署

### 更新云函数

1. 修改云函数代码
2. 右键点击云函数目录
3. 选择 **上传并部署：云端安装依赖**

### 更新数据库

直接在云开发控制台 -> 数据库中操作

---

## 💰 成本估算

### 小规模景区（日订单100单）

**月使用量**:
- 云函数调用: 约10万次（免费）
- 数据库读: 约50万次（超出15万次，约¥7.5）
- 数据库写: 约5万次（超出3万次，约¥1）
- 云存储: 1GB（免费）

**预估月成本**: ¥10-20

### 中规模景区（日订单500单）

**月使用量**:
- 云函数调用: 约50万次（超出40万次，约¥5.3）
- 数据库读: 约250万次（超出150万次，约¥30）
- 数据库写: 约25万次（超出21万次，约¥10.5）

**预估月成本**: ¥50-100

**建议**: 升级到专业版，固定费用¥390/月

---

## ✅ 部署检查清单

- [ ] 开通云开发环境
- [ ] 记录环境ID
- [ ] 修改小程序app.js中的环境ID
- [ ] 创建所有数据库集合
- [ ] 导入初始数据
- [ ] 设置数据库权限
- [ ] 部署所有云函数
- [ ] 测试云函数调用
- [ ] 小程序端测试
- [ ] 查看云开发用量统计

---

**部署完成后，您的小程序即可使用云开发服务！** 🎉

无需购买服务器，一键部署，立即使用！
