# 景区游船系统测试流程

## 前置准备

### 1. 导入测试数据
按照 `导入说明.md` 的步骤，将以下数据导入到云数据库：
- ✅ boatTypes（船型）
- ✅ pricingConfigs（计费配置）
- ✅ boats（船只）
- ✅ staff（员工）

### 2. 检查云函数部署
确认以下云函数已成功部署：
- ✅ getBoatTypes
- ✅ createOrder
- ✅ getOrderDetail
- ✅ scanCode
- ✅ startTrip
- ✅ endTrip
- ✅ staffLogin
- ✅ findByBoatNumber
- ✅ getPendingOrders

## 测试场景一：完整的租船流程（正常流程）

### 用户端操作

#### 1. 选择船型并创建订单
1. 打开**用户端小程序**（client-user）
2. 首页应该显示 3 种船型：双人船、四人船、六人船
3. 点击"双人船"
4. 查看船型详情：
   - 基础费用：50元/小时
   - 押金：100元
   - 超时费率：1元/分钟
5. 点击"立即租船"
6. 系统创建订单，状态为 `pending`（待支付）

#### 2. 支付订单（模拟）
1. 在订单详情页，点击"支付押金"
2. **注意**：支付是模拟的，实际会调用微信支付
3. 支付成功后，订单状态变为 `paid`（已支付）
4. 显示核销码（6位数字）

#### 3. 到码头取船
1. 用户到达码头，出示核销码给员工
2. 员工使用员工端扫码或输入核销码

### 员工端操作

#### 4. 员工登录
1. 打开**员工端小程序**（client-staff）
2. 输入工号：`STAFF001`
3. 输入密码：`123456`
4. 点击"登录"

#### 5. 扫描核销码（开始计时）
1. 点击"扫码核销"
2. **模拟扫描**：手动输入用户的核销码
3. 系统显示订单信息：
   - 船型：双人船
   - 用户昵称
   - 应付金额：100元（押金）
4. 选择船只：选择 `A001`
5. 点击"开始计时"
6. 订单状态变为 `timing`（计时中）
7. 船只 A001 状态变为 `in_use`（使用中）

#### 6. 用户游玩...

等待几分钟（或在数据库手动修改开始时间，模拟已使用1小时）

#### 7. 扫描核销码（结束计时）
1. 用户归还船只
2. 员工再次扫描核销码（或输入）
3. 系统显示：
   - 开始时间：2024-01-16 10:00:00
   - 当前时间：2024-01-16 11:05:00
   - 已使用：65分钟
   - 超时：5分钟
   - 超时费用：5元
   - 应退押金：95元
4. 点击"确认结束"
5. 订单状态变为 `ended`（已结束）
6. 船只 A001 状态变为 `idle`（空闲）

#### 8. 退款（模拟）
1. 系统自动触发退款流程
2. 退款金额：95元
3. 订单状态变为 `completed`（已完成）

---

## 测试场景二：超时费用计算

### 测试目的
验证超时费用计算是否正确

### 测试步骤
1. 创建双人船订单（包含60分钟，超时1元/分钟）
2. 开始计时
3. **在云数据库中手动修改开始时间**：
   ```
   timing.startTime: 2024-01-16T02:00:00.000Z  // 2小时前
   ```
4. 员工端扫码结束计时
5. 验证计算结果：
   - 使用时长：120分钟
   - 超时：60分钟
   - 超时费用：60元
   - 应退押金：40元（100 - 60）

---

## 测试场景三：船号反查

### 测试目的
当用户手机没电时，通过船号查找订单

### 测试步骤
1. 创建订单并开始计时（绑定船只 A001）
2. 员工端点击"船号查询"
3. 输入船号：`A001`
4. 系统显示该船当前的订单信息
5. 可以直接结束计时

---

## 测试场景四：待处理订单列表

### 测试目的
查看所有正在计时的订单

### 测试步骤
1. 创建3个订单并开始计时（使用不同船只）
2. 员工端点击"待处理订单"
3. 显示列表，包含：
   - 船号
   - 船型
   - 用户昵称
   - 开始时间
   - 已使用时长
   - 是否超时
4. 点击任意订单，可以查看详情并结束计时

---

## 测试场景五：数据库权限测试

### 测试目的
验证用户只能看到自己的订单

### 测试步骤
1. 使用用户A创建订单
2. 切换到用户B的账号
3. 用户B应该看不到用户A的订单

---

## 常见问题排查

### 1. 首页不显示船型
- 检查 boatTypes 数据是否导入
- 检查 getBoatTypes 云函数是否部署
- 查看云函数日志（云开发控制台 → 云函数 → 日志）

### 2. 创建订单失败
- 检查 pricingConfigs 数据是否导入
- 检查 createOrder 云函数是否部署
- 查看云函数日志

### 3. 扫码后无响应
- 检查核销码是否正确
- 检查 scanCode 云函数是否部署
- 查看云函数日志

### 4. 开始计时失败
- 检查 boats 数据是否导入
- 检查船只是否已被占用
- 检查 startTrip 云函数是否部署

### 5. 员工登录失败
- 检查 staff 数据是否导入
- 检查工号和密码是否正确
- 查看 staffLogin 云函数日志

---

## 性能测试建议

1. **并发测试**：多个用户同时创建订单
2. **长时间运行**：订单计时超过24小时
3. **大数据量**：创建100+订单后查询性能
4. **网络异常**：弱网环境下的表现

---

## 测试完成检查清单

- [ ] 用户可以正常浏览船型
- [ ] 用户可以创建订单并支付
- [ ] 员工可以登录
- [ ] 员工可以扫码开始计时
- [ ] 计时功能正常工作
- [ ] 员工可以扫码结束计时
- [ ] 超时费用计算正确
- [ ] 船号反查功能正常
- [ ] 待处理订单列表显示正常
- [ ] 退款流程正常
- [ ] 数据库权限设置正确
- [ ] 云函数日志无报错

---

## 下一步优化建议

测试通过后，可以考虑以下优化：

1. **员工密码加密**：使用 bcryptjs 加密存储
2. **支付集成**：接入微信支付
3. **消息推送**：超时提醒、退款通知
4. **数据统计**：营收报表、使用率分析
5. **图片上传**：船型图片、用户头像
6. **管理后台**：Web端管理系统
7. **小票打印**：蓝牙打印机对接
