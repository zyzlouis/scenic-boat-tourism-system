<!--pages/order-detail/order-detail.wxml-->
<wxs module="filters" src="../../utils/filters.wxs"></wxs>
<view class="container">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-container">
    <van-loading size="48rpx" type="spinner" color="#1989fa">åŠ è½½ä¸­...</van-loading>
  </view>

  <!-- è®¢å•è¯¦æƒ… -->
  <view wx:else class="order-detail">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-card card">
      <view
        class="status-tag"
        style="background-color: {{filters.getOrderStatusColor(order.status)}}"
      >
        {{filters.getOrderStatusText(order.status)}}
      </view>
      <view class="status-desc">
        <text wx:if="{{order.status === 'pending'}}">è¯·å°½å¿«å®Œæˆæ”¯ä»˜</text>
        <text wx:if="{{order.status === 'paid'}}">è¯·åˆ°ç å¤´å‡ºç¤ºæ ¸é”€ç </text>
        <text wx:if="{{order.status === 'timing'}}">æ¸¸ç©æ„‰å¿«ï¼Œæ³¨æ„æ—¶é—´å“¦</text>
        <text wx:if="{{order.status === 'completed'}}">æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨</text>
        <text wx:if="{{order.status === 'cancelled'}}">è®¢å•å·²å–æ¶ˆ</text>
      </view>
    </view>

    <!-- æ ¸é”€ç ï¼ˆå·²æ”¯ä»˜æ‰æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{order.status !== 'pending' && order.verificationCode}}" class="qrcode-card card">
      <view class="qrcode-title">è¯·åˆ°ç å¤´å‡ºç¤ºæ ¸é”€ç </view>

      <!-- äºŒç»´ç  -->
      <view class="qrcode-wrapper">
        <image
          src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={{order.verificationCode}}"
          class="qrcode-image"
          mode="widthFix"
        ></image>
      </view>

      <!-- æ ¸é”€ç æ–‡å­— -->
      <view class="qrcode-section">
        <view class="qrcode-label">æ ¸é”€ç </view>
        <view class="qrcode-code">{{order.verificationCode}}</view>
        <view class="qrcode-tip">è¯·å°†æ­¤ç å‡ºç¤ºç»™å·¥ä½œäººå‘˜æ‰«æ</view>
      </view>
    </view>

    <!-- è®¡æ—¶çœ‹æ¿ï¼ˆè®¡æ—¶ä¸­æ‰æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{order.status === 'timing'}}" class="timing-board card">
      <view class="timing-title">ğŸ• è®¡æ—¶çœ‹æ¿</view>
      <view class="timing-info">
        <view class="timing-row">
          <text class="label">å¼€å§‹æ—¶é—´ï¼š</text>
          <text class="value">{{filters.formatTime(order.startTime)}}</text>
        </view>
        <view class="timing-row highlight">
          <text class="label">å·²ç”¨æ—¶é•¿ï¼š</text>
          <text class="value">{{filters.formatDuration(order.usedMinutes)}}</text>
        </view>
        <view class="timing-row">
          <text class="label">åŒ…å«æ—¶é•¿ï¼š</text>
          <text class="value">{{filters.formatDuration(order.includedMinutes)}}</text>
        </view>
        <view wx:if="{{order.overtimeMinutes > 0}}" class="timing-row warning">
          <text class="label">å·²è¶…æ—¶ï¼š</text>
          <text class="value">{{filters.formatDuration(order.overtimeMinutes)}}</text>
        </view>
        <view wx:if="{{order.overtimeFee > 0}}" class="timing-row warning">
          <text class="label">è¶…æ—¶è´¹ç”¨ï¼š</text>
          <text class="value price">Â¥{{filters.formatMoney(order.overtimeFee)}}</text>
        </view>
        <view class="timing-row total">
          <text class="label">é¢„è®¡æ€»è´¹ç”¨ï¼š</text>
          <text class="value price">Â¥{{filters.formatMoney(order.estimatedTotalFee)}}</text>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="order-info card">
      <view class="info-title">è®¢å•ä¿¡æ¯</view>
      <van-cell-group>
        <van-cell title="è®¢å•å·" value="{{order.orderNo}}" />
        <van-cell title="èˆ¹å‹" value="{{order.boatTypeName}}" />
        <van-cell wx:if="{{order.boatNumber}}" title="èˆ¹å·" value="{{order.boatNumber}}" />
        <van-cell title="åŸºç¡€ç¥¨ä»·" value="Â¥{{filters.formatMoney(order.basePrice)}}" />
        <van-cell title="æŠ¼é‡‘" value="Â¥{{filters.formatMoney(order.depositAmount)}}" />
        <van-cell
          title="è®¢å•æ€»é¢"
          value="Â¥{{filters.formatMoney(order.totalAmount)}}"
          value-class="price"
        />
        <van-cell title="åˆ›å»ºæ—¶é—´" value="{{filters.formatTime(order.createdAt)}}" />
        <van-cell
          wx:if="{{order.completedAt}}"
          title="å®Œæˆæ—¶é—´"
          value="{{filters.formatTime(order.completedAt)}}"
        />
      </van-cell-group>
    </view>

    <!-- ç»“ç®—ä¿¡æ¯ï¼ˆå·²å®Œæˆè®¢å•æ‰æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{order.status === 'completed'}}" class="settlement-info card">
      <view class="info-title">ç»“ç®—ä¿¡æ¯</view>
      <van-cell-group>
        <van-cell title="ä½¿ç”¨æ—¶é•¿" value="{{filters.formatDuration(order.usedMinutes)}}" />
        <van-cell
          wx:if="{{order.overtimeMinutes > 0}}"
          title="è¶…æ—¶æ—¶é•¿"
          value="{{filters.formatDuration(order.overtimeMinutes)}}"
        />
        <van-cell
          wx:if="{{order.overtimeFee > 0}}"
          title="è¶…æ—¶è´¹ç”¨"
          value="Â¥{{filters.formatMoney(order.overtimeFee)}}"
        />
        <van-cell
          title="é€€æ¬¾é‡‘é¢"
          value="Â¥{{filters.formatMoney(order.refundAmount)}}"
          value-class="price"
        />
        <van-cell
          title="æœ€ç»ˆè´¹ç”¨"
          value="Â¥{{filters.formatMoney(order.finalAmount)}}"
          value-class="price"
        />
      </van-cell-group>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-bar">
      <van-button
        wx:if="{{order.status === 'pending'}}"
        type="default"
        size="large"
        round
        bindtap="cancelOrder"
        custom-class="cancel-btn"
      >
        å–æ¶ˆè®¢å•
      </van-button>
      <van-button
        wx:if="{{order.status === 'pending'}}"
        type="primary"
        size="large"
        round
        bindtap="gotoPayment"
        custom-class="pay-btn"
      >
        å»æ”¯ä»˜
      </van-button>
    </view>
  </view>
</view>
